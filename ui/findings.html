<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Findings - Research Engine</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

  :root {
    --bg: #050507;
    --glass: rgba(255,255,255,0.04);
    --glass-border: rgba(255,255,255,0.06);
    --glass-hover: rgba(255,255,255,0.055);
    --glass-border-hover: rgba(255,255,255,0.12);
    --text: #f0f0f5;
    --text-secondary: #8b8b9e;
    --dim: #55556a;
    --accent: #a78bfa;
    --accent-glow: rgba(167,139,250,0.15);
    --green: #34d399;
    --green-dim: rgba(52,211,153,0.1);
    --red: #f87171;
    --red-dim: rgba(248,113,113,0.08);
    --amber: #fbbf24;
    --amber-dim: rgba(251,191,36,0.08);
    --blue: #60a5fa;
    --cyan: #22d3ee;
    --orange: #fb923c;
    --gradient-accent: linear-gradient(135deg, #a78bfa, #818cf8, #60a5fa);
    --gradient-1: linear-gradient(135deg, rgba(167,139,250,0.12) 0%, rgba(96,165,250,0.08) 50%, rgba(52,211,153,0.06) 100%);
    --radius: 16px;
    --radius-sm: 10px;
    --blur: 20px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--bg); color: var(--text);
    font-size: 14px; line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    min-height: 100dvh; overflow-x: hidden;
  }
  body::before {
    content: ''; position: fixed; top: -40%; left: -20%; width: 80%; height: 80%;
    background: radial-gradient(ellipse, rgba(167,139,250,0.04) 0%, transparent 60%);
    pointer-events: none; z-index: 0;
  }
  .container {
    max-width: 960px; margin: 0 auto; padding: 24px 16px;
    padding-top: max(24px, env(safe-area-inset-top));
    position: relative; z-index: 1;
  }

  /* Nav */
  nav {
    display: flex; gap: 2px; margin-bottom: 28px;
    background: var(--glass); backdrop-filter: blur(var(--blur));
    -webkit-backdrop-filter: blur(var(--blur));
    border: 1px solid var(--glass-border); border-radius: 12px;
    padding: 3px; width: 100%; overflow-x: auto;
  }
  nav a {
    flex: 1; color: var(--dim); text-decoration: none; font-size: 13px;
    font-weight: 500; padding: 8px 12px; border-radius: 9px;
    transition: all 0.2s; text-align: center; white-space: nowrap;
  }
  nav a:hover { color: var(--text-secondary); }
  nav a.active { background: rgba(255,255,255,0.06); color: var(--text); }

  /* Glass base */
  .glass {
    background: var(--glass); backdrop-filter: blur(var(--blur));
    -webkit-backdrop-filter: blur(var(--blur));
    border: 1px solid var(--glass-border); border-radius: var(--radius);
    transition: border-color 0.2s, background 0.2s;
  }
  .glass:hover { border-color: var(--glass-border-hover); background: var(--glass-hover); }

  header { margin-bottom: 24px; }
  h1 {
    font-size: 22px; font-weight: 700; letter-spacing: -0.5px; margin-bottom: 2px;
    background: var(--gradient-accent);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
  }
  .subtitle { color: var(--dim); font-size: 13px; }
  .page-intro { color: var(--text-secondary); font-size: 12px; line-height: 1.7; margin-bottom: 20px; max-width: 700px; }

  /* Stats */
  .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 12px; }
  .stat-card { padding: 16px; text-align: center; }
  .stat-label { font-size: 10px; color: var(--dim); text-transform: uppercase; letter-spacing: 1px; font-weight: 600; margin-bottom: 4px; }
  .stat-value { font-size: 24px; font-weight: 800; font-variant-numeric: tabular-nums; letter-spacing: -1px; }

  /* Synthesis */
  .synthesis {
    padding: 24px; background: var(--gradient-1);
    border-color: rgba(167,139,250,0.1); margin-bottom: 12px;
  }
  .synthesis-label { font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--accent); font-weight: 700; margin-bottom: 8px; }
  .synthesis-text { color: var(--text-secondary); font-size: 13px; line-height: 1.8; }

  /* Legend */
  .legend {
    display: flex; flex-wrap: wrap; gap: 8px 16px;
    padding: 12px 16px; margin-bottom: 12px; font-size: 10px; color: var(--dim);
  }
  .legend-dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; margin-right: 4px; vertical-align: middle; }

  .section-label { font-size: 10px; text-transform: uppercase; letter-spacing: 1.2px; color: var(--dim); font-weight: 600; margin-bottom: 10px; }
  .section-hint { font-weight: 400; letter-spacing: 0; text-transform: none; margin-left: 6px; font-size: 10px; }

  /* Opportunity cards */
  .opp-card {
    padding: 18px 20px; margin-bottom: 10px;
    position: relative; overflow: hidden;
  }
  .opp-card::before {
    content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px; border-radius: 3px;
  }
  .opp-card.t1::before { background: var(--green); }
  .opp-card.t2::before { background: var(--amber); }
  .opp-card.t3::before { background: var(--accent); }
  .opp-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; gap: 12px; }
  .opp-name { font-weight: 600; font-size: 14px; flex: 1; }
  .opp-badges { display: flex; gap: 6px; align-items: center; flex-shrink: 0; }
  .score-badge {
    font-weight: 800; font-size: 13px; padding: 2px 10px;
    border-radius: 8px; letter-spacing: -0.5px;
  }
  .sb-t1 { background: var(--green-dim); color: var(--green); }
  .sb-t2 { background: var(--amber-dim); color: var(--amber); }
  .sb-t3 { background: rgba(167,139,250,0.1); color: var(--accent); }
  .tier-pill {
    font-size: 10px; font-weight: 600; padding: 2px 8px; border-radius: 6px;
  }
  .tp-1 { background: var(--green-dim); color: var(--green); }
  .tp-2 { background: var(--amber-dim); color: var(--amber); }
  .tp-3 { background: rgba(167,139,250,0.1); color: var(--accent); }

  .thesis-text { color: var(--text-secondary); font-size: 12px; line-height: 1.7; margin-bottom: 10px; }
  .data-points { list-style: none; margin-bottom: 10px; }
  .data-points li { padding: 2px 0 2px 14px; position: relative; font-size: 11px; color: var(--dim); }
  .data-points li::before { content: '\2022'; position: absolute; left: 0; color: var(--accent); }

  .opp-footer {
    display: flex; gap: 10px; align-items: center; font-size: 11px; color: var(--dim);
    border-top: 1px solid rgba(255,255,255,0.04); padding-top: 8px; margin-top: 8px;
  }
  .counter-note { font-size: 11px; color: var(--orange); margin-top: 6px; }

  /* Patterns */
  .pattern-card { padding: 14px 18px; margin-bottom: 8px; }
  .pattern-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
  .pattern-name { font-weight: 600; font-size: 12px; }
  .strength-bar { width: 70px; height: 4px; background: rgba(255,255,255,0.06); border-radius: 3px; overflow: hidden; }
  .strength-fill { height: 100%; border-radius: 3px; }
  .s-high { background: var(--green); }
  .s-med { background: var(--amber); }
  .s-low { background: var(--red); }
  .pattern-evidence { font-size: 11px; color: var(--dim); line-height: 1.6; }
  .pattern-status { font-size: 10px; color: var(--dim); margin-top: 4px; }

  /* Barriers */
  .barrier-item {
    padding: 10px 14px; margin-bottom: 6px;
    border-left: 3px solid var(--red); border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
  }
  .barrier-item.moat { border-left-color: var(--amber); }
  .barrier-target { font-weight: 600; font-size: 12px; margin-bottom: 2px; }
  .barrier-reason { color: var(--red); font-size: 11px; }
  .moat-tag { font-size: 9px; color: var(--green); font-weight: 700; margin-left: 6px; }
  .barrier-cycle { font-size: 10px; color: var(--dim); margin-top: 2px; }

  /* Grid */
  .bento { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 12px; }
  .bento-wide { grid-column: 1 / -1; }
  .bento-item { padding: 20px; }

  /* Sector grid */
  .sector-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 8px; }
  .sector-cell {
    padding: 10px; border-radius: var(--radius-sm); text-align: center;
    border: 1px solid var(--glass-border);
  }
  .sector-name { font-size: 10px; font-weight: 600; color: var(--text-secondary); margin-bottom: 2px; }
  .sector-count { font-size: 18px; font-weight: 800; font-variant-numeric: tabular-nums; }
  .sector-meta { font-size: 10px; color: var(--dim); }

  /* Weight bars */
  .weight-row { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; }
  .weight-label { min-width: 140px; font-size: 11px; color: var(--dim); text-align: right; }
  .weight-bar-bg { flex: 1; height: 14px; background: rgba(255,255,255,0.04); border-radius: 4px; overflow: hidden; }
  .weight-bar-fill { height: 100%; background: var(--accent); border-radius: 4px; }
  .weight-val { min-width: 32px; font-size: 11px; font-weight: 700; font-variant-numeric: tabular-nums; }

  .empty { text-align: center; padding: 32px 16px; color: var(--dim); font-size: 12px; }

  @media (max-width: 640px) {
    .container { padding: 16px 12px; }
    .stat-grid { grid-template-columns: repeat(2, 1fr); }
    .bento { grid-template-columns: 1fr; }
    .bento-item { padding: 16px; }
    .opp-header { flex-direction: column; gap: 6px; }
    .opp-badges { align-self: flex-start; }
    .sector-grid { grid-template-columns: repeat(2, 1fr); }
  }
</style>
</head>
<body>
<div class="container">
  <nav>
    <a href="index.html">Dashboard</a>
    <a href="ops.html">Operations</a>
    <a href="findings.html" class="active">Findings</a>
    <a href="methods.html">Methods</a>
  </nav>

  <header>
    <h1>Findings</h1>
    <div class="subtitle" id="last-updated">--</div>
  </header>

  <p class="page-intro">
    Deep analysis of every opportunity the engine has constructed. Each business model is scored by economic force,
    structural advantage, and timing readiness. Barriers are not rejections &mdash; high-barrier sectors may be the strongest opportunities.
  </p>

  <div class="glass legend">
    <span><span class="legend-dot" style="background:var(--green)"></span>Tier 1 &mdash; high conviction</span>
    <span><span class="legend-dot" style="background:var(--amber)"></span>Tier 2 &mdash; needs validation</span>
    <span><span class="legend-dot" style="background:var(--accent)"></span>Tier 3 &mdash; monitoring</span>
    <span style="margin-left:auto;opacity:0.6">Score = economic force (0&ndash;100)</span>
  </div>

  <div class="stat-grid">
    <div class="glass stat-card"><div class="stat-label">Cycle</div><div class="stat-value" id="exec-cycle" style="color:var(--accent)">0</div></div>
    <div class="glass stat-card"><div class="stat-label">Signals</div><div class="stat-value" id="exec-signals">0</div></div>
    <div class="glass stat-card"><div class="stat-label">Models</div><div class="stat-value" id="exec-active" style="color:var(--green)">0</div></div>
    <div class="glass stat-card"><div class="stat-label">Barriers</div><div class="stat-value" id="exec-kills" style="color:var(--amber)">0</div></div>
  </div>

  <div class="glass synthesis">
    <div class="synthesis-label">Master Synthesis</div>
    <div class="synthesis-text" id="exec-synthesis">No synthesis available yet. Run a research cycle to generate findings.</div>
  </div>

  <div class="section-label" style="margin-top:16px;">Active Opportunities <span class="section-hint">business models ranked by tier and economic force</span></div>
  <div id="active-opportunities"><div class="empty">No active opportunities yet</div></div>

  <div class="bento" style="margin-top:16px;">
    <div class="glass bento-item">
      <div class="section-label">Structural Patterns <span class="section-hint">cross-signal themes</span></div>
      <div id="confirmed-patterns"><div class="empty">No patterns detected</div></div>
    </div>
    <div class="glass bento-item">
      <div class="section-label">Barrier Index <span class="section-hint">some indicate moat potential</span></div>
      <div id="kill-index"><div class="empty">No barriers recorded</div></div>
    </div>
  </div>

  <div class="bento">
    <div class="glass bento-item">
      <div class="section-label">Sector Coverage</div>
      <div id="sector-coverage"><div class="empty">No sector data</div></div>
    </div>
    <div class="glass bento-item">
      <div class="section-label">Grading Weights</div>
      <div id="grading-weights"><div class="empty">No weights configured</div></div>
    </div>
  </div>
</div>

<script>
const DATA_URL = '../data/ui/dashboard.json';
function esc(s){if(!s)return'';const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function truncate(t,n){if(!t)return'';const m=t.match(/[^.!?]+[.!?]+/g);return m?m.slice(0,n).join(' ').trim():t}

function strengthInfo(s){
  const l=typeof s==='string'?s.toLowerCase().replace(/_/g,'-'):'';
  if(l.includes('very')||l==='high'||l==='strong')return{cls:'s-high',pct:95};
  if(l.includes('moderate')||l==='medium')return{cls:'s-med',pct:60};
  return{cls:'s-low',pct:30};
}

function renderExec(d){
  document.getElementById('exec-cycle').textContent=d.cycle||d.current_cycle||0;
  const landscape=d.opportunity_landscape||d.landscape||{};
  const decomposed=landscape.decomposed_models_top_20||[];
  let oppCount=0;
  if(decomposed.length){oppCount=decomposed.length;}
  else{const t1=landscape.tier_1||[];const t2=landscape.tier_2||[];const t3=landscape.tier_3||[];oppCount=[...t1,...t2,...t3].length||(d.top_opportunities||[]).length;}
  const stats=d.pipeline_stats||{};
  const notRec=landscape.not_recommended||[];
  const bc=notRec.length||(function(){const bi=d.barrier_index||d.kill_index;const biS=d.barrier_index_summary;return biS?(biS.total||0):bi?(Array.isArray(bi)?bi.length:(bi.barriers||bi.entries||[]).length||bi.total_barriers||0):0;})();
  document.getElementById('exec-signals').textContent=d.signals_scanned||d.total_signals_scanned||stats.total_ever_evaluated||(d.cycle_history||[]).reduce((s,c)=>s+(c.signals||0),0)||0;
  document.getElementById('exec-active').textContent=d.models_constructed||d.total_models_constructed||stats.models_constructed||oppCount;
  document.getElementById('exec-kills').textContent=bc;
  const syn=d.summary||d.master_synthesis||d.engine_status||'';
  document.getElementById('exec-synthesis').textContent=syn?truncate(syn,3):'No synthesis available yet.';
}

function renderActive(opps){
  const el=document.getElementById('active-opportunities');
  if(!opps||!opps.length){el.innerHTML='<div class="empty">No active opportunities yet</div>';return}
  const active=opps.filter(o=>{const s=(o.status||'').toLowerCase();return s!=='killed'&&s!=='parked'});
  if(!active.length){el.innerHTML='<div class="empty">No active opportunities</div>';return}
  el.innerHTML=active.map(o=>{
    const tier=(o.tier||'').toLowerCase();
    const tn=tier.includes('1')?1:tier.includes('2')?2:3;
    const dp=o.key_data_points||o.data_points||o.key_strengths||[];
    const dpH=dp.length?'<ul class="data-points">'+dp.map(d=>'<li>'+esc(typeof d==='string'?d:d.point||d.description||JSON.stringify(d))+'</li>').join('')+'</ul>':'';
    const cs=o.counter_signal_status||o.counter_signals||'';
    const csH=cs?'<div class="counter-note">Counter: '+esc(typeof cs==='string'?cs:JSON.stringify(cs))+'</div>':'';
    return`<div class="glass opp-card t${tn}">
      <div class="opp-header">
        <div class="opp-name">${esc(o.name)}</div>
        <div class="opp-badges">
          <span class="tier-pill tp-${tn}">${esc(o.tier||'')}</span>
          <span class="score-badge sb-t${tn}">${o.score||o.opportunity_score||'--'}</span>
        </div>
      </div>
      <div class="thesis-text">${esc(o.thesis||o.key_signals||o.note||o.cycle_3_change||o.cycle_4_change||'')}</div>
      ${dpH}
      <div class="opp-footer">
        <span>${esc(o.economic_force||'')}</span>
        <span>${esc(o.type||o.landscape_type||'')}</span>
      </div>
      ${csH}
    </div>`;
  }).join('');
}

function renderPatterns(patterns){
  const el=document.getElementById('confirmed-patterns');
  if(!patterns||!patterns.length){el.innerHTML='<div class="empty">No patterns detected</div>';return}
  el.innerHTML=patterns.map(p=>{
    const si=strengthInfo(p.strength);
    return`<div class="glass pattern-card">
      <div class="pattern-header">
        <span class="pattern-name">${esc(p.name||p.pattern||p.shift||'Unnamed')}</span>
        <div class="strength-bar"><div class="strength-fill ${si.cls}" style="width:${si.pct}%"></div></div>
      </div>
      <div class="pattern-evidence">${esc(p.evidence||p.description||'')}</div>
      <div class="pattern-status">${esc(p.status||'')}</div>
    </div>`;
  }).join('');
}

function renderKills(barriers){
  const el=document.getElementById('kill-index');
  if(!barriers||!barriers.length){el.innerHTML='<div class="empty">No barriers recorded</div>';return}
  el.innerHTML=barriers.map(b=>{
    const moat=b.moat_potential;
    return`<div class="glass barrier-item${moat?' moat':''}">
      <div class="barrier-target">${esc(b.target||b.name||b.barrier||b.sector||'Unknown')}${moat?'<span class="moat-tag">MOAT</span>':''}</div>
      <div class="barrier-reason">${esc(b.reason||b.rationale||b.description||b.status||'')}</div>
    </div>`}).join('');
}

function renderSectors(heatmap){
  const el=document.getElementById('sector-coverage');
  if(!heatmap||!Object.keys(heatmap).length){el.innerHTML='<div class="empty">No sector data</div>';return}
  el.innerHTML='<div class="sector-grid">'+Object.entries(heatmap).map(([name,data])=>{
    return`<div class="sector-cell" style="background:rgba(167,139,250,0.04)">
      <div class="sector-name">${esc(name)}</div>
      <div class="sector-count" style="color:var(--accent)">${data.signal_count||0}</div>
      <div class="sector-meta">avg ${data.avg_score!=null?data.avg_score.toFixed(1):'--'}</div>
    </div>`;
  }).join('')+'</div>';
}

function renderWeights(weights){
  const el=document.getElementById('grading-weights');
  if(!weights||!Object.keys(weights).length){el.innerHTML='<div class="empty">No weights configured</div>';return}
  const mx=Math.max(...Object.values(weights).map(v=>typeof v==='number'?v:0),1);
  el.innerHTML=Object.entries(weights).map(([name,value])=>{
    const n=typeof value==='number'?value:parseFloat(value)||0;
    return`<div class="weight-row">
      <div class="weight-label">${esc(name)}</div>
      <div class="weight-bar-bg"><div class="weight-bar-fill" style="width:${(n/mx)*100}%"></div></div>
      <div class="weight-val">${n.toFixed(2)}</div>
    </div>`;
  }).join('');
}

async function refresh(){
  document.getElementById('last-updated').textContent=new Date().toLocaleString();
  try{
    const r=await fetch(DATA_URL+'?t='+Date.now());
    if(!r.ok)return;
    const d=await r.json();
    renderExec(d);
    const landscape=d.opportunity_landscape||d.landscape||{};
    const decomposed=landscape.decomposed_models_top_20||[];
    let opps=[];
    if(decomposed.length){
      opps=decomposed.map(m=>{
        const tier=m.score>=75?'Tier 1':m.score>=68?'Tier 2':'Tier 3';
        return Object.assign({tier,name:m.name,score:m.score,thesis:m.one_liner,economic_force:m.sector,type:m.type,
          key_data_points:[m.entry_wedge?'Entry: '+m.entry_wedge:null,m.key_competitor?'Competition: '+m.key_competitor:null,m.why_now?'Why now: '+m.why_now:null].filter(Boolean)},m);
      });
    }else{
      const t1=(landscape.tier_1||[]).map(o=>Object.assign({tier:'Tier 1',name:o.name||o.structural_shift},o));
      const t2=(landscape.tier_2||[]).map(o=>Object.assign({tier:'Tier 2',name:o.name||o.structural_shift},o));
      const t3=(landscape.tier_3||[]).map(o=>Object.assign({tier:'Tier 3',name:o.name||o.structural_shift},o));
      opps=[...t1,...t2,...t3].length?[...t1,...t2,...t3]:(d.top_opportunities||[]);
    }
    renderActive(opps);
    renderPatterns(d.key_patterns||d.structural_patterns||d.structural_shifts_active||d.cross_principle_patterns);
    const notRec=landscape.not_recommended||[];
    const bi=d.barrier_index||d.kill_index;
    let barriers=bi?(Array.isArray(bi)?bi:(bi.barriers||bi.entries||[])):[];
    if(!barriers.length&&notRec.length){
      barriers=notRec.map(b=>({target:b.name,reason:b.reason,score:b.score}));
    }
    if(!barriers.length&&landscape.barriers_noted){
      barriers=landscape.barriers_noted.map(b=>({target:b.barrier,reason:b.sectors?b.sectors.join(', '):'',moat_potential:b.moat_potential,status:b.status}));
    }
    renderKills(barriers);
    // Sector coverage: use sector_heatmap or build from structural_shifts_active
    let heatmap=d.sector_heatmap;
    if(!heatmap&&d.structural_shifts_active){
      heatmap={};
      d.structural_shifts_active.forEach(s=>{
        const name=(s.shift||'').replace(/\s*\(.*?\)\s*/g,'').substring(0,24);
        heatmap[name]={signal_count:s.signal_count||0,avg_score:null};
      });
    }
    renderSectors(heatmap);
    renderWeights(d.grading_weights_current||d.grading_weights);
  }catch{}
}
refresh();
setInterval(refresh,30000);
</script>
</body>
</html>
