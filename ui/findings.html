<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Findings - Research Engine</title>
<style>
  :root {
    --bg: #09090b;
    --surface: #18181b;
    --surface-2: #1f1f23;
    --border: #27272a;
    --border-subtle: #1e1e21;
    --text: #fafafa;
    --text-secondary: #a1a1aa;
    --dim: #71717a;
    --accent: #a78bfa;
    --accent-dim: rgba(167,139,250,0.12);
    --green: #4ade80;
    --green-dim: rgba(74,222,128,0.12);
    --red: #f87171;
    --red-dim: rgba(248,113,113,0.12);
    --amber: #fbbf24;
    --amber-dim: rgba(251,191,36,0.12);
    --blue: #60a5fa;
    --blue-dim: rgba(96,165,250,0.12);
    --cyan: #22d3ee;
    --cyan-dim: rgba(34,211,238,0.12);
    --orange: #fb923c;
    --orange-dim: rgba(251,146,60,0.12);
    --radius: 10px;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', sans-serif;
    background: var(--bg);
    color: var(--text);
    font-size: 14px;
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
  }
  .container { max-width: 1280px; margin: 0 auto; padding: 32px 24px; }

  nav {
    display: flex; gap: 2px; margin-bottom: 32px;
    background: var(--surface); border-radius: 8px; padding: 3px; width: fit-content;
  }
  nav a {
    color: var(--dim); text-decoration: none; font-size: 13px; font-weight: 500;
    padding: 6px 16px; border-radius: 6px; transition: all 0.15s;
  }
  nav a:hover { color: var(--text-secondary); }
  nav a.active { background: var(--surface-2); color: var(--text); }

  header { margin-bottom: 32px; display: flex; justify-content: space-between; align-items: flex-end; }
  h1 { font-size: 24px; font-weight: 600; letter-spacing: -0.5px; }
  .header-meta { color: var(--dim); font-size: 13px; text-align: right; }

  /* Stats strip */
  .stats {
    display: flex; gap: 1px; background: var(--border);
    border-radius: var(--radius); overflow: hidden; margin-bottom: 32px;
  }
  .stat-item { flex: 1; background: var(--surface); padding: 16px 20px; text-align: center; }
  .stat-item:first-child { border-radius: var(--radius) 0 0 var(--radius); }
  .stat-item:last-child { border-radius: 0 var(--radius) var(--radius) 0; }
  .stat-label { font-size: 11px; color: var(--dim); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; }
  .stat-value { font-size: 24px; font-weight: 700; font-variant-numeric: tabular-nums; }

  section { margin-bottom: 32px; }
  section > h2 {
    font-size: 13px; text-transform: uppercase; letter-spacing: 0.8px;
    color: var(--dim); margin-bottom: 12px; font-weight: 500;
  }

  /* Synthesis box */
  .synthesis-box {
    background: var(--accent-dim); border: 1px solid rgba(167,139,250,0.2);
    border-radius: var(--radius); padding: 20px 24px; margin-bottom: 32px;
  }
  .synthesis-box h2 {
    font-size: 11px; text-transform: uppercase; letter-spacing: 0.8px;
    color: var(--accent); margin-bottom: 8px; font-weight: 600;
  }
  .synthesis-text {
    color: var(--text-secondary); font-size: 14px; line-height: 1.7;
  }

  /* Card */
  .card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 20px 24px; margin-bottom: 16px;
  }
  .card h3 {
    font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;
    color: var(--dim); margin-bottom: 12px; font-weight: 500;
  }

  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 32px; }

  .empty { text-align: center; padding: 40px 24px; color: var(--dim); font-size: 13px; }

  /* Section hints + legend */
  .section-hint {
    font-size: 12px; color: var(--dim); font-weight: 400;
    text-transform: none; letter-spacing: 0; margin-left: 8px;
  }
  .legend {
    display: flex; flex-wrap: wrap; gap: 6px 14px;
    padding: 10px 16px; background: var(--surface);
    border: 1px solid var(--border); border-radius: 8px;
    margin-bottom: 24px; font-size: 11px; color: var(--dim);
  }
  .legend-item { white-space: nowrap; }
  .legend-dot {
    display: inline-block; width: 6px; height: 6px;
    border-radius: 50%; margin-right: 4px; vertical-align: middle;
  }
  .page-intro {
    color: var(--text-secondary); font-size: 13px; line-height: 1.7;
    margin-bottom: 24px; max-width: 800px;
  }

  /* Opportunity cards */
  .opp-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 20px 24px; margin-bottom: 12px;
    border-left: 3px solid var(--accent);
  }
  .opp-card.parked { border-left-color: var(--amber); }
  .opp-card.killed { border-left-color: var(--red); }
  .opp-header {
    display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;
  }
  .opp-name { font-size: 15px; font-weight: 600; color: var(--text); }
  .opp-badges { display: flex; gap: 8px; align-items: center; flex-shrink: 0; }

  .score-badge {
    background: var(--accent); color: var(--bg);
    padding: 3px 10px; border-radius: 100px;
    font-weight: 700; font-size: 13px;
  }
  .horizon-tag {
    padding: 3px 10px; border-radius: 100px;
    font-size: 11px; font-weight: 600;
  }
  .tag-h1 { background: var(--green-dim); color: var(--green); }
  .tag-h2 { background: var(--amber-dim); color: var(--amber); }
  .tag-h3 { background: var(--accent-dim); color: var(--accent); }

  .thesis-text {
    color: var(--text-secondary); font-size: 13px; line-height: 1.7; margin-bottom: 12px;
  }
  .data-points { list-style: none; margin-bottom: 12px; }
  .data-points li {
    padding: 3px 0 3px 16px; position: relative;
    font-size: 12px; color: var(--dim);
  }
  .data-points li::before {
    content: '\2022'; position: absolute; left: 0; color: var(--accent);
  }

  .vc-hook {
    background: var(--accent-dim); border: 1px solid rgba(167,139,250,0.15);
    border-radius: 8px; padding: 10px 14px; margin-bottom: 10px; font-size: 13px; color: var(--accent);
  }
  .vc-hook-label {
    font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px;
    color: var(--dim); margin-bottom: 2px;
  }

  .opp-footer {
    display: flex; gap: 12px; align-items: center; font-size: 12px; color: var(--dim);
    border-top: 1px solid var(--border-subtle); padding-top: 10px;
  }

  .status-tag {
    padding: 2px 10px; border-radius: 100px;
    font-size: 10px; font-weight: 600; text-transform: uppercase;
  }
  .status-active { background: var(--green-dim); color: var(--green); }
  .status-verified { background: var(--green-dim); color: var(--green); }
  .status-parked { background: var(--amber-dim); color: var(--amber); }
  .status-killed { background: var(--red-dim); color: var(--red); }
  .status-scanning { background: var(--blue-dim); color: var(--blue); }

  .counter-note {
    font-size: 11px; color: var(--orange); margin-top: 6px; padding-left: 2px;
  }

  /* Pattern cards */
  .pattern-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 16px 20px; margin-bottom: 10px;
  }
  .pattern-header {
    display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;
  }
  .pattern-name { font-weight: 600; font-size: 13px; }
  .strength-bar {
    width: 80px; height: 5px; background: var(--border);
    border-radius: 3px; overflow: hidden;
  }
  .strength-fill { height: 100%; border-radius: 3px; }
  .s-high { background: var(--green); }
  .s-med { background: var(--amber); }
  .s-low { background: var(--red); }

  .principle-tags { display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 6px; }
  .principle-tag {
    background: var(--surface-2); color: var(--dim);
    padding: 2px 8px; border-radius: 100px; font-size: 10px; font-weight: 500;
  }
  .pattern-evidence { font-size: 12px; color: var(--dim); line-height: 1.6; }
  .pattern-status { font-size: 11px; color: var(--dim); margin-top: 6px; }

  /* Kill index */
  .kill-item {
    padding: 10px 14px; border-left: 3px solid var(--red);
    background: var(--red-dim); border-radius: 0 8px 8px 0;
    margin-bottom: 8px; font-size: 13px;
  }
  .kill-target { font-weight: 600; margin-bottom: 2px; }
  .kill-reason { color: var(--red); font-size: 12px; }
  .kill-cycle { font-size: 11px; color: var(--dim); margin-top: 2px; }

  /* Parked */
  .reactivation-triggers { list-style: none; margin-top: 6px; }
  .reactivation-triggers li {
    padding: 2px 0 2px 14px; position: relative;
    font-size: 11px; color: var(--amber);
  }
  .reactivation-triggers li::before {
    content: '\25B6'; position: absolute; left: 0; font-size: 7px; top: 5px; color: var(--amber);
  }

  /* Sector grid */
  .sector-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 8px;
  }
  .sector-cell {
    padding: 12px; border-radius: 8px;
    border: 1px solid var(--border); background: var(--surface); text-align: center;
  }
  .sector-cell.sc-killed { border-color: rgba(248,113,113,0.3); background: var(--red-dim); }
  .sector-cell.sc-parked { border-color: rgba(251,191,36,0.3); background: var(--amber-dim); }
  .sector-cell.sc-scanning { border-color: rgba(96,165,250,0.3); background: var(--blue-dim); }
  .sector-cell.sc-confirmed { border-color: rgba(74,222,128,0.3); background: var(--green-dim); }
  .sector-name { font-size: 11px; font-weight: 600; margin-bottom: 2px; color: var(--text-secondary); }
  .sector-count { font-size: 20px; font-weight: 700; font-variant-numeric: tabular-nums; }
  .sector-meta { font-size: 10px; color: var(--dim); }

  /* Grading weights */
  .weight-row {
    display: flex; align-items: center; gap: 10px; margin-bottom: 8px;
  }
  .weight-label {
    min-width: 160px; font-size: 12px; color: var(--dim); text-align: right;
  }
  .weight-bar-bg {
    flex: 1; height: 16px; background: var(--surface-2);
    border-radius: 4px; overflow: hidden;
  }
  .weight-bar-fill {
    height: 100%; background: var(--accent); border-radius: 4px;
  }
  .weight-val {
    min-width: 36px; font-size: 12px; font-weight: 600;
    font-variant-numeric: tabular-nums; text-align: left;
  }

  /* Print */
  @media print {
    :root {
      --bg: #fff; --surface: #fff; --surface-2: #f5f5f5;
      --border: #ddd; --border-subtle: #eee;
      --text: #111; --text-secondary: #444; --dim: #666;
      --accent: #6d28d9; --accent-dim: #f3f0ff;
      --green: #16a34a; --green-dim: #f0fdf4;
      --red: #dc2626; --red-dim: #fef2f2;
      --amber: #d97706; --amber-dim: #fffbeb;
    }
    body { background: #fff; color: #111; font-size: 11px; }
    .container { max-width: 100%; padding: 10px; }
    nav { display: none !important; }
    .card, .opp-card, .pattern-card, .kill-item { break-inside: avoid; }
    .score-badge { background: #6d28d9; color: #fff; }
  }
</style>
</head>
<body>
<div class="container">
  <nav>
    <a href="index.html">Dashboard</a>
    <a href="ops.html">Operations</a>
    <a href="findings.html" class="active">Findings</a>
    <a href="methods.html">Methods</a>
  </nav>

  <header>
    <div>
      <h1>Findings</h1>
    </div>
    <div class="header-meta">
      <div id="last-updated">--</div>
      <div style="color:var(--green)">auto-refresh 30s</div>
    </div>
  </header>

  <p class="page-intro">
    Deep analysis of every opportunity the engine has constructed. Each business model is scored by economic force,
    structural advantage, and timing readiness. Structural patterns show recurring cross-signal themes.
    Barriers are not rejections &mdash; high-barrier sectors with moat potential may be the strongest opportunities.
  </p>

  <!-- Tier legend -->
  <div class="legend">
    <span class="legend-item"><span class="legend-dot" style="background:var(--green)"></span>Tier 1 &mdash; high conviction, near-term</span>
    <span class="legend-item"><span class="legend-dot" style="background:var(--amber)"></span>Tier 2 &mdash; strong signal, needs validation</span>
    <span class="legend-item"><span class="legend-dot" style="background:var(--accent)"></span>Tier 3 &mdash; early signal, monitoring</span>
    <span class="legend-item" style="margin-left:auto; border-left:1px solid var(--border); padding-left:14px;">
      Score = economic force (0&ndash;100) &middot; Barriers can indicate moat potential
    </span>
  </div>

  <!-- Stats -->
  <div class="stats">
    <div class="stat-item">
      <div class="stat-label">Cycle</div>
      <div class="stat-value" id="exec-cycle" style="color:var(--accent)">0</div>
    </div>
    <div class="stat-item">
      <div class="stat-label">Signals Scanned</div>
      <div class="stat-value" id="exec-signals">0</div>
    </div>
    <div class="stat-item">
      <div class="stat-label">Business Models</div>
      <div class="stat-value" id="exec-active" style="color:var(--green)">0</div>
    </div>
    <div class="stat-item">
      <div class="stat-label">Barriers</div>
      <div class="stat-value" id="exec-kills" style="color:var(--amber)">0</div>
    </div>
  </div>

  <!-- Synthesis -->
  <div class="synthesis-box">
    <h2>Master Synthesis</h2>
    <div class="synthesis-text" id="exec-synthesis">No synthesis available yet. Run a research cycle to generate findings.</div>
  </div>

  <!-- Active Opportunities -->
  <section>
    <h2>Active Opportunities <span class="section-hint">business models ranked by tier and economic force</span></h2>
    <div id="active-opportunities"><div class="empty">No active opportunities yet</div></div>
  </section>

  <!-- Patterns + Barrier Index -->
  <div class="grid-2">
    <div>
      <section>
        <h2>Structural Patterns <span class="section-hint">recurring cross-signal themes</span></h2>
        <div id="confirmed-patterns"><div class="empty">No patterns detected yet</div></div>
      </section>
    </div>
    <div>
      <section>
        <h2>Barrier Index <span class="section-hint">entry barriers &mdash; some indicate moat potential</span></h2>
        <div id="kill-index"><div class="empty">No barriers recorded</div></div>
      </section>
    </div>
  </div>

  <!-- Parked Opportunities -->
  <section>
    <h2>Parked Opportunities <span class="section-hint">paused pending customer discovery or new data</span></h2>
    <div id="parked-opportunities"><div class="empty">No parked opportunities</div></div>
  </section>

  <!-- Sectors + Weights -->
  <div class="grid-2">
    <div class="card">
      <h3>Sector Coverage</h3>
      <div id="sector-coverage"><div class="empty">No sector data</div></div>
    </div>
    <div class="card">
      <h3>Grading Weights</h3>
      <div id="grading-weights"><div class="empty">No weights configured</div></div>
    </div>
  </div>
</div>

<script>
const DATA_URL = '../data/ui/dashboard.json';

function esc(s){if(!s)return'';const d=document.createElement('div');d.textContent=s;return d.innerHTML}

function truncate(text,n){
  if(!text)return'';
  const m=text.match(/[^.!?]+[.!?]+/g);
  return m?m.slice(0,n).join(' ').trim():text;
}

function hClass(h){
  if(!h)return'';
  const l=h.toLowerCase();
  return l.includes('h1')?'tag-h1':l.includes('h2')?'tag-h2':l.includes('h3')?'tag-h3':'';
}

function sClass(s){
  if(!s)return'';
  const l=s.toLowerCase();
  if(l==='killed')return'status-killed';
  if(l==='parked')return'status-parked';
  if(l==='active'||l==='verified'||l==='confirmed'||l==='pursue')return'status-active';
  if(l==='scanning'||l==='new'||l.includes('investigate'))return'status-scanning';
  return'';
}

function strengthInfo(s){
  const l=typeof s==='string'?s.toLowerCase().replace(/_/g,'-'):'';
  if(l.includes('very')||l==='high'||l==='strong')return{cls:'s-high',pct:95};
  if(l.includes('moderate')||l==='medium')return{cls:'s-med',pct:60};
  if(typeof s==='number')return{cls:s>70?'s-high':s>40?'s-med':'s-low',pct:Math.min(100,Math.max(10,s))};
  return{cls:'s-low',pct:30};
}

function renderExec(data){
  document.getElementById('exec-cycle').textContent=data.cycle||data.current_cycle||0;
  // v2: flatten landscape tiers
  const landscape=data.opportunity_landscape||data.landscape||{};
  const t1=landscape.tier_1||[];const t2=landscape.tier_2||[];const t3=landscape.tier_3||[];
  const allLandscape=[...t1,...t2,...t3];
  const opps=allLandscape.length?allLandscape:(data.top_opportunities||[]);
  const stats=data.pipeline_stats||{};
  // v2: barrier_index; v1: kill_index
  const bi=data.barrier_index||data.kill_index;
  const biSummary=data.barrier_index_summary;
  const barrierCount=biSummary?(biSummary.total||0):bi?(Array.isArray(bi)?bi.length:(bi.barriers||bi.entries||[]).length||bi.total_barriers||bi.total_active||0):0;
  document.getElementById('exec-signals').textContent=data.signals_scanned||data.total_signals_scanned||stats.total_ever_evaluated||(data.cycle_history||[]).reduce((s,c)=>s+(c.signals||0),0)||0;
  document.getElementById('exec-active').textContent=data.models_constructed||data.total_models_constructed||stats.models_constructed||opps.length;
  document.getElementById('exec-kills').textContent=barrierCount;
  const syn=data.summary||data.master_synthesis||data.engine_status||'';
  document.getElementById('exec-synthesis').textContent=syn?truncate(syn,3):'No synthesis available yet. Run a research cycle to generate findings.';
}

function renderActive(opps){
  const el=document.getElementById('active-opportunities');
  if(!opps||!opps.length){el.innerHTML='<div class="empty">No active opportunities yet</div>';return}
  // v2: all landscape opps are active (no kill/park filtering); v1: filter killed/parked
  const active=opps.filter(o=>{const s=(o.status||'').toLowerCase();return s!=='killed'&&s!=='parked'});
  if(!active.length){el.innerHTML='<div class="empty">No active opportunities</div>';return}
  el.innerHTML=active.map(o=>{
    const dp=o.key_data_points||o.data_points||o.key_strengths||o.barriers||o.moats||[];
    const dpH=dp.length?'<ul class="data-points">'+dp.map(d=>'<li>'+esc(typeof d==='string'?d:d.point||d.description||JSON.stringify(d))+'</li>').join('')+'</ul>':'';
    const vh=o.vc_hook||o.investor_hook||'';
    const vhH=vh?'<div class="vc-hook"><div class="vc-hook-label">VC Hook</div>'+esc(vh)+'</div>':'';
    const cs=o.counter_signal_status||o.counter_signals||'';
    const csH=cs?'<div class="counter-note">Counter-signal: '+esc(typeof cs==='string'?cs:JSON.stringify(cs))+'</div>':'';
    const risksArr=o.key_risks||[];
    const risksH=risksArr.length?'<ul class="data-points" style="margin-top:8px">'+risksArr.map(r=>'<li style="color:var(--red)">'+esc(r)+'</li>').join('')+'</ul>':'';
    const actionText=o.critical_action||(o.next_steps?o.next_steps.slice(0,3).join(' / '):'');
    const actionH=actionText?'<div style="margin-top:8px;padding:8px 12px;background:var(--amber-dim);border-radius:6px;font-size:12px;color:var(--amber)">'+esc(actionText)+'</div>':'';
    return`<div class="opp-card">
      <div class="opp-header">
        <div class="opp-name">${esc(o.name)}</div>
        <div class="opp-badges">
          <span class="horizon-tag ${hClass(o.horizon)}">${esc(o.horizon||'')}</span>
          <span class="score-badge">${o.score||o.opportunity_score||'--'}</span>
        </div>
      </div>
      <div class="thesis-text">${esc(o.thesis||o.key_signals||o.note||'')}</div>
      ${dpH}${risksH}${vhH}${actionH}
      <div class="opp-footer">
        <span class="status-tag ${sClass(o.status)}">${esc(o.status||'unknown')}</span>
        <span>${esc(o.recommendation||o.critical_action||'')}</span>
      </div>
      ${csH}
    </div>`;
  }).join('');
}

function renderPatterns(patterns){
  const el=document.getElementById('confirmed-patterns');
  if(!patterns||!patterns.length){el.innerHTML='<div class="empty">No patterns detected yet</div>';return}
  el.innerHTML=patterns.map(p=>{
    const pr=p.principles||p.principle_names||[];
    const prH=pr.length?'<div class="principle-tags">'+pr.map(x=>'<span class="principle-tag">'+esc(x)+'</span>').join('')+'</div>':'';
    const si=strengthInfo(p.strength);
    return`<div class="pattern-card">
      <div class="pattern-header">
        <span class="pattern-name">${esc(p.name||p.pattern||p.shift||'Unnamed')}</span>
        <div class="strength-bar"><div class="strength-fill ${si.cls}" style="width:${si.pct}%"></div></div>
      </div>
      ${prH}
      <div class="pattern-evidence">${esc(p.evidence||p.description||'')}</div>
      <div class="pattern-status">${esc(p.status||'')}</div>
    </div>`;
  }).join('');
}

function renderKills(barriers){
  const el=document.getElementById('kill-index');
  if(!barriers||!barriers.length){el.innerHTML='<div class="empty">No barriers recorded</div>';return}
  el.innerHTML=barriers.map(b=>{
    const moat=b.moat_potential?' <span style="color:var(--green);font-size:10px">MOAT</span>':'';
    return`<div class="kill-item" style="border-left-color:${b.moat_potential?'var(--amber)':'var(--red)'}">
    <div class="kill-target">${esc(b.target||b.name||b.opportunity||b.sector||'Unknown')}${moat}</div>
    <div class="kill-reason">${esc(b.reason||b.rationale||b.description||'')}</div>
    <div class="kill-cycle">${b.review_date?'Review: '+esc(b.review_date):'Cycle '+(b.cycle_killed||b.cycle||'?')}</div>
  </div>`}).join('');
}

function renderParked(opps){
  const el=document.getElementById('parked-opportunities');
  if(!opps){el.innerHTML='<div class="empty">No parked opportunities</div>';return}
  const parked=opps.filter(o=>(o.status||'').toLowerCase()==='parked');
  if(!parked.length){el.innerHTML='<div class="empty">No parked opportunities</div>';return}
  el.innerHTML=parked.map(o=>{
    const trRaw=o.reactivation_triggers||o.triggers||(o.reactivation_trigger?[o.reactivation_trigger]:[]);
    const tr=Array.isArray(trRaw)?trRaw:[trRaw];
    const trH=tr.length?'<ul class="reactivation-triggers">'+tr.map(t=>'<li>'+esc(typeof t==='string'?t:t.trigger||JSON.stringify(t))+'</li>').join('')+'</ul>':'';
    return`<div class="opp-card parked">
      <div class="opp-header">
        <div class="opp-name">${esc(o.name)}</div>
        <div class="opp-badges">
          <span class="horizon-tag ${hClass(o.horizon)}">${esc(o.horizon||'')}</span>
          <span class="score-badge">${o.score||o.opportunity_score||'--'}</span>
        </div>
      </div>
      <div class="thesis-text">${esc(o.park_reason||o.thesis||'')}</div>
      <div class="opp-footer">
        <span class="status-tag status-parked">PARKED</span>
        <span>${esc(o.recommendation||o.critical_action||'')}</span>
      </div>
      ${trH}
    </div>`;
  }).join('');
}

function renderSectors(heatmap){
  const el=document.getElementById('sector-coverage');
  if(!heatmap||!Object.keys(heatmap).length){el.innerHTML='<div class="empty">No sector data</div>';return}
  el.innerHTML='<div class="sector-grid">'+Object.entries(heatmap).map(([name,data])=>{
    const st=(data.status||'scanning').toLowerCase();
    let cls='';
    if(st==='killed')cls='sc-killed';
    else if(st==='parked')cls='sc-parked';
    else if(st==='confirmed')cls='sc-confirmed';
    else cls='sc-scanning';
    return`<div class="sector-cell ${cls}">
      <div class="sector-name">${esc(name)}</div>
      <div class="sector-count">${data.signal_count||0}</div>
      <div class="sector-meta">avg ${data.avg_score!=null?data.avg_score.toFixed(1):'--'}</div>
    </div>`;
  }).join('')+'</div>';
}

function renderWeights(weights){
  const el=document.getElementById('grading-weights');
  if(!weights||!Object.keys(weights).length){el.innerHTML='<div class="empty">No weights configured</div>';return}
  const mx=Math.max(...Object.values(weights).map(v=>typeof v==='number'?v:0),1);
  el.innerHTML=Object.entries(weights).map(([name,value])=>{
    const n=typeof value==='number'?value:parseFloat(value)||0;
    const pct=(n/mx)*100;
    return`<div class="weight-row">
      <div class="weight-label">${esc(name)}</div>
      <div class="weight-bar-bg"><div class="weight-bar-fill" style="width:${pct}%"></div></div>
      <div class="weight-val">${n.toFixed(2)}</div>
    </div>`;
  }).join('');
}

async function refresh(){
  document.getElementById('last-updated').textContent=new Date().toLocaleString();
  try{
    const r=await fetch(DATA_URL+'?t='+Date.now());
    if(!r.ok)return;
    const d=await r.json();
    renderExec(d);
    // v2: flatten landscape tiers; v1: use top_opportunities
    const landscape=d.opportunity_landscape||d.landscape||{};
    const t1=(landscape.tier_1||[]).map(o=>Object.assign({tier:'Tier 1',status:'Tier 1',name:o.name||o.structural_shift},o));
    const t2=(landscape.tier_2||[]).map(o=>Object.assign({tier:'Tier 2',status:'Tier 2',name:o.name||o.structural_shift},o));
    const t3=(landscape.tier_3||[]).map(o=>Object.assign({tier:'Tier 3',status:'Tier 3',name:o.name||o.structural_shift},o));
    const allOpps=[...t1,...t2,...t3];
    const opps=allOpps.length?allOpps:(d.top_opportunities||[]);
    renderActive(opps);
    renderPatterns(d.key_patterns||d.structural_patterns||d.structural_shifts_active||d.cross_principle_patterns);
    // v2: barrier_index; v1: kill_index; also check landscape barriers_noted
    const bi=d.barrier_index||d.kill_index;
    let barriers=bi?(Array.isArray(bi)?bi:(bi.barriers||bi.entries||[])):[];
    if(!barriers.length&&landscape.barriers_noted){
      barriers=landscape.barriers_noted.map(b=>({target:b.barrier,reason:b.sectors?b.sectors.join(', '):'',moat_potential:b.moat_potential}));
    }
    renderKills(barriers);
    renderParked(opps);
    renderSectors(d.sector_heatmap);
    renderWeights(d.grading_weights_current||d.grading_weights);
  }catch{}
}

refresh();
setInterval(refresh,30000);
</script>
</body>
</html>
