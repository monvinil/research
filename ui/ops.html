<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Operations Center - AI Economic Research Engine</title>
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #12121a;
    --border: #1e1e2e;
    --text: #e0e0e0;
    --dim: #6b6b80;
    --accent: #4fc3f7;
    --green: #66bb6a;
    --red: #ef5350;
    --yellow: #ffa726;
    --purple: #ab47bc;
    --cyan: #26c6da;
    --orange: #ff7043;
    --blue: #42a5f5;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
    background: var(--bg);
    color: var(--text);
    font-size: 13px;
    line-height: 1.5;
  }
  .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
  header {
    border-bottom: 1px solid var(--border);
    padding-bottom: 16px;
    margin-bottom: 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  h1 { font-size: 16px; font-weight: 600; color: var(--accent); }
  .meta { color: var(--dim); font-size: 11px; }
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 16px;
  }
  .card h2 {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--dim);
    margin-bottom: 12px;
  }

  /* Status bar */
  .stat-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr 1fr;
    gap: 16px;
    margin-bottom: 24px;
  }
  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 16px;
    text-align: center;
  }
  .stat-card .label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--dim);
    margin-bottom: 6px;
  }
  .stat-card .count {
    font-size: 32px;
    font-weight: 700;
    color: var(--accent);
  }
  .stat-card.pending .count { color: var(--yellow); }
  .stat-card.running .count { color: var(--accent); }
  .stat-card.completed .count { color: var(--green); }
  .stat-card.failed .count { color: var(--red); }
  .stat-card.failed.has-failures {
    border-color: var(--red);
    box-shadow: 0 0 12px rgba(239, 83, 80, 0.15);
  }

  /* Active tasks */
  .task-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
  }
  .task-item:last-child { border-bottom: none; }
  .task-badge {
    font-size: 10px;
    font-weight: 700;
    padding: 3px 8px;
    border-radius: 3px;
    text-transform: uppercase;
    min-width: 70px;
    text-align: center;
    white-space: nowrap;
  }
  .badge-scan { background: rgba(66,165,245,0.2); color: var(--blue); }
  .badge-agent-a { background: rgba(102,187,106,0.2); color: var(--green); }
  .badge-agent-b { background: rgba(171,71,188,0.2); color: var(--purple); }
  .badge-agent-c { background: rgba(255,167,38,0.2); color: var(--yellow); }
  .badge-counter-signal { background: rgba(255,112,67,0.2); color: var(--orange); }
  .badge-explore { background: rgba(38,198,218,0.2); color: var(--cyan); }
  .badge-master { background: rgba(239,83,80,0.2); color: var(--red); }
  .badge-unknown { background: rgba(107,107,128,0.2); color: var(--dim); }

  .task-desc { flex: 1; font-size: 12px; }
  .task-elapsed {
    font-size: 11px;
    color: var(--dim);
    font-variant-numeric: tabular-nums;
    min-width: 60px;
    text-align: right;
  }

  .pulse-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--green);
    animation: pulse-anim 1.5s ease-in-out infinite;
    flex-shrink: 0;
  }
  @keyframes pulse-anim {
    0%, 100% { opacity: 0.3; transform: scale(0.8); }
    50% { opacity: 1; transform: scale(1.2); }
  }

  /* Timeline */
  .timeline {
    display: flex;
    align-items: center;
    gap: 0;
    margin-bottom: 24px;
    overflow-x: auto;
    padding: 12px 0;
  }
  .timeline-phase {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 12px 16px;
    border-radius: 6px;
    min-width: 110px;
    text-align: center;
    position: relative;
    background: var(--surface);
    border: 1px solid var(--border);
  }
  .timeline-phase.active {
    border-color: var(--accent);
    box-shadow: 0 0 16px rgba(79,195,247,0.2);
  }
  .timeline-phase.active .phase-label {
    color: var(--accent);
    font-weight: 700;
  }
  .timeline-phase.completed-phase {
    border-color: var(--green);
  }
  .timeline-phase.completed-phase .phase-label {
    color: var(--green);
  }
  .phase-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--dim);
    font-weight: 600;
  }
  .phase-check {
    font-size: 14px;
    margin-bottom: 2px;
    color: var(--green);
  }
  .phase-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--border);
    margin-bottom: 4px;
  }
  .timeline-phase.active .phase-dot {
    background: var(--accent);
    animation: pulse-anim 1.5s ease-in-out infinite;
  }
  .timeline-phase.completed-phase .phase-dot {
    background: var(--green);
  }
  .timeline-arrow {
    color: var(--dim);
    font-size: 16px;
    padding: 0 6px;
    flex-shrink: 0;
  }

  /* Completions */
  .completions-list {
    max-height: 400px;
    overflow-y: auto;
  }
  .completion-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
    font-size: 12px;
  }
  .completion-item:last-child { border-bottom: none; }
  .completion-item.recent {
    background: rgba(102,187,106,0.05);
    border-left: 3px solid var(--green);
    padding-left: 8px;
    margin-left: -8px;
  }
  .completion-duration {
    font-size: 11px;
    color: var(--dim);
    min-width: 50px;
    text-align: right;
    font-variant-numeric: tabular-nums;
  }

  /* Error log */
  .error-card {
    border-color: var(--border);
    transition: border-color 0.3s;
  }
  .error-card.has-errors {
    border-color: var(--red);
    box-shadow: 0 0 12px rgba(239, 83, 80, 0.1);
  }
  .error-toggle {
    background: none;
    border: none;
    color: var(--dim);
    cursor: pointer;
    font-family: inherit;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1px;
    display: flex;
    align-items: center;
    gap: 8px;
    width: 100%;
    padding: 0;
  }
  .error-toggle:hover { color: var(--text); }
  .error-toggle .arrow { transition: transform 0.2s; }
  .error-toggle .arrow.open { transform: rotate(90deg); }
  .error-content {
    display: none;
    margin-top: 12px;
  }
  .error-content.open { display: block; }
  .error-item {
    padding: 8px;
    border-left: 3px solid var(--red);
    margin-bottom: 8px;
    background: rgba(239, 83, 80, 0.05);
    border-radius: 0 4px 4px 0;
    font-size: 12px;
  }
  .error-item .error-type { font-weight: 600; margin-bottom: 2px; }
  .error-item .error-msg { color: var(--red); font-size: 11px; }

  /* Controls */
  .controls {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .btn {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 4px 12px;
    border-radius: 4px;
    font-family: inherit;
    font-size: 11px;
    cursor: pointer;
    transition: border-color 0.2s;
  }
  .btn:hover { border-color: var(--accent); }
  .toggle-label {
    font-size: 11px;
    color: var(--dim);
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
  }
  .toggle-label input { cursor: pointer; }
  .refresh-indicator {
    font-size: 10px;
    color: var(--dim);
  }
  .refresh-indicator.active { color: var(--green); }

  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; }

  .empty-state {
    text-align: center;
    padding: 40px;
    color: var(--dim);
  }
  .empty-state .icon { font-size: 32px; margin-bottom: 12px; }

  .pulse { animation: pulse-text 2s ease-in-out infinite; }
  @keyframes pulse-text { 0%, 100% { opacity: 0.4; } 50% { opacity: 1; } }
</style>
</head>
<body>
<div class="container">
  <nav style="display:flex;gap:16px;margin-bottom:12px;font-size:11px;">
    <a href="index.html" style="color:var(--dim);text-decoration:none;">DASHBOARD</a>
    <a href="ops.html" style="color:var(--accent);text-decoration:none;font-weight:600;">OPS CENTER</a>
    <a href="findings.html" style="color:var(--dim);text-decoration:none;">FINDINGS</a>
  </nav>

  <header>
    <div>
      <h1>OPERATIONS CENTER</h1>
      <div class="meta">Parallel Task Execution Monitor</div>
    </div>
    <div style="display:flex;align-items:center;gap:16px;">
      <div class="controls">
        <button class="btn" id="refresh-btn" onclick="manualRefresh()">Refresh</button>
        <label class="toggle-label">
          <input type="checkbox" id="auto-refresh-toggle" checked onchange="toggleAutoRefresh()">
          Auto-refresh
        </label>
        <span class="refresh-indicator" id="refresh-indicator">3s</span>
      </div>
      <div style="text-align:right;">
        <div class="meta" id="current-time">--:--:--</div>
        <div class="meta pulse" id="auto-refresh-status">AUTO</div>
      </div>
    </div>
  </header>

  <!-- Status Bar -->
  <div class="stat-grid">
    <div class="stat-card pending">
      <div class="label">Pending</div>
      <div class="count" id="count-pending">0</div>
    </div>
    <div class="stat-card running">
      <div class="label">Running</div>
      <div class="count" id="count-running">0</div>
    </div>
    <div class="stat-card completed">
      <div class="label">Completed</div>
      <div class="count" id="count-completed">0</div>
    </div>
    <div class="stat-card failed" id="failed-card">
      <div class="label">Failed</div>
      <div class="count" id="count-failed">0</div>
    </div>
  </div>

  <!-- Task Timeline -->
  <div class="card" style="margin-bottom:24px;">
    <h2>Cycle Pipeline</h2>
    <div class="timeline" id="timeline"></div>
  </div>

  <!-- Active Tasks & Recent Completions -->
  <div class="grid-2">
    <div class="card">
      <h2>Active Tasks</h2>
      <div id="active-tasks">
        <div class="empty-state">
          <div class="icon">~</div>
          <div>No active tasks</div>
        </div>
      </div>
    </div>
    <div class="card">
      <h2>Recent Completions</h2>
      <div id="recent-completions" class="completions-list">
        <div class="empty-state">
          <div class="icon">~</div>
          <div>No completed tasks yet</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Pending Tasks -->
  <div class="card" style="margin-bottom:24px;">
    <h2>Pending Queue</h2>
    <div id="pending-tasks">
      <div class="empty-state">
        <div class="icon">~</div>
        <div>No pending tasks</div>
      </div>
    </div>
  </div>

  <!-- Error Log -->
  <div class="card error-card" id="error-card" style="margin-bottom:24px;">
    <button class="error-toggle" id="error-toggle" onclick="toggleErrors()">
      <span class="arrow" id="error-arrow">&#9654;</span>
      Error Log <span id="error-count-label">(0)</span>
    </button>
    <div class="error-content" id="error-content">
      <div id="error-list">
        <div class="empty-state" style="padding:20px;">No errors</div>
      </div>
    </div>
  </div>
</div>

<script>
const STATUS_URL = '../data/tasks/status.json';
const REFRESH_MS = 3000;
let autoRefreshEnabled = true;
let refreshTimer = null;
let lastStatus = null;

const PHASES = [
  { key: 'scan', label: 'SCAN' },
  { key: 'agent-a', label: 'AGENT A' },
  { key: 'counter-signal', label: 'COUNTER-SIGNALS' },
  { key: 'agent-c', label: 'AGENT C' },
  { key: 'agent-b', label: 'AGENT B' },
  { key: 'master', label: 'MASTER' },
];

const BADGE_CLASSES = {
  'scan': 'badge-scan',
  'agent-a': 'badge-agent-a',
  'agent-b': 'badge-agent-b',
  'agent-c': 'badge-agent-c',
  'counter-signal': 'badge-counter-signal',
  'explore': 'badge-explore',
  'master': 'badge-master',
};

function getBadgeClass(taskType) {
  return BADGE_CLASSES[taskType] || 'badge-unknown';
}

async function fetchJSON(url) {
  try {
    const res = await fetch(url + '?t=' + Date.now());
    if (!res.ok) return null;
    return await res.json();
  } catch { return null; }
}

function formatElapsed(startedAt) {
  if (!startedAt) return '--';
  const start = new Date(startedAt);
  const now = new Date();
  const diffMs = now - start;
  if (isNaN(diffMs) || diffMs < 0) return '--';
  const secs = Math.floor(diffMs / 1000);
  if (secs < 60) return secs + 's';
  const mins = Math.floor(secs / 60);
  const remSecs = secs % 60;
  if (mins < 60) return mins + 'm ' + remSecs + 's';
  const hrs = Math.floor(mins / 60);
  const remMins = mins % 60;
  return hrs + 'h ' + remMins + 'm';
}

function formatDuration(startedAt, completedAt) {
  if (!startedAt || !completedAt) return '--';
  const start = new Date(startedAt);
  const end = new Date(completedAt);
  const diffMs = end - start;
  if (isNaN(diffMs) || diffMs < 0) return '--';
  const secs = Math.floor(diffMs / 1000);
  if (secs < 60) return secs + 's';
  const mins = Math.floor(secs / 60);
  const remSecs = secs % 60;
  return mins + 'm ' + remSecs + 's';
}

function isRecent(completedAt, thresholdSec) {
  if (!completedAt) return false;
  const completed = new Date(completedAt);
  const now = new Date();
  return (now - completed) < thresholdSec * 1000;
}

function updateClock() {
  const now = new Date();
  const timeStr = now.toLocaleTimeString('en-US', { hour12: false });
  document.getElementById('current-time').textContent = timeStr;
}

function renderTimeline(status) {
  const el = document.getElementById('timeline');
  const runningTypes = new Set((status.running || []).map(t => t.task_type));
  const completedTypes = new Set((status.completed || []).map(t => t.task_type));

  el.innerHTML = PHASES.map((phase, i) => {
    const isActive = runningTypes.has(phase.key);
    const isCompleted = !isActive && completedTypes.has(phase.key);
    let cls = 'timeline-phase';
    if (isActive) cls += ' active';
    else if (isCompleted) cls += ' completed-phase';

    let indicator;
    if (isCompleted) {
      indicator = '<div class="phase-check">&#10003;</div>';
    } else if (isActive) {
      indicator = '<div class="phase-dot"></div>';
    } else {
      indicator = '<div class="phase-dot"></div>';
    }

    const arrow = i < PHASES.length - 1
      ? '<span class="timeline-arrow">&#8594;</span>'
      : '';

    return `<div class="${cls}">${indicator}<div class="phase-label">${phase.label}</div></div>${arrow}`;
  }).join('');
}

function renderActiveTasks(tasks) {
  const el = document.getElementById('active-tasks');
  if (!tasks || tasks.length === 0) {
    el.innerHTML = '<div class="empty-state"><div class="icon">~</div><div>No active tasks</div></div>';
    return;
  }
  el.innerHTML = tasks.map(t => `
    <div class="task-item">
      <div class="pulse-dot"></div>
      <span class="task-badge ${getBadgeClass(t.task_type)}">${t.task_type}</span>
      <span class="task-desc">${escapeHtml(t.description || t.task_id)}</span>
      <span class="task-elapsed">${formatElapsed(t.started_at)}</span>
    </div>
  `).join('');
}

function renderPendingTasks(tasks) {
  const el = document.getElementById('pending-tasks');
  if (!tasks || tasks.length === 0) {
    el.innerHTML = '<div class="empty-state"><div class="icon">~</div><div>No pending tasks</div></div>';
    return;
  }
  el.innerHTML = tasks.slice(0, 20).map(t => `
    <div class="task-item">
      <span class="task-badge ${getBadgeClass(t.task_type)}">${t.task_type}</span>
      <span class="task-desc">${escapeHtml(t.description || t.task_id)}</span>
      <span class="task-elapsed" style="color:var(--yellow);">queued</span>
    </div>
  `).join('');
}

function renderRecentCompletions(tasks) {
  const el = document.getElementById('recent-completions');
  if (!tasks || tasks.length === 0) {
    el.innerHTML = '<div class="empty-state"><div class="icon">~</div><div>No completed tasks yet</div></div>';
    return;
  }
  el.innerHTML = tasks.slice(0, 20).map(t => {
    const recent = isRecent(t.completed_at, 60);
    return `
      <div class="completion-item${recent ? ' recent' : ''}">
        <span class="task-badge ${getBadgeClass(t.task_type)}">${t.task_type}</span>
        <span class="task-desc">${escapeHtml(t.description || t.task_id)}</span>
        <span class="completion-duration">${formatDuration(t.started_at, t.completed_at)}</span>
      </div>
    `;
  }).join('');
}

function renderErrors(tasks) {
  const el = document.getElementById('error-list');
  const card = document.getElementById('error-card');
  const countLabel = document.getElementById('error-count-label');
  const count = tasks ? tasks.length : 0;

  countLabel.textContent = '(' + count + ')';

  if (count > 0) {
    card.classList.add('has-errors');
  } else {
    card.classList.remove('has-errors');
  }

  if (!tasks || tasks.length === 0) {
    el.innerHTML = '<div class="empty-state" style="padding:20px;">No errors</div>';
    return;
  }
  el.innerHTML = tasks.map(t => `
    <div class="error-item">
      <div class="error-type">[${t.task_type}] ${escapeHtml(t.task_id)}</div>
      <div class="error-msg">${escapeHtml(t.error || 'Unknown error')}</div>
    </div>
  `).join('');
}

function updateStatusCounts(counts) {
  document.getElementById('count-pending').textContent = counts.pending || 0;
  document.getElementById('count-running').textContent = counts.running || 0;
  document.getElementById('count-completed').textContent = counts.completed || 0;
  document.getElementById('count-failed').textContent = counts.failed || 0;

  const failedCard = document.getElementById('failed-card');
  if (counts.failed > 0) {
    failedCard.classList.add('has-failures');
  } else {
    failedCard.classList.remove('has-failures');
  }
}

function escapeHtml(str) {
  if (!str) return '';
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function toggleErrors() {
  const content = document.getElementById('error-content');
  const arrow = document.getElementById('error-arrow');
  const isOpen = content.classList.contains('open');
  if (isOpen) {
    content.classList.remove('open');
    arrow.classList.remove('open');
  } else {
    content.classList.add('open');
    arrow.classList.add('open');
  }
}

function toggleAutoRefresh() {
  autoRefreshEnabled = document.getElementById('auto-refresh-toggle').checked;
  const statusEl = document.getElementById('auto-refresh-status');
  const indicatorEl = document.getElementById('refresh-indicator');

  if (autoRefreshEnabled) {
    statusEl.textContent = 'AUTO';
    statusEl.classList.add('pulse');
    indicatorEl.textContent = '3s';
    indicatorEl.classList.add('active');
    startAutoRefresh();
  } else {
    statusEl.textContent = 'PAUSED';
    statusEl.classList.remove('pulse');
    indicatorEl.textContent = 'off';
    indicatorEl.classList.remove('active');
    stopAutoRefresh();
  }
}

function startAutoRefresh() {
  stopAutoRefresh();
  refreshTimer = setInterval(refresh, REFRESH_MS);
}

function stopAutoRefresh() {
  if (refreshTimer) {
    clearInterval(refreshTimer);
    refreshTimer = null;
  }
}

function manualRefresh() {
  refresh();
}

function showEmptyState() {
  updateStatusCounts({ pending: 0, running: 0, completed: 0, failed: 0 });

  document.getElementById('active-tasks').innerHTML =
    '<div class="empty-state"><div class="icon">~</div><div>No tasks dispatched. Waiting for dispatcher to create status.json</div></div>';
  document.getElementById('recent-completions').innerHTML =
    '<div class="empty-state"><div class="icon">~</div><div>No completed tasks yet</div></div>';
  document.getElementById('pending-tasks').innerHTML =
    '<div class="empty-state"><div class="icon">~</div><div>No pending tasks</div></div>';

  // Render timeline with all phases inactive
  renderTimeline({ running: [], completed: [] });
  renderErrors([]);
}

async function refresh() {
  updateClock();

  const status = await fetchJSON(STATUS_URL);

  if (!status) {
    showEmptyState();
    return;
  }

  lastStatus = status;

  // Update counts
  updateStatusCounts(status.counts || {
    pending: (status.pending || []).length,
    running: (status.running || []).length,
    completed: (status.completed || []).length,
    failed: (status.failed || []).length,
  });

  // Render sections
  renderTimeline(status);
  renderActiveTasks(status.running);
  renderPendingTasks(status.pending);
  renderRecentCompletions(status.completed);
  renderErrors(status.failed);
}

// Initialize
updateClock();
setInterval(updateClock, 1000);
refresh();
startAutoRefresh();
</script>
</body>
</html>
