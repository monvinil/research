<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Research Engine v4.1</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,300;14..32,400;14..32,500;14..32,600;14..32,700;14..32,800;14..32,900&display=swap');

  :root {
    --bg: #06060b;
    --surface: rgba(255,255,255,0.025);
    --surface-hover: rgba(255,255,255,0.045);
    --glass: rgba(255,255,255,0.03);
    --glass-border: rgba(255,255,255,0.055);
    --glass-border-hover: rgba(255,255,255,0.1);
    --text: #ededf4;
    --text-secondary: #8e8ea0;
    --dim: #4e4e6a;
    --accent: #a78bfa;
    --accent-soft: rgba(167,139,250,0.12);
    --green: #34d399;
    --green-dim: rgba(52,211,153,0.08);
    --red: #f87171;
    --red-dim: rgba(248,113,113,0.06);
    --amber: #fbbf24;
    --amber-dim: rgba(251,191,36,0.06);
    --blue: #60a5fa;
    --blue-dim: rgba(96,165,250,0.06);
    --cyan: #22d3ee;
    --cyan-dim: rgba(34,211,238,0.06);
    --pink: #f472b6;
    --gradient-hero: linear-gradient(135deg, rgba(167,139,250,0.08) 0%, rgba(96,165,250,0.05) 50%, rgba(52,211,153,0.03) 100%);
    --gradient-accent: linear-gradient(135deg, #a78bfa, #818cf8, #60a5fa);
    --gradient-warm: linear-gradient(135deg, #f87171, #fbbf24);
    --gradient-cool: linear-gradient(135deg, #60a5fa, #22d3ee);
    --radius: 14px;
    --radius-sm: 8px;
    --radius-xs: 6px;
    --blur: 24px;
    --transition: 0.18s cubic-bezier(0.4, 0, 0.2, 1);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    font-size: 13.5px;
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    min-height: 100dvh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    top: -50%; left: -30%;
    width: 90%; height: 90%;
    background: radial-gradient(ellipse at 30% 30%, rgba(167,139,250,0.035) 0%, transparent 55%);
    pointer-events: none; z-index: 0;
  }
  body::after {
    content: '';
    position: fixed;
    bottom: -40%; right: -25%;
    width: 80%; height: 80%;
    background: radial-gradient(ellipse at 70% 70%, rgba(52,211,153,0.02) 0%, transparent 55%);
    pointer-events: none; z-index: 0;
  }

  .container {
    max-width: 1280px;
    margin: 0 auto;
    padding: 32px 24px;
    padding-top: max(32px, env(safe-area-inset-top));
    padding-bottom: max(48px, env(safe-area-inset-bottom));
    position: relative;
    z-index: 1;
  }

  /* Nav */
  nav {
    display: flex;
    gap: 2px;
    margin-bottom: 32px;
    background: var(--glass);
    backdrop-filter: blur(var(--blur));
    border: 1px solid var(--glass-border);
    border-radius: 10px;
    padding: 3px;
    width: fit-content;
  }
  nav a {
    color: var(--dim);
    text-decoration: none;
    font-size: 12.5px;
    font-weight: 500;
    padding: 7px 18px;
    border-radius: 7px;
    transition: all var(--transition);
    white-space: nowrap;
    cursor: pointer;
  }
  nav a:hover { color: var(--text-secondary); }
  nav a.active { background: rgba(255,255,255,0.06); color: var(--text); }

  /* Header */
  header { margin-bottom: 32px; }
  h1 {
    font-size: 28px;
    font-weight: 800;
    letter-spacing: -0.8px;
    margin-bottom: 4px;
    background: var(--gradient-accent);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .subtitle {
    color: var(--dim);
    font-size: 13px;
    font-weight: 400;
  }
  .cycle-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 2px 10px;
    border-radius: 20px;
    background: var(--accent-soft);
    color: var(--accent);
    font-weight: 600;
    font-size: 11.5px;
  }

  /* Glass */
  .glass {
    background: var(--glass);
    backdrop-filter: blur(var(--blur));
    border: 1px solid var(--glass-border);
    border-radius: var(--radius);
    transition: border-color var(--transition), background var(--transition);
  }
  .glass:hover {
    border-color: var(--glass-border-hover);
    background: var(--surface-hover);
  }
  .glass-static {
    background: var(--glass);
    backdrop-filter: blur(var(--blur));
    border: 1px solid var(--glass-border);
    border-radius: var(--radius);
  }

  /* Sections */
  .section-label {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--dim);
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .section-label .count {
    background: var(--accent-soft);
    color: var(--accent);
    padding: 1px 8px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 600;
  }
  .card { padding: 24px; margin-bottom: 16px; }
  .view-section { display: none; }
  .view-section.active { display: block; }

  /* Narrative Table */
  .narr-table { width: 100%; border-collapse: collapse; }
  .narr-table th { text-align: left; padding: 8px 10px; font-size: 10px; text-transform: uppercase; letter-spacing: 0.8px; color: var(--dim); border-bottom: 1px solid var(--glass-border); white-space: nowrap; cursor: pointer; }
  .narr-table td { padding: 10px 10px; border-bottom: 1px solid rgba(255,255,255,0.02); font-size: 12.5px; vertical-align: middle; }
  .narr-table tbody tr.narr-row { cursor: pointer; transition: background var(--transition); }
  .narr-table tbody tr.narr-row:hover { background: var(--surface-hover); }
  .narr-expand-icon { display: inline-block; width: 16px; text-align: center; font-size: 10px; color: var(--dim); transition: transform 0.2s, color 0.2s; }
  .narr-row:hover .narr-expand-icon { color: var(--accent); }
  .narr-row.expanded .narr-expand-icon { transform: rotate(90deg); color: var(--accent); }
  .tns-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
  .tns-DEFINING { background: rgba(52,211,153,0.12); color: var(--green); }
  .tns-MAJOR { background: rgba(96,165,250,0.12); color: var(--blue); }
  .tns-MODERATE { background: rgba(251,191,36,0.12); color: var(--amber); }
  .tns-EMERGING { background: rgba(167,139,250,0.12); color: var(--accent); }
  .tns-SPECULATIVE { background: rgba(255,255,255,0.05); color: var(--dim); }
  .narr-axes { display: flex; flex-direction: column; gap: 2px; }
  .narr-axis-bar { display: flex; align-items: center; gap: 4px; }
  .narr-axis-bar .axis-bar-label { width: 18px; font-size: 8px; color: var(--dim); text-align: right; }
  .narr-axis-bar .axis-bar-track { flex: 1; height: 4px; background: rgba(255,255,255,0.04); border-radius: 2px; min-width: 40px; }
  .narr-axis-bar .axis-bar-fill { height: 100%; border-radius: 2px; transition: width 0.3s; }
  .narr-axis-bar .axis-bar-val { font-size: 9px; color: var(--text-secondary); width: 22px; text-align: right; }
  .narr-model-count { display: flex; gap: 6px; font-size: 10px; }
  .narr-model-count span { padding: 1px 6px; border-radius: 3px; }
  .nmc-works { background: rgba(52,211,153,0.1); color: var(--green); }
  .nmc-needed { background: rgba(96,165,250,0.1); color: var(--blue); }
  .nmc-dies { background: rgba(248,113,113,0.1); color: var(--red); }
  .narr-phase { font-size: 10px; padding: 2px 6px; border-radius: 3px; background: rgba(255,255,255,0.04); color: var(--text-secondary); white-space: nowrap; }

  /* Narrative badge in model rows */
  .narr-badge { display: inline-block; font-size: 8px; padding: 1px 5px; border-radius: 3px; font-weight: 600; margin-left: 4px; vertical-align: middle; }
  .narr-role-what_works { background: rgba(52,211,153,0.12); color: var(--green); }
  .narr-role-whats_needed { background: rgba(96,165,250,0.12); color: var(--blue); }
  .narr-role-what_dies { background: rgba(248,113,113,0.12); color: var(--red); }

  /* Narrative Detail Expand */
  .narr-detail { display: none; padding: 20px; background: rgba(255,255,255,0.015); border-top: 1px solid var(--glass-border); }
  .narr-detail.expanded { display: block; }
  .narr-detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 12px; }
  @media (max-width: 768px) { .narr-detail-grid { grid-template-columns: 1fr; } }
  .narr-detail-section { padding: 12px; background: var(--surface); border-radius: var(--radius-sm); }
  .narr-detail-section h4 { font-size: 10px; text-transform: uppercase; letter-spacing: 0.8px; color: var(--dim); margin-bottom: 8px; }
  .narr-timeline { display: flex; flex-direction: column; gap: 6px; }
  .narr-timeline-year { display: flex; gap: 8px; font-size: 11px; }
  .narr-timeline-year .year { font-weight: 600; color: var(--accent); min-width: 55px; }
  .narr-timeline-year .phase-tag { font-size: 9px; padding: 1px 5px; border-radius: 3px; background: rgba(167,139,250,0.1); color: var(--accent); }
  .narr-timeline-year .desc { color: var(--text-secondary); font-size: 11px; }
  .narr-model-list { display: flex; flex-direction: column; gap: 3px; max-height: 200px; overflow-y: auto; }
  .narr-model-item { font-size: 11px; padding: 4px 8px; border-radius: 4px; background: rgba(255,255,255,0.02); cursor: pointer; }
  .narr-model-item:hover { background: rgba(255,255,255,0.06); }

  /* Cascade view */
  .cascade-card { padding: 16px; margin-bottom: 12px; }
  .cascade-links { display: flex; flex-direction: column; gap: 4px; margin-top: 8px; }
  .cascade-link { display: flex; align-items: flex-start; gap: 8px; font-size: 11px; padding: 6px 8px; border-radius: 4px; background: rgba(255,255,255,0.02); }
  .cascade-link-pos { font-weight: 700; color: var(--accent); min-width: 20px; }
  .cascade-link-name { color: var(--text); }
  .cascade-link-status { font-size: 10px; color: var(--text-secondary); }
  .cascade-narr-tags { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 8px; }
  .cascade-narr-tag { font-size: 9px; padding: 2px 6px; border-radius: 3px; background: var(--accent-soft); color: var(--accent); cursor: pointer; }
  .cascade-edge { display: flex; align-items: center; gap: 6px; font-size: 11px; padding: 4px 0; }
  .cascade-edge-arrow { color: var(--accent); font-weight: 700; }

  /* KPI Row */
  .kpi-row {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 10px;
    margin-bottom: 16px;
  }
  @media (max-width: 768px) { .kpi-row { grid-template-columns: repeat(3, 1fr); } }
  .kpi { padding: 16px 12px; text-align: center; }
  .kpi-label {
    font-size: 9px;
    color: var(--dim);
    text-transform: uppercase;
    letter-spacing: 1.2px;
    font-weight: 600;
    margin-bottom: 6px;
  }
  .kpi-value {
    font-size: 24px;
    font-weight: 800;
    font-variant-numeric: tabular-nums;
    letter-spacing: -1px;
    line-height: 1;
  }
  .kpi-sub {
    font-size: 10px;
    font-weight: 500;
    margin-top: 4px;
    color: var(--text-secondary);
  }

  /* Hero */
  .hero {
    padding: 28px;
    background: var(--gradient-hero);
    border-color: rgba(167,139,250,0.07);
    margin-bottom: 16px;
    position: relative;
    overflow: hidden;
  }
  .hero::before {
    content: '';
    position: absolute;
    top: -20px; right: -20px;
    width: 240px; height: 240px;
    background: radial-gradient(circle, rgba(167,139,250,0.06), transparent 60%);
    pointer-events: none;
  }
  .hero-label {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--accent);
    margin-bottom: 10px;
  }
  .hero-text {
    font-size: 13.5px;
    color: var(--text-secondary);
    line-height: 1.8;
    max-width: 900px;
  }
  .hero-text strong { color: var(--text); }

  /* What's New Banner */
  .whats-new {
    padding: 20px 24px;
    margin-bottom: 16px;
    background: rgba(248,113,113,0.04);
    border-color: rgba(248,113,113,0.1);
  }
  .whats-new-title {
    font-size: 12px; font-weight: 700; color: var(--red);
    text-transform: uppercase; letter-spacing: 1px;
    margin-bottom: 12px;
  }
  .whats-new-items {
    display: flex; flex-wrap: wrap; gap: 8px;
  }
  .wn-tag {
    font-size: 10.5px; font-weight: 600; padding: 4px 12px;
    border-radius: 8px; display: inline-flex; align-items: center; gap: 4px;
  }
  .wn-force { background: rgba(52,211,153,0.08); color: var(--green); }
  .wn-pattern { background: rgba(167,139,250,0.08); color: var(--accent); }
  .wn-model { background: rgba(248,113,113,0.08); color: var(--red); }
  .wn-sector { background: rgba(96,165,250,0.08); color: var(--blue); }

  /* Search and Filter Bar */
  .controls-bar {
    display: flex; flex-wrap: wrap; gap: 10px; align-items: center;
    margin-bottom: 16px;
  }
  .search-box {
    flex: 1; min-width: 200px; max-width: 400px;
    padding: 8px 14px; border-radius: 8px;
    border: 1px solid var(--glass-border);
    background: var(--glass);
    color: var(--text); font-size: 12.5px;
    font-family: inherit;
    outline: none;
    transition: border-color var(--transition);
  }
  .search-box::placeholder { color: var(--dim); }
  .search-box:focus { border-color: var(--accent); }
  .sort-select {
    padding: 8px 12px; border-radius: 8px;
    border: 1px solid var(--glass-border);
    background: var(--glass);
    color: var(--text); font-size: 12px;
    font-family: inherit;
    cursor: pointer; outline: none;
    -webkit-appearance: none; appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' fill='%238e8ea0'%3E%3Cpath d='M0 0l5 6 5-6z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 10px center;
    padding-right: 28px;
  }
  .filter-chips {
    display: flex; flex-wrap: wrap; gap: 6px;
  }
  .filter-chip {
    font-size: 10px; font-weight: 600; padding: 4px 10px;
    border-radius: 10px; cursor: pointer;
    border: 1px solid transparent;
    transition: all var(--transition);
    text-transform: uppercase; letter-spacing: 0.3px;
  }
  .filter-chip:hover { opacity: 0.85; }
  .filter-chip.active { border-color: currentColor; }

  /* Confidence tier badges */
  .conf-HIGH { background: rgba(52,211,153,0.08); color: var(--green); }
  .conf-MODERATE { background: rgba(251,191,36,0.06); color: var(--amber); }
  .conf-LOW { background: rgba(248,113,113,0.06); color: var(--red); }
  .confidence-badge { font-size: 9px; font-weight: 700; padding: 2px 6px; border-radius: 8px; text-transform: uppercase; letter-spacing: 0.3px; }

  /* Force filter chips */
  .force-filter-chip { background: rgba(167,139,250,0.06); color: var(--accent); }
  .force-filter-chip.active { background: rgba(167,139,250,0.15); border-color: var(--accent); }

  /* Falsification criteria in detail panel */
  .falsification-list { list-style: none; padding: 0; margin: 0; }
  .falsification-item { font-size: 11px; color: var(--text-secondary); padding: 4px 0 4px 16px; position: relative; line-height: 1.5; }
  .falsification-item::before { content: '\2717'; color: var(--red); position: absolute; left: 0; font-size: 10px; }

  /* Rationale text */
  .detail-rationale { font-size: 11.5px; color: var(--text-secondary); line-height: 1.6; padding: 10px 12px; background: rgba(255,255,255,0.015); border-radius: var(--radius-xs); border-left: 3px solid var(--glass-border); margin-bottom: 12px; }

  /* Running patterns */
  .patterns-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 10px; margin-bottom: 16px; }
  .pattern-card { padding: 14px; font-size: 12px; color: var(--text); cursor: pointer; }
  .pattern-card:hover { border-color: var(--accent); }
  .pattern-id { font-size: 10px; color: var(--dim); font-weight: 600; margin-bottom: 4px; }
  .pattern-evidence { font-size: 10.5px; color: var(--text-secondary); margin-top: 6px; }

  /* Glossary */
  .glossary-section { margin-bottom: 24px; }
  .glossary-section h3 { font-size: 14px; font-weight: 700; color: var(--text); margin-bottom: 12px; padding-bottom: 6px; border-bottom: 1px solid var(--glass-border); }
  .glossary-table { width: 100%; border-collapse: collapse; font-size: 12px; }
  .glossary-table th { text-align: left; font-size: 10px; font-weight: 700; color: var(--dim); text-transform: uppercase; letter-spacing: 0.5px; padding: 6px 10px; border-bottom: 1px solid var(--glass-border); }
  .glossary-table td { padding: 8px 10px; border-bottom: 1px solid rgba(255,255,255,0.02); vertical-align: top; }
  .glossary-table tr:hover { background: rgba(255,255,255,0.015); }
  .glossary-abbr { font-weight: 700; color: var(--accent); white-space: nowrap; min-width: 40px; }
  .glossary-full { color: var(--text); font-weight: 600; }
  .glossary-desc { color: var(--text-secondary); line-height: 1.6; }
  .glossary-formula { font-family: monospace; font-size: 11px; color: var(--cyan); background: rgba(34,211,238,0.04); padding: 3px 8px; border-radius: 4px; display: inline-block; margin-top: 4px; }
  .glossary-badge { font-size: 9px; font-weight: 700; padding: 2px 6px; border-radius: 6px; text-transform: uppercase; letter-spacing: 0.3px; display: inline-block; }
  .glossary-intro { font-size: 13px; color: var(--text-secondary); line-height: 1.7; margin-bottom: 20px; padding: 16px; background: var(--glass); border: 1px solid var(--glass-border); border-radius: var(--radius); }

  /* Scatter plot */
  .scatter-dot { position: absolute; border-radius: 50%; cursor: pointer; transition: transform 0.15s ease, opacity 0.15s ease; opacity: 0.7; }
  .scatter-dot:hover { transform: scale(2); opacity: 1; z-index: 10; }
  .scatter-axis-label { position: absolute; font-size: 10px; color: var(--dim); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
  .scatter-grid-line { position: absolute; background: rgba(255,255,255,0.03); }
  .scatter-tooltip { position: absolute; background: var(--bg); border: 1px solid var(--glass-border); border-radius: 6px; padding: 6px 10px; font-size: 10px; color: var(--text); pointer-events: none; z-index: 20; white-space: nowrap; display: none; }
  .toggle-btn {
    font-size: 10.5px; font-weight: 600; padding: 6px 14px;
    border-radius: 8px; cursor: pointer;
    border: 1px solid var(--glass-border);
    background: var(--glass); color: var(--dim);
    font-family: inherit;
    transition: all var(--transition);
  }
  .toggle-btn.active {
    background: rgba(248,113,113,0.1);
    border-color: rgba(248,113,113,0.2);
    color: var(--red);
  }
  .view-toggle {
    display: flex; gap: 2px; background: var(--glass);
    border: 1px solid var(--glass-border); border-radius: 7px; padding: 2px;
  }
  .view-toggle button {
    font-size: 11px; font-weight: 500; padding: 5px 12px;
    border-radius: 5px; cursor: pointer;
    border: none; background: transparent; color: var(--dim);
    font-family: inherit; transition: all var(--transition);
  }
  .view-toggle button.active { background: rgba(255,255,255,0.06); color: var(--text); }

  /* Conviction Toggle */
  .conviction-toggle {
    display: flex; gap: 2px; background: var(--glass);
    border: 1px solid var(--glass-border); border-radius: 7px; padding: 2px;
  }
  .conviction-toggle button {
    font-size: 10px; font-weight: 600; padding: 5px 10px;
    border-radius: 5px; cursor: pointer;
    border: none; background: transparent; color: var(--dim);
    font-family: inherit; transition: all var(--transition);
  }
  .conviction-toggle button.active { background: rgba(255,255,255,0.06); color: var(--text); }
  .conviction-toggle button[data-conviction="confirmed"].active { color: var(--green); }
  .conviction-toggle button[data-conviction="what-if"].active { color: #f59e0b; }

  /* Conditional/Parked row dimming */
  .model-table tr.row-conditional { opacity: 0.65; }
  .model-table tr.row-conditional:hover { opacity: 0.85; }

  /* Model Table */
  .model-table { width: 100%; border-collapse: collapse; }
  .model-table th {
    text-align: left; font-size: 9.5px; font-weight: 600; text-transform: uppercase;
    letter-spacing: 0.8px; color: var(--dim); padding: 10px 10px;
    border-bottom: 1px solid var(--glass-border);
    cursor: pointer; white-space: nowrap; user-select: none;
  }
  .model-table th:hover { color: var(--text-secondary); }
  .model-table th.sorted { color: var(--accent); }
  .model-table td {
    padding: 10px 10px; font-size: 12px;
    border-bottom: 1px solid rgba(255,255,255,0.03);
    vertical-align: middle;
  }
  .model-table tr { cursor: pointer; transition: background var(--transition); }
  .model-table tbody tr:hover { background: rgba(255,255,255,0.02); }
  .model-table .rank-cell { font-weight: 600; color: var(--dim); width: 40px; font-variant-numeric: tabular-nums; }
  .model-table .name-cell { font-weight: 600; color: var(--text); max-width: 240px; }
  .model-table .composite-cell { font-weight: 800; font-variant-numeric: tabular-nums; font-size: 14px; }
  .model-table .opp-cell { font-weight: 700; font-variant-numeric: tabular-nums; font-size: 13px; }
  .new-badge {
    display: inline-block; font-size: 8px; font-weight: 800;
    padding: 1px 5px; border-radius: 4px; margin-left: 6px;
    background: rgba(248,113,113,0.15); color: var(--red);
    letter-spacing: 0.5px; vertical-align: middle;
  }
  .sub-badge {
    display: inline-block; font-size: 8px; font-weight: 800;
    padding: 1px 5px; border-radius: 4px; margin-left: 6px;
    background: rgba(34,211,238,0.15); color: var(--cyan);
    letter-spacing: 0.5px; vertical-align: middle;
  }
  .decomposed-indicator {
    font-size: 9px; font-weight: 500; color: var(--dim);
    margin-left: 4px;
  }

  /* Axis mini-bars */
  .axis-bars { display: flex; gap: 3px; align-items: center; }
  .axis-bar {
    display: flex; flex-direction: column; align-items: center; gap: 1px;
    width: 28px;
  }
  .axis-bar-label { font-size: 7px; color: var(--dim); font-weight: 600; letter-spacing: 0.3px; }
  .axis-bar-track {
    width: 100%; height: 4px; border-radius: 2px;
    background: rgba(255,255,255,0.05); overflow: hidden;
  }
  .axis-bar-fill { height: 100%; border-radius: 2px; transition: width 0.6s ease; }
  .axis-bar-val { font-size: 8px; color: var(--text-secondary); font-weight: 600; font-variant-numeric: tabular-nums; }

  /* Category badge */
  .cat-badge {
    font-size: 8.5px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
    padding: 2px 7px; border-radius: 6px; white-space: nowrap;
  }
  .cat-STRUCTURAL_WINNER { background: rgba(52,211,153,0.12); color: var(--green); }
  .cat-FORCE_RIDER { background: rgba(96,165,250,0.12); color: var(--blue); }
  .cat-GEOGRAPHIC_PLAY { background: rgba(34,211,238,0.12); color: var(--cyan); }
  .cat-TIMING_ARBITRAGE { background: rgba(251,191,36,0.12); color: var(--amber); }
  .cat-CAPITAL_MOAT { background: rgba(167,139,250,0.12); color: var(--accent); }
  .cat-FEAR_ECONOMY { background: rgba(248,113,113,0.12); color: var(--red); }
  .cat-EMERGING_CATEGORY { background: rgba(34,211,238,0.12); color: var(--cyan); }
  .cat-CONDITIONAL { background: rgba(255,255,255,0.06); color: var(--text-secondary); }
  .cat-PARKED { background: rgba(255,255,255,0.04); color: var(--dim); }

  /* Opportunity category badges */
  .opp-WIDE_OPEN { background: rgba(52,211,153,0.15); color: var(--green); }
  .opp-ACCESSIBLE { background: rgba(96,165,250,0.15); color: var(--blue); }
  .opp-CONTESTED { background: rgba(251,191,36,0.15); color: var(--amber); }
  .opp-FORTIFIED { background: rgba(248,113,113,0.15); color: var(--red); }
  .opp-LOCKED { background: rgba(248,113,113,0.25); color: var(--red); }

  /* VCR category badges */
  .vcr-FUND_RETURNER { background: rgba(52,211,153,0.15); color: var(--green); }
  .vcr-STRONG_MULTIPLE { background: rgba(96,165,250,0.15); color: var(--blue); }
  .vcr-VIABLE_RETURN { background: rgba(251,191,36,0.15); color: var(--amber); }
  .vcr-MARGINAL { background: rgba(248,113,113,0.15); color: var(--red); }
  .vcr-VC_POOR { background: rgba(255,255,255,0.06); color: var(--dim); }

  /* ROI multiple display */
  .roi-value { font-variant-numeric: tabular-nums; font-weight: 800; }
  .roi-high { color: var(--green); }
  .roi-good { color: var(--blue); }
  .roi-moderate { color: var(--amber); }
  .roi-low { color: var(--red); }

  /* Expanded model detail */
  .model-detail {
    display: none;
    padding: 20px 24px;
    margin: 0 0 12px 0;
    animation: fadeIn 0.25s ease;
  }
  .model-detail.visible { display: block; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
  .detail-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
  .detail-name { font-size: 16px; font-weight: 800; letter-spacing: -0.3px; }
  .detail-id { font-size: 11px; color: var(--dim); margin-top: 2px; }
  .detail-composites { display: flex; gap: 20px; align-items: flex-end; }
  .detail-composite-block { text-align: center; }
  .detail-composite-label { font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.8px; color: var(--dim); margin-bottom: 2px; }
  .detail-composite { font-size: 36px; font-weight: 900; color: var(--accent); font-variant-numeric: tabular-nums; line-height: 1; }
  .detail-composite-opp { font-size: 28px; font-weight: 800; color: var(--blue); font-variant-numeric: tabular-nums; line-height: 1; }
  .detail-axes {
    display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px;
    margin-bottom: 12px;
  }
  .detail-cla-axes {
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;
    margin-bottom: 16px;
  }
  @media (max-width: 600px) { .detail-axes { grid-template-columns: repeat(3, 1fr); } .detail-cla-axes { grid-template-columns: repeat(2, 1fr); } }
  .detail-axis {
    text-align: center; padding: 12px 8px;
    background: rgba(255,255,255,0.02); border-radius: var(--radius-xs);
  }
  .da-label { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
  .da-value { font-size: 22px; font-weight: 800; font-variant-numeric: tabular-nums; line-height: 1; }
  .da-bar { height: 4px; border-radius: 2px; background: rgba(255,255,255,0.06); margin-top: 6px; overflow: hidden; }
  .da-bar-fill { height: 100%; border-radius: 2px; }
  .detail-meta { display: flex; flex-wrap: wrap; gap: 16px; font-size: 11.5px; color: var(--text-secondary); margin-bottom: 12px; }
  .detail-meta span { display: flex; align-items: center; gap: 4px; }
  .detail-meta .meta-label { color: var(--dim); font-weight: 600; }
  .detail-cats { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }
  .detail-sub-info {
    font-size: 11.5px; color: var(--cyan); padding: 8px 12px;
    background: rgba(34,211,238,0.05); border-radius: var(--radius-xs);
    border-left: 3px solid var(--cyan); margin-bottom: 12px;
  }
  .detail-decomp-info {
    font-size: 11.5px; color: var(--accent); padding: 8px 12px;
    background: rgba(167,139,250,0.05); border-radius: var(--radius-xs);
    border-left: 3px solid var(--accent); margin-bottom: 12px;
  }
  .detail-oneliner {
    font-size: 12.5px; color: var(--text-secondary); line-height: 1.7;
    padding: 12px; background: rgba(167,139,250,0.03); border-radius: var(--radius-xs);
    border-left: 3px solid var(--accent);
  }

  /* Card Grid View */
  .model-card-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
  @media (max-width: 768px) { .model-card-grid { grid-template-columns: 1fr; } }
  .model-card-item {
    padding: 16px; cursor: pointer;
    transition: border-color var(--transition), background var(--transition);
  }
  .model-card-item:hover { border-color: var(--glass-border-hover); background: var(--surface-hover); }
  .mci-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
  .mci-rank { font-size: 10px; color: var(--dim); font-weight: 600; }
  .mci-name { font-size: 13px; font-weight: 700; color: var(--text); margin-bottom: 6px; line-height: 1.3; }
  .mci-score-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
  .mci-composite { font-size: 22px; font-weight: 800; color: var(--accent); font-variant-numeric: tabular-nums; }
  .mci-opp-composite { font-size: 16px; font-weight: 700; color: var(--blue); font-variant-numeric: tabular-nums; }
  .mci-scores { display: flex; gap: 6px; flex-wrap: wrap; }
  .mci-axis { font-size: 10px; font-weight: 600; color: var(--text-secondary); }
  .mci-axis-label { color: var(--dim); font-size: 8px; }
  .mci-cats { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 6px; }

  /* Pagination */
  .pagination {
    display: flex; justify-content: center; align-items: center;
    gap: 8px; margin-top: 20px; padding: 12px 0;
  }
  .page-btn {
    font-size: 11px; font-weight: 600; padding: 6px 12px;
    border-radius: 6px; cursor: pointer;
    border: 1px solid var(--glass-border);
    background: var(--glass); color: var(--text-secondary);
    font-family: inherit;
    transition: all var(--transition);
  }
  .page-btn:hover { border-color: var(--glass-border-hover); color: var(--text); }
  .page-btn.active { background: var(--accent-soft); border-color: var(--accent); color: var(--accent); }
  .page-btn:disabled { opacity: 0.3; cursor: default; }
  .page-info { font-size: 11px; color: var(--dim); }

  /* Category Distribution */
  .cat-dist { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
  .cat-chip {
    font-size: 10px; font-weight: 600; padding: 3px 10px; border-radius: 10px;
    display: flex; align-items: center; gap: 5px;
  }
  .cat-chip-count { font-weight: 800; }

  /* Force Velocity */
  .force-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px; }
  @media (max-width: 768px) { .force-grid { grid-template-columns: 1fr; } }
  .force-card { padding: 20px; cursor: pointer; }
  .force-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  .force-name { font-size: 13px; font-weight: 700; color: var(--text); }
  .force-velocity {
    font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
    padding: 2px 8px; border-radius: 10px;
  }
  .vel-accelerating { background: rgba(52,211,153,0.12); color: var(--green); }
  .vel-steady { background: rgba(96,165,250,0.12); color: var(--blue); }
  .vel-shifting { background: rgba(251,191,36,0.12); color: var(--amber); }
  .vel-intensifying { background: rgba(248,113,113,0.12); color: var(--red); }
  .vel-constraining { background: rgba(244,114,182,0.12); color: var(--pink); }
  .vel-decelerating { background: rgba(248,113,113,0.12); color: var(--red); }
  .force-metric { font-size: 11.5px; color: var(--text-secondary); margin-bottom: 8px; font-weight: 500; }
  .force-bar { height: 3px; border-radius: 2px; background: rgba(255,255,255,0.05); overflow: hidden; margin-bottom: 8px; }
  .force-bar-fill { height: 100%; border-radius: 2px; transition: width 1s ease; }
  .force-data { display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--glass-border); }
  .force-card.expanded .force-data { display: block; }
  .force-datum { font-size: 11px; color: var(--text-secondary); padding: 3px 0; line-height: 1.5; }
  .force-datum::before { content: '\2022'; color: var(--dim); margin-right: 6px; }
  .force-projection { font-size: 11px; color: var(--accent); margin-top: 8px; font-style: italic; }

  /* Sector Table */
  .sector-table { width: 100%; border-collapse: collapse; }
  .sector-table th {
    text-align: left; font-size: 10px; font-weight: 600; text-transform: uppercase;
    letter-spacing: 1px; color: var(--dim); padding: 8px 12px; border-bottom: 1px solid var(--glass-border);
  }
  .sector-table td { padding: 12px; font-size: 12.5px; border-bottom: 1px solid rgba(255,255,255,0.03); }
  .sector-table tr:last-child td { border-bottom: none; }
  .sector-phase {
    display: inline-block; font-size: 10px; font-weight: 600; padding: 2px 8px;
    border-radius: 10px; text-transform: uppercase; letter-spacing: 0.3px;
  }
  .phase-acceleration { background: rgba(248,113,113,0.12); color: var(--red); }
  .phase-early_disruption { background: rgba(251,191,36,0.12); color: var(--amber); }
  .phase-pre_disruption { background: rgba(96,165,250,0.12); color: var(--blue); }
  .sector-change { font-weight: 700; font-variant-numeric: tabular-nums; }
  .sector-change-neg { color: var(--red); }
  .sector-change-pos { color: var(--green); }

  /* World Map */
  .world-map-container {
    position: relative; padding: 32px 24px; margin-bottom: 16px;
    min-height: 420px; overflow: hidden;
  }
  .map-grid {
    position: absolute; top: 0; left: 0; right: 0; bottom: 0;
    background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.02) 1px, transparent 0);
    background-size: 40px 40px; pointer-events: none;
  }
  .map-regions {
    position: relative; display: grid;
    grid-template-columns: repeat(12, 1fr);
    grid-template-rows: repeat(6, 60px);
    gap: 4px; z-index: 1;
  }
  .region-node {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    padding: 8px 6px; border-radius: var(--radius-sm);
    background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.04);
    cursor: pointer; transition: all 0.3s ease; position: relative; z-index: 2;
  }
  .region-node:hover {
    background: rgba(255,255,255,0.06); border-color: rgba(167,139,250,0.2);
    transform: translateY(-2px); box-shadow: 0 8px 32px rgba(0,0,0,0.3); z-index: 10;
  }
  .region-node.active { background: rgba(167,139,250,0.08); border-color: rgba(167,139,250,0.2); }
  .region-emoji { font-size: 20px; margin-bottom: 2px; }
  .region-name { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); }
  .region-vel { font-size: 8px; font-weight: 600; margin-top: 2px; }
  .rv-fast { color: var(--green); }
  .rv-moderate { color: var(--amber); }
  .rv-nascent { color: var(--dim); }
  .rv-accelerating { color: var(--cyan); }
  .region-detail {
    display: none; padding: 20px; margin-bottom: 16px;
    animation: fadeIn 0.3s ease;
  }
  .region-detail.visible { display: block; }
  .region-detail-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
  .region-detail-emoji { font-size: 32px; }
  .region-detail-name { font-size: 18px; font-weight: 800; letter-spacing: -0.5px; }
  .region-detail-vel { font-size: 11px; font-weight: 500; color: var(--text-secondary); }
  .region-metrics { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 10px; margin-bottom: 16px; }
  .region-metric { padding: 12px; background: rgba(255,255,255,0.02); border-radius: var(--radius-xs); border: 1px solid rgba(255,255,255,0.04); }
  .rm-label { font-size: 9px; text-transform: uppercase; letter-spacing: 0.8px; color: var(--dim); font-weight: 600; margin-bottom: 4px; }
  .rm-value { font-size: 14px; font-weight: 700; color: var(--text); }
  .region-forces { margin-bottom: 12px; }
  .region-force-item { font-size: 11.5px; color: var(--text-secondary); padding: 3px 0; }
  .region-force-item::before { content: '\25B8'; color: var(--accent); margin-right: 6px; }
  .region-outlook {
    font-size: 12px; color: var(--text-secondary); line-height: 1.7;
    padding: 12px; background: rgba(167,139,250,0.04); border-radius: var(--radius-xs);
    border-left: 3px solid var(--accent);
  }

  /* Fear Friction */
  .friction-grid { display: grid; gap: 8px; }
  .friction-row { display: grid; grid-template-columns: 140px 1fr 60px; align-items: center; gap: 12px; padding: 8px 0; }
  .friction-sector { font-size: 12px; font-weight: 600; color: var(--text); }
  .friction-bar-track { flex: 1; height: 20px; border-radius: 4px; background: rgba(255,255,255,0.03); position: relative; overflow: hidden; }
  .friction-bar-econ { position: absolute; top: 0; left: 0; height: 100%; border-radius: 4px; background: linear-gradient(90deg, rgba(52,211,153,0.4), rgba(52,211,153,0.15)); transition: width 1s ease; }
  .friction-bar-psych { position: absolute; top: 0; left: 0; height: 100%; border-radius: 4px; background: linear-gradient(90deg, rgba(248,113,113,0.5), rgba(248,113,113,0.15)); transition: width 1s ease; z-index: 1; }
  .friction-gap { font-size: 16px; font-weight: 800; text-align: right; font-variant-numeric: tabular-nums; }
  .gap-high { color: var(--red); }
  .gap-medium { color: var(--amber); }
  .gap-low { color: var(--green); }
  .friction-legend { display: flex; gap: 20px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--glass-border); }
  .friction-legend-item { font-size: 10px; color: var(--dim); display: flex; align-items: center; gap: 6px; }
  .friction-legend-dot { width: 8px; height: 8px; border-radius: 2px; }

  /* Markets Table */
  .markets-table { width: 100%; border-collapse: collapse; }
  .markets-table th { font-size: 9px; text-transform: uppercase; letter-spacing: 1px; color: var(--dim); font-weight: 600; text-align: left; padding: 8px 10px; border-bottom: 1px solid var(--glass-border); }
  .markets-table td { font-size: 12px; padding: 8px 10px; border-bottom: 1px solid rgba(255,255,255,0.02); color: var(--text-secondary); }
  .cagr-value { font-weight: 700; font-variant-numeric: tabular-nums; }
  .cagr-hot { color: var(--red); }
  .cagr-warm { color: var(--amber); }
  .cagr-cool { color: var(--green); }

  /* Key Findings */
  .findings-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
  @media (max-width: 768px) { .findings-grid { grid-template-columns: 1fr; } }
  .finding { padding: 18px; cursor: pointer; }
  .finding-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; margin-bottom: 6px; }
  .finding-title { font-size: 13px; font-weight: 700; color: var(--text); line-height: 1.4; }
  .finding-confidence { font-size: 9px; font-weight: 600; text-transform: uppercase; padding: 2px 6px; border-radius: 8px; flex-shrink: 0; }
  .conf-high { background: rgba(52,211,153,0.1); color: var(--green); }
  .conf-medium { background: rgba(251,191,36,0.1); color: var(--amber); }
  .finding-magnitude { font-size: 11px; font-weight: 600; color: var(--accent); margin-bottom: 4px; }
  .finding-detail { font-size: 11.5px; color: var(--text-secondary); line-height: 1.6; display: none; }
  .finding.expanded .finding-detail { display: block; margin-top: 8px; }

  /* Sentiment Trajectory */
  .trajectory-row { display: grid; grid-template-columns: 180px 100px 1fr 100px; align-items: center; gap: 12px; padding: 6px 0; font-size: 12px; }
  @media (max-width: 768px) { .trajectory-row { grid-template-columns: 1fr 1fr; gap: 4px; font-size: 11px; } }
  .traj-metric { font-weight: 600; color: var(--text); }
  .traj-baseline { color: var(--text-secondary); font-variant-numeric: tabular-nums; }
  .traj-arrow { display: flex; align-items: center; gap: 4px; font-size: 11px; color: var(--dim); }
  .traj-2031 { font-weight: 700; color: var(--accent); text-align: right; }

  /* Perez Cycle */
  .perez-timeline { display: flex; align-items: center; gap: 0; padding: 20px 0; position: relative; }
  .perez-phase { flex: 1; text-align: center; padding: 16px 8px; position: relative; border-bottom: 3px solid rgba(255,255,255,0.05); }
  .perez-phase.current { border-bottom-color: var(--accent); background: rgba(167,139,250,0.04); border-radius: var(--radius-xs) var(--radius-xs) 0 0; }
  .perez-phase.past { border-bottom-color: rgba(52,211,153,0.3); }
  .perez-phase-name { font-size: 11px; font-weight: 700; color: var(--text); margin-bottom: 2px; }
  .perez-phase.current .perez-phase-name { color: var(--accent); }
  .perez-phase-years { font-size: 9px; color: var(--dim); font-weight: 500; }
  .perez-marker {
    position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%);
    width: 12px; height: 12px; border-radius: 50%; background: var(--accent);
    border: 2px solid var(--bg); box-shadow: 0 0 12px rgba(167,139,250,0.4);
    animation: pulse 2s infinite;
  }
  @keyframes pulse { 0%, 100% { box-shadow: 0 0 12px rgba(167,139,250,0.4); } 50% { box-shadow: 0 0 24px rgba(167,139,250,0.6); } }

  /* Displacement */
  .displacement-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px; }
  @media (max-width: 768px) { .displacement-grid { grid-template-columns: 1fr; } }
  .disp-stat { padding: 18px; text-align: center; }
  .disp-value { font-size: 28px; font-weight: 900; line-height: 1; margin-bottom: 4px; font-variant-numeric: tabular-nums; }
  .disp-label { font-size: 10px; color: var(--text-secondary); font-weight: 500; }
  .disp-sub { font-size: 9px; color: var(--dim); margin-top: 4px; }

  /* Defense */
  .defense-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
  .defense-stat { padding: 14px; text-align: center; background: rgba(255,255,255,0.02); border-radius: var(--radius-xs); }
  .defense-value { font-size: 18px; font-weight: 800; color: var(--text); margin-bottom: 2px; }
  .defense-label { font-size: 9px; color: var(--dim); text-transform: uppercase; letter-spacing: 0.5px; }

  /* Cycle History */
  .cycle-chart { display: flex; align-items: flex-end; gap: 6px; height: 100px; padding-top: 10px; }
  .cycle-bar {
    flex: 1; min-width: 12px; border-radius: 4px 4px 0 0;
    transition: height 1s ease, opacity 0.3s; position: relative; cursor: default;
  }
  .cycle-bar:hover { opacity: 1 !important; }
  .cycle-bar::after {
    content: attr(data-label); position: absolute; bottom: -18px; left: 50%;
    transform: translateX(-50%); font-size: 8px; color: var(--dim); white-space: nowrap; letter-spacing: 0.3px;
  }

  /* Expandable / Evidence */
  .expandable-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding-bottom: 4px; }
  .expand-icon { font-size: 10px; color: var(--dim); transition: transform var(--transition); }
  .expandable-content { display: none; }
  .expanded .expandable-content { display: block; }
  .expanded .expand-icon { transform: rotate(180deg); }
  .evidence-card { padding: 12px 14px; background: rgba(255,255,255,0.02); border-radius: var(--radius-xs); border: 1px solid rgba(255,255,255,0.04); margin-bottom: 8px; }
  .evidence-name { font-size: 12px; font-weight: 600; color: var(--text); }
  .evidence-score { font-size: 11px; font-weight: 700; color: var(--green); }
  .evidence-sector { font-size: 10px; color: var(--dim); }

  /* Two-col */
  .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
  @media (max-width: 900px) { .two-col { grid-template-columns: 1fr; } }

  /* Results info */
  .results-info { font-size: 11px; color: var(--dim); margin-bottom: 12px; }

  .footer {
    text-align: center; padding: 32px 0 16px; color: var(--dim); font-size: 11px;
  }
</style>
</head>
<body>
<div id="auth-gate" style="display:flex;align-items:center;justify-content:center;min-height:100dvh;position:relative;z-index:10">
  <div class="glass" style="padding:48px 40px;text-align:center;max-width:340px;width:90%;border:1px solid var(--glass-border)">
    <div style="font-size:22px;font-weight:700;margin-bottom:6px;background:var(--gradient-accent);-webkit-background-clip:text;-webkit-text-fill-color:transparent">Research Engine</div>
    <div style="color:var(--text-secondary);font-size:12px;margin-bottom:28px">v4.1 &middot; 685 models &middot; triple ranked</div>
    <input id="auth-input" type="password" placeholder="Access code" autofocus
      style="width:100%;padding:12px 16px;background:var(--surface);border:1px solid var(--glass-border);border-radius:var(--radius-sm);color:var(--text);font-family:inherit;font-size:14px;outline:none;margin-bottom:12px;transition:border-color var(--transition)"
      onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--glass-border)'">
    <div id="auth-error" style="color:var(--red);font-size:11px;height:18px;margin-bottom:8px"></div>
    <button onclick="checkAuth()" style="width:100%;padding:10px;background:var(--accent);color:#000;font-weight:600;border:none;border-radius:var(--radius-sm);cursor:pointer;font-family:inherit;font-size:13px">Enter</button>
  </div>
</div>
<script>
function checkAuth(){
  var p=document.getElementById('auth-input').value;
  if(p==='1212'){
    sessionStorage.setItem('re_auth','1');
    document.getElementById('auth-gate').style.display='none';
    document.getElementById('main-app').style.display='';
    if(typeof refresh==='function')refresh();
  } else {
    document.getElementById('auth-error').textContent='Invalid code';
    document.getElementById('auth-input').value='';
    document.getElementById('auth-input').focus();
  }
}
document.addEventListener('DOMContentLoaded',function(){
  document.getElementById('auth-input').addEventListener('keydown',function(e){if(e.key==='Enter')checkAuth();});
  if(sessionStorage.getItem('re_auth')==='1'){
    document.getElementById('auth-gate').style.display='none';
    document.getElementById('main-app').style.display='';
  }
});
</script>
<div class="container" id="main-app" style="display:none">
  <nav id="main-nav">
    <a class="active" data-view="models">Models</a>
    <a data-view="vcroi">VC ROI</a>
    <a data-view="narratives">Narratives</a>
    <a data-view="forces">Forces</a>
    <a data-view="cascades">Cascades</a>
    <a data-view="sectors">Sectors</a>
    <a data-view="regions">Regions</a>
    <a data-view="fear">Fear Index</a>
    <a data-view="timeline">Timeline</a>
    <a data-view="catalyst">Catalyst</a>
    <a data-view="data">Data</a>
    <a data-view="glossary">Glossary</a>
  </nav>

  <header>
    <h1>Research Engine v4.1</h1>
    <div class="subtitle">
      <span class="cycle-badge" id="cycle-badge">v4-0</span>
      &nbsp; <span id="model-total-sub">685 models</span> &middot; <span id="narr-total-sub">16 narratives</span> &middot; 6 forces &middot; 8 regions &middot; Updated <span id="last-updated">--</span>
    </div>
    <div style="font-size:11px;color:var(--dim);margin-top:4px;line-height:1.5;max-width:820px"><strong>685 business models</strong> ranked on 3 independent axes: Transformation, Opportunity, and VC ROI. Organized by 16 transformation narratives across 6 macro forces, 8 regions, and 66 force collisions (2026&ndash;2031). See <a href="#" onclick="event.preventDefault();document.querySelector('[data-view=glossary]').click()" style="color:var(--accent);text-decoration:underline">Glossary</a> for full definitions.</div>
  </header>

  <!-- KPI Row (always visible) -->
  <div class="kpi-row" id="kpi-row">
    <div class="glass kpi" title="Business models scored on 3 independent axes: T-Score, Opportunity, VC ROI"><div class="kpi-label">Models</div><div class="kpi-value" style="color:var(--accent)" id="kpi-rated">--</div><div class="kpi-sub" id="kpi-model-sub">triple ranked</div></div>
    <div class="glass kpi" title="STRUCTURAL_WINNER models: SN≥8 AND FA≥8 — strongest transformation signal"><div class="kpi-label">Structural Winners</div><div class="kpi-value" style="color:var(--green)" id="kpi-sw">--</div><div class="kpi-sub">SN&ge;8, FA&ge;8</div></div>
    <div class="glass kpi" title="Models with VCR composite ≥75 — potential to return an entire fund"><div class="kpi-label">Fund Returners</div><div class="kpi-value" style="color:var(--amber)" id="kpi-fr">--</div><div class="kpi-sub">VCR &ge; 75</div></div>
    <div class="glass kpi" title="Highest Transformation Score across all models"><div class="kpi-label">Top T-Score</div><div class="kpi-value" style="color:var(--blue)" id="kpi-top-t">--</div><div class="kpi-sub" id="kpi-t-mean-sub">mean --</div></div>
    <div class="glass kpi" title="Transformation narratives organizing models by force collisions"><div class="kpi-label">Narratives</div><div class="kpi-value" style="color:var(--cyan)" id="kpi-narratives">--</div><div class="kpi-sub" id="kpi-narr-cat-sub">-- defining</div></div>
    <div class="glass kpi" title="Macro forces driving transformation: Technology, Demographics, Geopolitics, Capital, Psychology, Energy"><div class="kpi-label">Forces</div><div class="kpi-value" style="color:var(--pink)" id="kpi-forces">6</div><div class="kpi-sub" id="kpi-forces-sub">-- accelerating</div></div>
  </div>

  <!-- ═══ VIEW: NARRATIVES ═══ -->
  <div id="view-narratives" class="view-section">
    <div class="controls-bar">
      <input type="text" class="search-box" id="narr-search" placeholder="Search narrative name, sector, force...">
      <select class="sort-select" id="narr-sort">
        <option value="rank">TNS Rank</option>
        <option value="tns-desc">TNS Score (high)</option>
        <option value="models-desc">Model Count (high)</option>
        <option value="name">Name A-Z</option>
      </select>
    </div>
    <div id="narr-cat-filters" class="filter-bar" style="margin-bottom:16px;display:flex;gap:6px;flex-wrap:wrap"></div>
    <div id="narr-results-info" style="font-size:11px;color:var(--dim);margin-bottom:12px"></div>
    <div id="narr-list-container"></div>
    <div id="narr-detail-panel" class="detail-panel"></div>
  </div>

  <!-- ═══ VIEW: CASCADES ═══ -->
  <div id="view-cascades" class="view-section">
    <div style="margin-bottom:16px">
      <div style="font-size:12px;color:var(--text-secondary);line-height:1.6;max-width:700px">Cascade chains show how one narrative's transformation transmits to another. Arrows indicate direction of economic transmission.</div>
    </div>
    <div id="cascade-graph-container"></div>
    <div id="cascade-list-container"></div>
  </div>

  <!-- ═══ VIEW: MODELS ═══ -->
  <div id="view-models" class="view-section active">
    <!-- What's New -->
    <div class="glass whats-new" id="whats-new"></div>

    <!-- Controls -->
    <div class="controls-bar">
      <input type="text" class="search-box" id="model-search" placeholder="Search name, ID, NAICS, architecture...">
      <select class="sort-select" id="model-sort">
        <option value="rank">Rank (Transformation)</option>
        <option value="composite-desc">T-Score (high)</option>
        <option value="composite-asc">T-Score (low)</option>
        <option value="opp-rank">Opportunity Rank</option>
        <option value="opp-desc">Opportunity (high)</option>
        <option value="opp-asc">Opportunity (low)</option>
        <option value="actionable">Triple Actionable (T&times;O&times;VCR)</option>
        <option value="sn">SN (Structural)</option>
        <option value="fa">FA (Force Alignment)</option>
        <option value="ec">EC (Econ Capture)</option>
        <option value="tg">TG (Timing)</option>
        <option value="ce">CE (Competitive)</option>
        <option value="name">Name A-Z</option>
        <option value="vcr-rank">VCR Rank</option>
        <option value="vcr-desc">VCR Score (high)</option>
        <option value="roi-desc">ROI Multiple (high)</option>
        <option value="narrative">Group by Narrative</option>
      </select>
      <select class="sort-select" id="narr-filter" style="max-width:200px">
        <option value="">All Narratives</option>
      </select>
      <button class="toggle-btn" id="new-only-btn" onclick="toggleNewOnly()">NEW only</button>
      <div class="conviction-toggle" title="Filter by conviction level: Confirmed = high-conviction categories, What-If = conditional/parked/catalyst">
        <button class="active" data-conviction="all" onclick="setConvictionFilter('all', this)">All</button>
        <button data-conviction="confirmed" onclick="setConvictionFilter('confirmed', this)">Confirmed</button>
        <button data-conviction="what-if" onclick="setConvictionFilter('what-if', this)">What-If</button>
      </div>
      <div class="view-toggle">
        <button class="active" data-mode="table" onclick="setViewMode('table', this)">Table</button>
        <button data-mode="cards" onclick="setViewMode('cards', this)">Cards</button>
      </div>
    </div>

    <!-- Transformation Category Filters -->
    <div style="font-size:9px;color:var(--dim);text-transform:uppercase;letter-spacing:1px;font-weight:600;margin-bottom:4px" title="Filter by T-Score pattern category (multi-label tags based on axis thresholds)">Transformation Category</div>
    <div class="filter-chips" id="cat-filters"></div>
    <div style="height:6px"></div>
    <!-- Opportunity Category Filters -->
    <div style="font-size:9px;color:var(--dim);text-transform:uppercase;letter-spacing:1px;font-weight:600;margin-bottom:4px" title="Filter by CLA composite threshold (WIDE_OPEN ≥75 → LOCKED <30)">Opportunity Category (CLA)</div>
    <div class="filter-chips" id="opp-cat-filters"></div>
    <div style="height:6px"></div>
    <!-- Confidence + Force Filters -->
    <div style="font-size:9px;color:var(--dim);text-transform:uppercase;letter-spacing:1px;font-weight:600;margin-bottom:4px" title="Filter by evidence quality tier — HIGH=deep dive, MODERATE=systematic, LOW=directional">Confidence Tier</div>
    <div class="filter-chips" id="confidence-filters"></div>
    <div style="height:6px"></div>
    <div style="font-size:9px;color:var(--dim);text-transform:uppercase;letter-spacing:1px;font-weight:600;margin-bottom:4px" title="Filter by driving macro force (F1=Technology, F2=Demographics, F3=Geopolitics, F4=Capital, F5=Psychology, F6=Energy)">Driving Force</div>
    <div class="filter-chips" id="force-filters"></div>
    <div style="height:6px"></div>
    <div style="font-size:9px;color:var(--dim);text-transform:uppercase;letter-spacing:1px;font-weight:600;margin-bottom:4px" title="Filter FORCE_RIDER models by structural sub-type">Force Rider Sub-Type</div>
    <div class="filter-chips" id="fr-subtype-filters"></div>
    <div style="height:8px"></div>

    <!-- Results info -->
    <div class="results-info" id="results-info"></div>

    <!-- Model List (table or cards) -->
    <div id="model-list-container"></div>

    <!-- Expanded Detail -->
    <div class="glass-static model-detail" id="model-detail-panel"></div>

    <!-- Pagination -->
    <div class="pagination" id="pagination"></div>
  </div>

  <!-- ═══ VIEW: VC ROI ═══ -->
  <div id="view-vcroi" class="view-section">
    <div class="kpi-row" id="vcr-kpi-row">
      <div class="glass kpi" title="Models with VCR composite ≥75 — potential to return an entire fund"><div class="kpi-label">Fund Returners</div><div class="kpi-value" style="color:var(--green)" id="vcr-kpi-fund">--</div><div class="kpi-sub">VCR &ge;75</div></div>
      <div class="glass kpi" title="Average estimated return multiple on a hypothetical $10M seed investment"><div class="kpi-label">Avg ROI Multiple</div><div class="kpi-value" style="color:var(--accent)" id="vcr-kpi-avg-roi">--</div><div class="kpi-sub">on $10M seed</div></div>
      <div class="glass kpi" title="Median ROI multiple — more robust than average (less skewed by outliers)"><div class="kpi-label">Median ROI</div><div class="kpi-value" style="color:var(--blue)" id="vcr-kpi-med-roi">--</div><div class="kpi-sub" id="vcr-kpi-med-sub">median multiple</div></div>
      <div class="glass kpi" title="Models estimated to return at least 10x on a $10M seed"><div class="kpi-label">Above 10x</div><div class="kpi-value" style="color:var(--amber)" id="vcr-kpi-10x">--</div><div class="kpi-sub">models &ge;10x ROI</div></div>
      <div class="glass kpi" title="Models estimated to return at least 50x on a $10M seed — exceptional outcomes"><div class="kpi-label">Above 50x</div><div class="kpi-value" style="color:var(--red)" id="vcr-kpi-50x">--</div><div class="kpi-sub">models &ge;50x ROI</div></div>
      <div class="glass kpi" title="Highest VCR composite score across all models"><div class="kpi-label">Top VCR</div><div class="kpi-value" style="color:var(--green)" id="vcr-kpi-top">--</div><div class="kpi-sub" id="vcr-kpi-top-sub">composite score</div></div>
    </div>

    <div class="controls-bar">
      <input type="text" class="search-box" id="vcr-search" placeholder="Search models...">
      <select class="sort-select" id="vcr-sort">
        <option value="vcr-rank">VCR Rank</option>
        <option value="roi-desc">ROI Multiple (high)</option>
        <option value="vcr-desc">VCR Score (high)</option>
        <option value="tri-score">Triple Actionable</option>
        <option value="mkt">MKT (Market)</option>
        <option value="cap">CAP (Capture)</option>
        <option value="eco">ECO (Economics)</option>
        <option value="vel">VEL (Velocity)</option>
        <option value="moa">MOA (Moat)</option>
      </select>
    </div>

    <div class="filter-chips" id="vcr-cat-filters"></div>
    <div style="height:8px"></div>
    <div class="results-info" id="vcr-results-info"></div>

    <div id="vcr-table-container"></div>

    <div class="pagination" id="vcr-pagination"></div>

    <div class="two-col" style="margin-top:16px">
      <div class="glass-static card">
        <div class="section-label">Architecture ROI Breakdown <span class="count">avg multiples by type</span></div>
        <div id="vcr-arch-breakdown"></div>
      </div>
      <div class="glass-static card">
        <div class="section-label">Top 20 Triple Actionable <span class="count">T &times; O &times; VCR</span></div>
        <div id="vcr-tri-list"></div>
      </div>
    </div>

    <!-- T vs OPP Scatter Plot -->
    <div class="glass-static card" style="margin-top:16px">
      <div class="section-label">Transformation vs Opportunity <span class="count">each dot = 1 model &middot; dot size = VCR score &middot; color = confidence tier &middot; click to expand</span></div>
      <div id="scatter-plot" style="position:relative;width:100%;height:400px;overflow:hidden"></div>
    </div>
  </div>

  <!-- ═══ VIEW: FORCES ═══ -->
  <div id="view-forces" class="view-section">
    <div class="section-label">Force Velocities <span class="count">6 macro forces driving sector transformations &mdash; velocity = rate of change</span></div>
    <div class="force-grid" id="force-grid"></div>

    <!-- Force-Model Distribution -->
    <div class="section-label">Force-Model Distribution <span class="count" id="force-dist-count">how many models each force drives</span></div>
    <div class="glass-static card" style="margin-bottom:16px">
      <div id="force-model-distribution"></div>
    </div>

    <!-- Running Patterns -->
    <div class="section-label">Running Patterns <span class="count" id="patterns-count">confirmed cross-sector patterns observed across multiple cycles</span></div>
    <div class="patterns-grid" id="patterns-grid"></div>

    <!-- Key Findings -->
    <div class="section-label">Key Findings <span class="count" id="findings-count">0</span></div>
    <div class="findings-grid" id="findings-grid"></div>
  </div>

  <!-- ═══ VIEW: SECTORS ═══ -->
  <div id="view-sectors" class="view-section">
    <div class="section-label">Sector Transformations <span class="count">employment projections 2026&rarr;2031</span></div>
    <div class="glass-static card">
      <table class="sector-table" id="sector-table">
        <thead><tr><th>Sector</th><th>Phase</th><th>2026</th><th>2031</th><th>Change</th><th>Top Model</th></tr></thead>
        <tbody id="sector-body"></tbody>
      </table>
    </div>
  </div>

  <!-- ═══ VIEW: REGIONS ═══ -->
  <div id="view-regions" class="view-section">
    <div class="section-label">Global Transformation Map <span class="count">8 regions</span></div>
    <div class="glass-static world-map-container">
      <div class="map-grid"></div>
      <div class="map-regions" id="map-regions"></div>
    </div>
    <div class="glass-static region-detail" id="region-detail"></div>
  </div>

  <!-- ═══ VIEW: FEAR ═══ -->
  <div id="view-fear" class="view-section">
    <div class="two-col">
      <div class="glass-static card">
        <div class="section-label">Fear Friction Index <span class="count">gap between economic readiness (tech exists) and psychological readiness (people accept it)</span></div>
        <div class="friction-grid" id="friction-grid"></div>
        <div class="friction-legend">
          <div class="friction-legend-item"><div class="friction-legend-dot" style="background:rgba(52,211,153,0.4)"></div>Economic readiness (1-10)</div>
          <div class="friction-legend-item"><div class="friction-legend-dot" style="background:rgba(248,113,113,0.5)"></div>Psychological readiness (1-10)</div>
          <div class="friction-legend-item">Gap = friction</div>
        </div>
      </div>
      <div class="glass-static card">
        <div class="section-label">Fear-Driven Markets <span class="count">new categories</span></div>
        <table class="markets-table"><thead><tr><th>Category</th><th>2025</th><th>Projected</th><th>CAGR</th></tr></thead><tbody id="markets-body"></tbody></table>
      </div>
    </div>
    <div class="section-label">Worker Displacement Signals</div>
    <div class="displacement-grid" id="displacement-grid"></div>
  </div>

  <!-- ═══ VIEW: CATALYST WATCH ═══ -->
  <div id="view-catalyst" class="view-section">
    <div class="section-label">Catalyst Watch <span class="count">asymmetric upside opportunities with domain-specific triggers</span></div>
    <div class="kpi-row" id="catalyst-kpis"></div>
    <div id="catalyst-clusters"></div>
  </div>

  <!-- ═══ VIEW: TIMELINE ═══ -->
  <div id="view-timeline" class="view-section">
    <div class="section-label">Timing Wave Analysis <span class="count">entry cohorts mapped to Perez cycle phases (2026&ndash;2031)</span></div>
    <div class="kpi-row" id="timeline-kpis"></div>
    <div class="glass-static card" style="margin-bottom:16px">
      <div style="font-size:10px;color:var(--dim);font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px">Entry Cohorts by TG Score</div>
      <div id="timeline-wave"></div>
    </div>
    <div class="glass-static card" style="margin-bottom:16px">
      <div style="font-size:10px;color:var(--dim);font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Perez Cycle Overlay</div>
      <div style="font-size:11px;color:var(--text-secondary);line-height:1.6;margin-bottom:12px">Carlota Perez technological revolution framework applied to AI. Current position: late Installation / early Turning Point (2026). After the turning point, broad deployment (Synergy) begins.</div>
      <div id="perez-wave" style="display:flex;gap:2px;height:40px;border-radius:var(--radius-xs);overflow:hidden">
        <div style="flex:2;background:rgba(248,113,113,0.15);display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;color:var(--red)">INSTALLATION<br>2020&ndash;2026</div>
        <div style="flex:1;background:rgba(251,191,36,0.2);display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;color:var(--amber)">TURNING POINT<br>2026&ndash;2028</div>
        <div style="flex:3;background:rgba(52,211,153,0.12);display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;color:var(--green)">DEPLOYMENT / SYNERGY<br>2028&ndash;2035</div>
      </div>
    </div>
    <div class="two-col">
      <div class="glass-static card">
        <div style="font-size:10px;color:var(--dim);font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Ready Now (TG 8&ndash;9) &mdash; 2026 entry</div>
        <div id="cohort-now" style="font-size:11px;color:var(--text-secondary);line-height:1.8"></div>
      </div>
      <div class="glass-static card">
        <div style="font-size:10px;color:var(--dim);font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Building Phase (TG 6&ndash;7) &mdash; 2027&ndash;28 entry</div>
        <div id="cohort-build" style="font-size:11px;color:var(--text-secondary);line-height:1.8"></div>
      </div>
    </div>
  </div>

  <!-- ═══ VIEW: DATA ═══ -->
  <div id="view-data" class="view-section">
    <div class="two-col">
      <div class="glass-static card">
        <div class="section-label">Sentiment Trajectory <span class="count">2026 &rarr; 2031</span></div>
        <div class="trajectory-grid" id="trajectory-grid"></div>
      </div>
      <div class="glass-static card">
        <div class="section-label">Perez Cycle Position</div>
        <div class="perez-timeline" id="perez-timeline"></div>
        <div style="margin-top:16px"><div class="section-label" style="font-size:10px;margin-bottom:8px;">Turning Point Signals</div><div id="perez-signals"></div></div>
      </div>
    </div>
    <div class="glass-static card">
      <div class="section-label">Defense &amp; Sovereign AI Spending</div>
      <div class="defense-grid" id="defense-grid"></div>
    </div>
    <div class="glass-static card" id="evidence-section">
      <div class="expandable-header" onclick="toggleSection('evidence-section')">
        <div class="section-label" style="margin-bottom:0;">Model Inventory Sources <span class="count" id="inventory-count"></span></div>
        <span class="expand-icon">&#x25BC;</span>
      </div>
      <div class="expandable-content"><div style="height:12px"></div><div id="evidence-list"></div></div>
    </div>
    <div class="glass-static card">
      <div class="section-label">Engine Evolution <span class="count" id="cycle-count">0</span></div>
      <div class="cycle-chart" id="cycle-chart"></div>
      <div style="height:24px"></div>
    </div>
    <div class="glass-static card" style="margin-top:16px">
      <div class="section-label">Research Priority Queue <span class="count" id="rpq-count">high T-rank + low confidence &mdash; prioritized for deeper research</span></div>
      <div id="research-priority-queue" style="font-size:11px"></div>
    </div>
  </div>

  <!-- ═══ VIEW: GLOSSARY ═══ -->
  <div id="view-glossary" class="view-section">
    <div class="glossary-intro">
      This engine projects <strong>what the economy becomes</strong> over 2026&ndash;2031. <strong>v4.1</strong> ranks <strong>685 business models</strong> on 3 independent axes (Transformation, Opportunity, VC ROI). Models are the primary deliverable. <strong>Transformation Narratives</strong> provide organizational context &mdash; force-driven stories of how sectors restructure, explaining WHY models exist and HOW forces create opportunities. Forces drive collisions, collisions drive narratives, narratives organize models.
    </div>

    <!-- TNS System (v4) -->
    <div class="glass-static card glossary-section">
      <h3>Transformation Narrative Score (TNS) &mdash; v4 Primary Ranking</h3>
      <p style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;line-height:1.6">Each transformation narrative is scored on 5 axes measuring how important and inevitable the transformation is. This replaces the T-score as the primary ranking unit. Categories: DEFINING (&ge;80), MAJOR (&ge;65), MODERATE (&ge;50), EMERGING (&ge;35), SPECULATIVE (&lt;35).</p>
      <table class="glossary-table">
        <thead><tr><th style="width:50px">Axis</th><th style="width:180px">Full Name</th><th>Weight</th><th>What It Measures</th></tr></thead>
        <tbody>
          <tr><td class="glossary-abbr" style="color:var(--green)">EM</td><td class="glossary-full">Economic Magnitude</td><td>25%</td><td class="glossary-desc">How large is the GDP/employment impact? Sector share of the total economy.</td></tr>
          <tr><td class="glossary-abbr" style="color:var(--blue)">FC</td><td class="glossary-full">Force Convergence</td><td>25%</td><td class="glossary-desc">How many of the 6 macro forces drive this transformation, and how aligned are they?</td></tr>
          <tr><td class="glossary-abbr" style="color:var(--amber)">ES</td><td class="glossary-full">Evidence Strength</td><td>20%</td><td class="glossary-desc">How much hard data (models, signals, deep dives) confirms the direction?</td></tr>
          <tr><td class="glossary-abbr" style="color:var(--cyan)">TC</td><td class="glossary-full">Timing Confidence</td><td>15%</td><td class="glossary-desc">How confident are we in the timeline? Based on transformation phase.</td></tr>
          <tr><td class="glossary-abbr" style="color:var(--accent)">IR</td><td class="glossary-full">Irreversibility</td><td>15%</td><td class="glossary-desc">Once started, can this transformation be reversed? Demographic lock-in, sunk capital.</td></tr>
        </tbody>
      </table>
      <p style="font-size:11px;color:var(--dim);margin-top:8px">Composite: (EM&times;25 + FC&times;25 + ES&times;20 + TC&times;15 + IR&times;15) / 10 &rarr; 0&ndash;100</p>
    </div>

    <!-- v4 Architecture -->
    <div class="glass-static card glossary-section">
      <h3>v4 Data Architecture</h3>
      <p style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;line-height:1.6">v4 structures data as a DAG (directed acyclic graph):</p>
      <table class="glossary-table">
        <thead><tr><th>Entity</th><th>Description</th><th>Count</th></tr></thead>
        <tbody>
          <tr><td class="glossary-full">Force Velocities</td><td class="glossary-desc">6 macro forces (Technology, Demographics, Geopolitics, Capital, Psychology, Energy) with velocity tracking</td><td>6</td></tr>
          <tr><td class="glossary-full">Force Collisions</td><td class="glossary-desc">Where 2+ forces intersect to create transformation pressure. Types: amplifying, opposing, sequential, conditional</td><td>66</td></tr>
          <tr><td class="glossary-full">Transformation Narratives</td><td class="glossary-desc">The primary ranking unit. Force-driven stories with year-by-year projections, geographic variation, and three model buckets (what works, what's needed, what dies)</td><td>15</td></tr>
          <tr><td class="glossary-full">Business Models</td><td class="glossary-desc">Individual venture-scale opportunities within narratives. Scored on T + CLA + VCR axes</td><td>685</td></tr>
          <tr><td class="glossary-full">Cascade Chains</td><td class="glossary-desc">Narrative-to-narrative dependencies showing economic transmission paths</td><td>3</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Triple Ranking System (Model-level) -->
    <div class="glass-static card glossary-section">
      <h3>Model-Level Triple Ranking</h3>
      <p style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;line-height:1.6">Every model is independently ranked on three dimensions. These are never merged into a single number &mdash; a model can score high on transformation likelihood but low on investability, or vice versa.</p>
      <table class="glossary-table">
        <thead><tr><th>Dimension</th><th>Question It Answers</th><th>Composite Formula</th></tr></thead>
        <tbody>
          <tr>
            <td class="glossary-full">T-Score (Transformation)</td>
            <td class="glossary-desc">Will this transformation actually happen? Measures structural necessity, force alignment, economic viability, timing, and competitive dynamics.</td>
            <td><span class="glossary-formula">(SN&times;25 + FA&times;25 + EC&times;20 + TG&times;15 + CE&times;15) / 10</span></td>
          </tr>
          <tr>
            <td class="glossary-full">O-Score (Opportunity / CLA)</td>
            <td class="glossary-desc">Can a new entrant actually play this? Measures whether the market is open to startups vs locked by incumbents. CLA = Competitive Landscape Assessment.</td>
            <td><span class="glossary-formula">(MO&times;30 + MA&times;25 + VD&times;20 + DV&times;25) / 10</span></td>
          </tr>
          <tr>
            <td class="glossary-full">VCR Score (VC ROI)</td>
            <td class="glossary-desc">Is this a good seed-stage investment? Estimates return potential on a $10M seed round, considering market size, capture rate, unit economics, revenue velocity, and moat trajectory.</td>
            <td><span class="glossary-formula">(MKT&times;25 + CAP&times;25 + ECO&times;20 + VEL&times;15 + MOA&times;15) / 10</span></td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- T-Score Axes -->
    <div class="glass-static card glossary-section">
      <h3>Transformation Axes (T-Score)</h3>
      <p style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;line-height:1.6">Each axis is scored 1&ndash;10. These measure whether a sector transformation is real, not whether it's a good business.</p>
      <table class="glossary-table">
        <thead><tr><th style="width:50px">Axis</th><th style="width:160px">Full Name</th><th>Weight</th><th>What It Measures</th></tr></thead>
        <tbody>
          <tr><td class="glossary-abbr" style="color:var(--green)">SN</td><td class="glossary-full">Structural Necessity</td><td>25%</td><td class="glossary-desc">Is this transformation structurally inevitable? Would it happen even without AI? Driven by labor shortages, demographic shifts, regulatory mandates, physical constraints.</td></tr>
          <tr><td class="glossary-abbr" style="color:var(--blue)">FA</td><td class="glossary-full">Force Alignment</td><td>25%</td><td class="glossary-desc">How many of the 6 macro forces (F1&ndash;F6) accelerate this transformation? Multi-force convergence = higher inevitability. A model driven by technology + demographics + energy scores higher than one driven by technology alone.</td></tr>
          <tr><td class="glossary-abbr" style="color:var(--amber)">EC</td><td class="glossary-full">Economic Capture</td><td>20%</td><td class="glossary-desc">How much economic value shifts when this transformation occurs? Measures the size and speed of value migration &mdash; revenue pools that move from incumbents to new entrants.</td></tr>
          <tr><td class="glossary-abbr" style="color:var(--cyan)">TG</td><td class="glossary-full">Timing &amp; Geography</td><td>15%</td><td class="glossary-desc">Is the timing right (2026&ndash;2028 window)? Are geographic conditions favorable? Higher = happening now in favorable jurisdictions. Lower = distant or geographically constrained.</td></tr>
          <tr><td class="glossary-abbr" style="color:var(--accent)">CE</td><td class="glossary-full">Competitive Edge</td><td>15%</td><td class="glossary-desc">Can a new entrant build durable competitive advantage? Measures data moats, network effects, switching costs, regulatory capture. NOT about current competition &mdash; about future defensibility.</td></tr>
        </tbody>
      </table>
    </div>

    <!-- CLA Axes -->
    <div class="glass-static card glossary-section">
      <h3>Opportunity Axes (CLA &mdash; Competitive Landscape Assessment)</h3>
      <p style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;line-height:1.6">Independent from T-score. A transformation may be certain (high T) but the market may be locked by incumbents (low O). Or vice versa &mdash; wide open market for a transformation that may not happen.</p>
      <table class="glossary-table">
        <thead><tr><th style="width:50px">Axis</th><th style="width:160px">Full Name</th><th>Weight</th><th>What It Measures</th></tr></thead>
        <tbody>
          <tr><td class="glossary-abbr" style="color:var(--green)">MO</td><td class="glossary-full">Market Openness</td><td>30%</td><td class="glossary-desc">How fragmented is the market? Are incumbents weak, distracted, or absent? High MO = many small players, no dominant platform, greenfield opportunity. Low MO = concentrated market with strong incumbents.</td></tr>
          <tr><td class="glossary-abbr" style="color:var(--amber)">MA</td><td class="glossary-full">Moat Accessibility</td><td>25%</td><td class="glossary-desc">How fragile are existing moats? Can a new entrant break through incumbent defenses? High MA = incumbent moats are eroding (regulations changing, technology shifting). Low MA = deep moats (capital requirements, regulatory capture, network effects).</td></tr>
          <tr><td class="glossary-abbr" style="color:var(--cyan)">VD</td><td class="glossary-full">Value Chain Depth</td><td>20%</td><td class="glossary-desc">How many independent value chain layers exist? More layers = more entry points for startups. Healthcare (12+ layers) scores higher than simple SaaS (3 layers). Each layer is a potential wedge.</td></tr>
          <tr><td class="glossary-abbr" style="color:var(--accent)">DV</td><td class="glossary-full">Demand Visibility</td><td>25%</td><td class="glossary-desc">How visible and proven is customer demand? High DV = customers actively seeking solutions, budget allocated, pain point acknowledged. Low DV = latent demand, requires market education.</td></tr>
        </tbody>
      </table>
    </div>

    <!-- VCR Axes -->
    <div class="glass-static card glossary-section">
      <h3>VC ROI Axes (VCR &mdash; Venture Capital Return)</h3>
      <p style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;line-height:1.6">Models the return on a hypothetical $10M seed investment. Independent of both T and O &mdash; a transformation may be certain and open, but still a poor VC bet (e.g., thin margins, slow revenue velocity).</p>
      <table class="glossary-table">
        <thead><tr><th style="width:50px">Axis</th><th style="width:160px">Full Name</th><th>Weight</th><th>What It Measures</th></tr></thead>
        <tbody>
          <tr><td class="glossary-abbr" style="color:var(--green)">MKT</td><td class="glossary-full">Market Magnitude</td><td>25%</td><td class="glossary-desc">Total addressable market size. Uses log-scale scoring with sector-specific addressable percentages (4-digit NAICS = 1% of sector TAM, 2-digit = 0.15%). Larger TAM = larger potential exit.</td></tr>
          <tr><td class="glossary-abbr" style="color:var(--blue)">CAP</td><td class="glossary-full">Capture Feasibility</td><td>25%</td><td class="glossary-desc">Can a startup realistically capture meaningful market share? Considers competitive density, market fragmentation, go-to-market difficulty. High = fragmented market easy to penetrate. Low = concentrated market with strong defenders.</td></tr>
          <tr><td class="glossary-abbr" style="color:var(--amber)">ECO</td><td class="glossary-full">Unit Economics</td><td>20%</td><td class="glossary-desc">Quality of the business model's economics: gross margins, customer retention, LTV/CAC ratio, revenue per employee scalability. SaaS models score high. Hardware and capital-intensive models score low.</td></tr>
          <tr><td class="glossary-abbr" style="color:var(--cyan)">VEL</td><td class="glossary-full">Revenue Velocity</td><td>15%</td><td class="glossary-desc">How fast can a startup go from $0 to $5M ARR? Measures sales cycle length, deal size, customer acquisition speed. SMB SaaS = fast velocity. Enterprise hardware = very slow velocity.</td></tr>
          <tr><td class="glossary-abbr" style="color:var(--accent)">MOA</td><td class="glossary-full">Moat Trajectory</td><td>15%</td><td class="glossary-desc">Will competitive advantage grow or erode over time? Data flywheels, network effects, and regulatory capture create growing moats. Commodity services and time-limited arbitrage have eroding moats.</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Category Labels -->
    <div class="two-col">
      <div class="glass-static card glossary-section">
        <h3>Transformation Categories</h3>
        <p style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;line-height:1.6">Multi-label tags assigned based on T-score axis patterns. A model can have multiple categories.</p>
        <table class="glossary-table">
          <thead><tr><th>Category</th><th>Criteria</th></tr></thead>
          <tbody>
            <tr><td><span class="glossary-badge cat-badge cat-STRUCTURAL_WINNER">Structural Winner</span></td><td class="glossary-desc">SN &ge; 8 AND FA &ge; 8. The transformation is structurally inevitable AND force-aligned. Highest conviction.</td></tr>
            <tr><td><span class="glossary-badge cat-badge cat-FORCE_RIDER">Force Rider</span></td><td class="glossary-desc">FA &ge; 7 (but not Structural Winner). Riding strong macro forces but less structurally locked-in.</td></tr>
            <tr><td><span class="glossary-badge cat-badge cat-TIMING_ARBITRAGE">Timing Arbitrage</span></td><td class="glossary-desc">TG &ge; 8 AND SN &ge; 6. The window is open NOW. Time-sensitive opportunity.</td></tr>
            <tr><td><span class="glossary-badge cat-badge cat-CAPITAL_MOAT">Capital Moat</span></td><td class="glossary-desc">CE &ge; 8 AND SN &ge; 6. Strong competitive defensibility with structural backing.</td></tr>
            <tr><td><span class="glossary-badge cat-badge cat-FEAR_ECONOMY">Fear Economy</span></td><td class="glossary-desc">Tagged with F5 (Psychology/Fear). Opportunity driven by fear, trust gaps, or institutional anxiety.</td></tr>
            <tr><td><span class="glossary-badge cat-badge cat-CONDITIONAL">Conditional</span></td><td class="glossary-desc">T-composite &ge; 60 but doesn't match any specific pattern. Viable but not distinctive.</td></tr>
            <tr><td><span class="glossary-badge cat-badge cat-PARKED">Parked</span></td><td class="glossary-desc">T-composite &lt; 60 or otherwise low conviction. Not abandoned &mdash; may re-score higher with new evidence.</td></tr>
          </tbody>
        </table>
      </div>

      <div class="glass-static card glossary-section">
        <h3>Opportunity &amp; VCR Categories</h3>
        <table class="glossary-table">
          <thead><tr><th colspan="2">Opportunity (CLA composite thresholds)</th></tr></thead>
          <tbody>
            <tr><td><span class="glossary-badge cat-badge opp-WIDE_OPEN">Wide Open</span></td><td class="glossary-desc">&ge; 75. No significant incumbent barriers. Land grab.</td></tr>
            <tr><td><span class="glossary-badge cat-badge opp-ACCESSIBLE">Accessible</span></td><td class="glossary-desc">&ge; 60. Manageable competition. Good startup entry point.</td></tr>
            <tr><td><span class="glossary-badge cat-badge opp-CONTESTED">Contested</span></td><td class="glossary-desc">&ge; 45. Meaningful competition. Requires differentiation.</td></tr>
            <tr><td><span class="glossary-badge cat-badge opp-FORTIFIED">Fortified</span></td><td class="glossary-desc">&ge; 30. Strong incumbent moats. Hard entry.</td></tr>
            <tr><td><span class="glossary-badge cat-badge opp-LOCKED">Locked</span></td><td class="glossary-desc">&lt; 30. Market effectively closed to new entrants.</td></tr>
          </tbody>
        </table>
        <div style="height:16px"></div>
        <table class="glossary-table">
          <thead><tr><th colspan="2">VCR (VC ROI composite thresholds)</th></tr></thead>
          <tbody>
            <tr><td><span class="glossary-badge cat-badge vcr-FUND_RETURNER">Fund Returner</span></td><td class="glossary-desc">&ge; 75. Potential to return an entire fund. Top-tier VC bet.</td></tr>
            <tr><td><span class="glossary-badge cat-badge vcr-STRONG_MULTIPLE">Strong Multiple</span></td><td class="glossary-desc">&ge; 60. Solid 10&ndash;50x return potential. Good investment.</td></tr>
            <tr><td><span class="glossary-badge cat-badge vcr-VIABLE_RETURN">Viable Return</span></td><td class="glossary-desc">&ge; 45. Modest returns. May work for specific thesis.</td></tr>
            <tr><td><span class="glossary-badge cat-badge vcr-MARGINAL">Marginal</span></td><td class="glossary-desc">&ge; 30. Unlikely to meet typical VC return thresholds.</td></tr>
            <tr><td><span class="glossary-badge cat-badge vcr-VC_POOR">VC Poor</span></td><td class="glossary-desc">&lt; 30. Not a VC-fundable model (may be viable as bootstrapped/PE).</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Forces -->
    <div class="glass-static card glossary-section">
      <h3>The 6 Macro Forces (F1&ndash;F6)</h3>
      <p style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;line-height:1.6">Every sector transformation is driven by one or more macro forces. Force convergence (multiple forces hitting the same sector) dramatically increases transformation probability and speed. Each model is tagged with its driving forces.</p>
      <table class="glossary-table">
        <thead><tr><th style="width:50px">Code</th><th style="width:140px">Force</th><th>Description</th><th style="width:100px">Example</th></tr></thead>
        <tbody>
          <tr><td class="glossary-abbr">F1</td><td class="glossary-full">Technology</td><td class="glossary-desc">AI capability improvements, inference cost declines, foundation model advances, robotics, computer vision. The primary accelerant.</td><td style="font-size:11px;color:var(--dim)">GPT-5, cost/token</td></tr>
          <tr><td class="glossary-abbr">F2</td><td class="glossary-full">Demographics</td><td class="glossary-desc">Aging workforce, labor shortages, retirement waves, immigration policy, skill gaps. Creates STRUCTURAL necessity for automation.</td><td style="font-size:11px;color:var(--dim)">Silver tsunami, H-2A</td></tr>
          <tr><td class="glossary-abbr">F3</td><td class="glossary-full">Geopolitics</td><td class="glossary-desc">Trade policy, reshoring mandates, defense spending, sanctions, sovereignty concerns. Shapes WHERE transformation happens.</td><td style="font-size:11px;color:var(--dim)">Tariffs, CHIPS Act</td></tr>
          <tr><td class="glossary-abbr">F4</td><td class="glossary-full">Capital</td><td class="glossary-desc">Interest rates, VC funding, PE consolidation, credit conditions, valuation dynamics. Determines WHAT gets funded and when.</td><td style="font-size:11px;color:var(--dim)">Rate cuts, PE rollups</td></tr>
          <tr><td class="glossary-abbr">F5</td><td class="glossary-full">Psychology</td><td class="glossary-desc">Fear of AI displacement, institutional trust erosion, deepfake anxiety, privacy concerns, change resistance. Creates both demand (safety products) and friction (adoption delays).</td><td style="font-size:11px;color:var(--dim)">AI anxiety, deepfakes</td></tr>
          <tr><td class="glossary-abbr">F6</td><td class="glossary-full">Energy</td><td class="glossary-desc">Grid constraints, data center power demand, renewable transition, battery costs, carbon policy. Physical constraint on AI scaling.</td><td style="font-size:11px;color:var(--dim)">Grid capacity, solar</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Architecture Types -->
    <div class="glass-static card glossary-section">
      <h3>Architecture Types</h3>
      <p style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;line-height:1.6">Each model uses one of 18 canonical business architectures. Architecture strongly predicts unit economics (ECO) and moat trajectory (MOA). Normalized from 54+ original variants into 18 canonical types.</p>
      <table class="glossary-table">
        <thead><tr><th>Architecture</th><th>What It Means</th><th style="width:80px">Economics</th></tr></thead>
        <tbody>
          <tr><td class="glossary-full">vertical_saas</td><td class="glossary-desc">Specialized SaaS for a specific industry vertical. Embedding AI into core workflows &mdash; scheduling, billing, compliance, decision support.</td><td style="font-size:11px;color:var(--green)">High margins</td></tr>
          <tr><td class="glossary-full">full_service_replacement</td><td class="glossary-desc">End-to-end AI platform replacing traditional operations entirely. From client intake through delivery. Maximum disruption, maximum execution risk.</td><td style="font-size:11px;color:var(--amber)">Mixed</td></tr>
          <tr><td class="glossary-full">platform_infrastructure</td><td class="glossary-desc">Infrastructure layer &mdash; APIs, data pipelines, integration middleware. Enables others to build. Lower margin per customer but massive scale potential.</td><td style="font-size:11px;color:var(--amber)">Scale-dependent</td></tr>
          <tr><td class="glossary-full">data_compounding</td><td class="glossary-desc">Data flywheel: product improves with every transaction. Proprietary datasets that compound over time. Strongest moat trajectory of any architecture.</td><td style="font-size:11px;color:var(--green)">Improving</td></tr>
          <tr><td class="glossary-full">acquire_and_modernize</td><td class="glossary-desc">Buy fragmented businesses at 3&ndash;5x EBITDA, modernize with AI, scale via roll-up. Capital-intensive but proven playbook.</td><td style="font-size:11px;color:var(--red)">Capital heavy</td></tr>
          <tr><td class="glossary-full">marketplace_network</td><td class="glossary-desc">Two-sided marketplace with AI-driven matching, pricing, quality assurance. Cold start problem but strong network effects once established.</td><td style="font-size:11px;color:var(--amber)">Network-dependent</td></tr>
          <tr><td class="glossary-full">rollup_consolidation</td><td class="glossary-desc">Consolidate fragmented operators under shared AI infrastructure and back-office. Similar to acquire_and_modernize but more operators, less tech.</td><td style="font-size:11px;color:var(--red)">Capital heavy</td></tr>
          <tr><td class="glossary-full">ai_copilot</td><td class="glossary-desc">Augments professional judgment with AI. Real-time analysis, recommendations, automated documentation. Human stays in the loop.</td><td style="font-size:11px;color:var(--green)">High margins</td></tr>
          <tr><td class="glossary-full">regulatory_moat_builder</td><td class="glossary-desc">Turns regulatory complexity into competitive advantage. Compliance monitoring, audit trails, automated reporting. Moat grows with regulation.</td><td style="font-size:11px;color:var(--amber)">Moderate</td></tr>
          <tr><td class="glossary-full">hardware_ai</td><td class="glossary-desc">Purpose-built hardware + software. Specialized sensors, edge compute, AI models optimized for physical environments. Slow to deploy, hard to displace.</td><td style="font-size:11px;color:var(--red)">High capex</td></tr>
          <tr><td class="glossary-full">robotics_automation</td><td class="glossary-desc">Autonomous robotics &mdash; mobile manipulation, computer vision, fleet coordination. Replacing manual labor at scale. Very slow deployment velocity.</td><td style="font-size:11px;color:var(--red)">Very high capex</td></tr>
          <tr><td class="glossary-full">arbitrage_window</td><td class="glossary-desc">Time-limited opportunity exploiting the gap between AI capability arrival and incumbent adoption. Narrow entry window &mdash; high urgency, weak long-term moat.</td><td style="font-size:11px;color:var(--green)">Fast returns</td></tr>
          <tr><td class="glossary-full">compliance_automation</td><td class="glossary-desc">Automated compliance engine &mdash; continuous monitoring, audit trail generation, regulatory filing across jurisdictions.</td><td style="font-size:11px;color:var(--amber)">Moderate</td></tr>
          <tr><td class="glossary-full">service_platform</td><td class="glossary-desc">Managed service blending human expertise with AI augmentation. Delivers outcomes at scale. Lower margins than pure SaaS.</td><td style="font-size:11px;color:var(--amber)">Moderate</td></tr>
          <tr><td class="glossary-full">physical_production_ai</td><td class="glossary-desc">AI-augmented physical production &mdash; computer vision, predictive maintenance, automated quality control on existing manufacturing lines.</td><td style="font-size:11px;color:var(--red)">High capex</td></tr>
          <tr><td class="glossary-full">open_core_ecosystem</td><td class="glossary-desc">Free/open-source product core with capture at hosting, enterprise, and integration layers. Precedent: Red Hat ($34B), Databricks ($43B), MongoDB, Hugging Face.</td><td style="font-size:11px;color:var(--amber)">Mixed (free+enterprise)</td></tr>
          <tr><td class="glossary-full">outcome_based</td><td class="glossary-desc">Revenue from measurable outcomes, not product pricing. Zero upfront, percentage of results. Performance marketing, legal contingency, AI cost-savings contracts.</td><td style="font-size:11px;color:var(--amber)">Variable but aligned</td></tr>
          <tr><td class="glossary-full">coordination_protocol</td><td class="glossary-desc">Thin-margin infrastructure enabling permissionless coordination. Protocol, not platform. Precedent: Stripe (2.9% of internet commerce), HTTP/USB as standards.</td><td style="font-size:11px;color:var(--red)">Thin margin, massive vol</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Confidence + Other -->
    <div class="two-col">
      <div class="glass-static card glossary-section">
        <h3>Confidence Tiers</h3>
        <p style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;line-height:1.6">How much evidence backs each model's scores. Based on source provenance, evidence depth, and analytical rigor.</p>
        <table class="glossary-table">
          <thead><tr><th>Tier</th><th>Meaning</th></tr></thead>
          <tbody>
            <tr><td><span class="glossary-badge confidence-badge conf-HIGH">HIGH</span></td><td class="glossary-desc">Deep-dive analysis with sector context, competitive landscape research, named competitors, TAM estimates, and unit economics evidence. Multiple data sources.</td></tr>
            <tr><td><span class="glossary-badge confidence-badge conf-MODERATE">MODERATE</span></td><td class="glossary-desc">Systematic coverage with structured evidence but not field-verified. Generated from sector patterns and architectural analysis.</td></tr>
            <tr><td><span class="glossary-badge confidence-badge conf-LOW">LOW</span></td><td class="glossary-desc">Early-stage models with limited evidence. Often from initial scanning cycles. Scores are directional, not precise. Priority targets for further research.</td></tr>
          </tbody>
        </table>
      </div>

      <div class="glass-static card glossary-section">
        <h3>Key Concepts</h3>
        <table class="glossary-table">
          <thead><tr><th>Term</th><th>Definition</th></tr></thead>
          <tbody>
            <tr><td class="glossary-full">NAICS</td><td class="glossary-desc">North American Industry Classification System. 2&ndash;6 digit codes identifying economic sectors (e.g., 62 = Healthcare, 5415 = Computer Systems Design). Used to map models to sectors.</td></tr>
            <tr><td class="glossary-full">Triple Actionable</td><td class="glossary-desc">Geometric mean of T &times; O &times; VCR composites. Identifies models that score well on ALL three dimensions &mdash; transformations that are likely, accessible, and investable.</td></tr>
            <tr><td class="glossary-full">Baumol Cost Disease</td><td class="glossary-desc">Sectors where wages rise without productivity gains (healthcare, education, government). AI disruption potential is HIGHEST in high-Baumol sectors. The engine's key finding: Inverse Baumol sectors (construction, agriculture) are the real AI opportunity.</td></tr>
            <tr><td class="glossary-full">Fear Friction Gap</td><td class="glossary-desc">Difference between economic readiness (technology exists) and psychological readiness (people will accept it). Large gap = transformation delayed. Gap is structural data, not noise.</td></tr>
            <tr><td class="glossary-full">Falsification Criteria</td><td class="glossary-desc">Specific, testable conditions that would invalidate a model's projections. Every model lists 2&ndash;4 criteria. If any trigger, the model should be re-scored or retired. Intellectual honesty mechanism.</td></tr>
            <tr><td class="glossary-full">Polanyi Paradox</td><td class="glossary-desc">Tacit knowledge that humans can't articulate (e.g., riding a bike). Sectors with high tacit knowledge are harder to automate. The engine scores automation exposure using O*NET task data.</td></tr>
            <tr><td class="glossary-full">Decomposition</td><td class="glossary-desc">When a parent model scores FORTIFIED/LOCKED, its value chain is decomposed into layers. Individual layers often score differently &mdash; physical layers stay FORTIFIED while software layers are ACCESSIBLE.</td></tr>
            <tr><td class="glossary-full">Perez Cycle</td><td class="glossary-desc">Carlota Perez's technological revolution framework. AI is currently in the &ldquo;Frenzy&rdquo; phase (2022&ndash;26), approaching a &ldquo;Turning Point&rdquo; (2026&ndash;28). After the turning point: broad deployment (&ldquo;Synergy&rdquo;) begins.</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="footer">Research Engine v4.1 &middot; 685 models &middot; T + CLA + VCR scoring &middot; 16 narratives &middot; 2026&ndash;2031</div>
</div>

<script>
const BASE = '../data/ui';
let allModels = [];
let filteredModels = [];
let currentPage = 1;
const PAGE_SIZE = 50;
let viewMode = 'table';
let newOnlyActive = false;
let activeCatFilter = null;
let activeOppFilter = null;
let activeVcrFilter = null;
let activeConfFilter = null;
let activeForceFilter = null;
let activeFrSubtypeFilter = null;
let activeConvictionFilter = 'all';
let activeNarrFilter = '';
const CONFIRMED_CATS = new Set(['STRUCTURAL_WINNER','FORCE_RIDER','TIMING_ARBITRAGE','CAPITAL_MOAT','FEAR_ECONOMY','EMERGING_CATEGORY']);
const WHATIF_CATS = new Set(['CONDITIONAL','PARKED']);
let vcrFilteredModels = [];
let vcrCurrentPage = 1;
let expandedModelId = null;
let allNarratives = [];
let filteredNarratives = [];
let narrativeData = null;
let expandedNarrId = null;
let activeNarrCatFilter = null;

async function load(path) {
  try { const r = await fetch(path + '?t=' + Date.now()); return r.ok ? await r.json() : null; }
  catch { return null; }
}

function getNarrName(nid) {
  const n = allNarratives.find(x => x.narrative_id === nid);
  return n ? n.name : nid;
}

function narrBadgeHtml(m) {
  const ids = m.narrative_ids || [];
  const role = m.narrative_role || '';
  if (!ids.length) return '';
  const roleLabel = role === 'what_works' ? 'W' : role === 'whats_needed' ? 'N' : role === 'what_dies' ? 'D' : '?';
  const roleCls = 'narr-role-' + role;
  const name = getNarrName(ids[0]);
  const short = name.length > 18 ? name.slice(0, 16) + '..' : name;
  return `<span class="narr-badge ${roleCls}" title="${esc(name)} (${role.replace(/_/g, ' ')})">${esc(short)} [${roleLabel}]</span>`;
}

function esc(s) {
  if (!s) return '';
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function toggleSection(id) { document.getElementById(id).classList.toggle('expanded'); }

// ─── NAV ───
document.querySelectorAll('#main-nav a').forEach(a => {
  a.addEventListener('click', function() {
    document.querySelectorAll('#main-nav a').forEach(x => x.classList.remove('active'));
    this.classList.add('active');
    document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
    const target = document.getElementById('view-' + this.dataset.view);
    if (target) target.classList.add('active');
  });
});

// ─── AXIS COLORS ───
const axisColor = {
  SN: 'var(--green)', FA: 'var(--blue)', EC: 'var(--amber)', TG: 'var(--cyan)', CE: 'var(--accent)'
};
const claColor = {
  MO: 'var(--green)', MA: 'var(--amber)', VD: 'var(--cyan)', DV: 'var(--accent)'
};
const vcrColor = {
  MKT: 'var(--green)', CAP: 'var(--blue)', ECO: 'var(--amber)',
  VEL: 'var(--cyan)', MOA: 'var(--accent)'
};

// ─── MODEL CONTROLS ───
document.getElementById('model-search').addEventListener('input', () => { currentPage = 1; applyFilters(); });
document.getElementById('model-sort').addEventListener('change', () => { currentPage = 1; applyFilters(); });
document.getElementById('narr-filter').addEventListener('change', function() { activeNarrFilter = this.value; currentPage = 1; applyFilters(); });
document.getElementById('vcr-search').addEventListener('input', () => { vcrCurrentPage = 1; applyVcrFilters(); });
document.getElementById('vcr-sort').addEventListener('change', () => { vcrCurrentPage = 1; applyVcrFilters(); });

function toggleNewOnly() {
  newOnlyActive = !newOnlyActive;
  document.getElementById('new-only-btn').classList.toggle('active', newOnlyActive);
  currentPage = 1;
  applyFilters();
}

function setViewMode(mode, btn) {
  viewMode = mode;
  document.querySelectorAll('.view-toggle button').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderModelList();
}

function setCatFilter(cat) {
  if (activeCatFilter === cat) { activeCatFilter = null; }
  else { activeCatFilter = cat; }
  document.querySelectorAll('#cat-filters .filter-chip').forEach(c => {
    c.classList.toggle('active', c.dataset.cat === activeCatFilter);
  });
  currentPage = 1;
  applyFilters();
}

function setOppFilter(cat) {
  if (activeOppFilter === cat) { activeOppFilter = null; }
  else { activeOppFilter = cat; }
  document.querySelectorAll('#opp-cat-filters .filter-chip').forEach(c => {
    c.classList.toggle('active', c.dataset.cat === activeOppFilter);
  });
  currentPage = 1;
  applyFilters();
}

function roiClass(r) {
  if (r >= 50) return 'roi-high';
  if (r >= 20) return 'roi-good';
  if (r >= 10) return 'roi-moderate';
  return 'roi-low';
}

function setConfFilter(tier) {
  if (activeConfFilter === tier) { activeConfFilter = null; }
  else { activeConfFilter = tier; }
  document.querySelectorAll('#confidence-filters .filter-chip').forEach(c => {
    c.classList.toggle('active', c.dataset.cat === activeConfFilter);
  });
  currentPage = 1;
  applyFilters();
}

function setForceFilter(force) {
  if (activeForceFilter === force) { activeForceFilter = null; }
  else { activeForceFilter = force; }
  document.querySelectorAll('#force-filters .filter-chip').forEach(c => {
    c.classList.toggle('active', c.dataset.cat === activeForceFilter);
  });
  currentPage = 1;
  applyFilters();
}

function setFrSubtypeFilter(subtype) {
  if (activeFrSubtypeFilter === subtype) { activeFrSubtypeFilter = null; }
  else { activeFrSubtypeFilter = subtype; }
  document.querySelectorAll('#fr-subtype-filters .filter-chip').forEach(c => {
    c.classList.toggle('active', c.dataset.cat === activeFrSubtypeFilter);
  });
  currentPage = 1;
  applyFilters();
}

function setConvictionFilter(level, btn) {
  activeConvictionFilter = level;
  document.querySelectorAll('.conviction-toggle button').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  currentPage = 1;
  applyFilters();
}

function setVcrFilter(cat) {
  if (activeVcrFilter === cat) { activeVcrFilter = null; }
  else { activeVcrFilter = cat; }
  document.querySelectorAll('#vcr-cat-filters .filter-chip').forEach(c => {
    c.classList.toggle('active', c.dataset.cat === activeVcrFilter);
  });
  vcrCurrentPage = 1;
  applyVcrFilters();
}

function applyVcrFilters() {
  const q = document.getElementById('vcr-search').value.toLowerCase().trim();
  const sort = document.getElementById('vcr-sort').value;

  vcrFilteredModels = allModels.filter(m => {
    if (activeVcrFilter && m.vcr_category !== activeVcrFilter) return false;
    if (q) {
      const hay = [m.name, m.id, m.architecture || '', m.vcr_category || ''].join(' ').toLowerCase();
      if (!hay.includes(q)) return false;
    }
    return true;
  });

  const sortFns = {
    'vcr-rank': (a, b) => (a.vcr_rank || 9999) - (b.vcr_rank || 9999),
    'roi-desc': (a, b) => (b.vcr_roi_multiple || 0) - (a.vcr_roi_multiple || 0),
    'vcr-desc': (a, b) => (b.vcr_composite || 0) - (a.vcr_composite || 0),
    'tri-score': (a, b) => {
      const gA = Math.pow((a.composite || 1) * (a.opportunity_composite || 1) * (a.vcr_composite || 1), 1/3);
      const gB = Math.pow((b.composite || 1) * (b.opportunity_composite || 1) * (b.vcr_composite || 1), 1/3);
      return gB - gA;
    },
    'mkt': (a, b) => ((b.vcr_scores || {}).MKT || 0) - ((a.vcr_scores || {}).MKT || 0),
    'cap': (a, b) => ((b.vcr_scores || {}).CAP || 0) - ((a.vcr_scores || {}).CAP || 0),
    'eco': (a, b) => ((b.vcr_scores || {}).ECO || 0) - ((a.vcr_scores || {}).ECO || 0),
    'vel': (a, b) => ((b.vcr_scores || {}).VEL || 0) - ((a.vcr_scores || {}).VEL || 0),
    'moa': (a, b) => ((b.vcr_scores || {}).MOA || 0) - ((a.vcr_scores || {}).MOA || 0),
  };
  if (sortFns[sort]) vcrFilteredModels.sort(sortFns[sort]);

  renderVcrTable();
}

function renderVcrTable() {
  const total = vcrFilteredModels.length;
  const pages = Math.ceil(total / PAGE_SIZE);
  if (vcrCurrentPage > pages) vcrCurrentPage = pages || 1;
  const start = (vcrCurrentPage - 1) * PAGE_SIZE;
  const pageModels = vcrFilteredModels.slice(start, start + PAGE_SIZE);

  document.getElementById('vcr-results-info').textContent = total + ' model' + (total !== 1 ? 's' : '') + (activeVcrFilter ? ' \u2014 ' + activeVcrFilter.replace(/_/g, ' ') : '');

  const container = document.getElementById('vcr-table-container');
  const vcrAxes = ['MKT','CAP','ECO','VEL','MOA'];

  container.innerHTML = '<div class="glass-static" style="overflow-x:auto"><table class="model-table">' +
    '<thead><tr>' +
    '<th title="VC ROI rank">VCR#</th>' +
    '<th>Name</th>' +
    '<th title="VC ROI composite score (0-100)">VCR</th>' +
    '<th title="Estimated return on $10M seed investment">ROI</th>' +
    '<th title="Transformation Score">T-Score</th>' +
    '<th title="Opportunity Score">O-Score</th>' +
    '<th title="VCR category (FUND_RETURNER ≥75, STRONG_MULTIPLE ≥60, VIABLE_RETURN ≥45)">VCR Cat</th>' +
    '<th title="Business architecture type">Arch</th>' +
    '<th title="MKT=Market Size, CAP=Capture, ECO=Economics, VEL=Velocity, MOA=Moat">VCR Axes</th>' +
    '</tr></thead>' +
    '<tbody>' + pageModels.map(m => {
      const vcrComp = m.vcr_composite || 0;
      const vcrCls = vcrComp >= 75 ? 'var(--green)' : vcrComp >= 60 ? 'var(--blue)' : vcrComp >= 45 ? 'var(--amber)' : 'var(--red)';
      const roi = m.vcr_roi_multiple || 0;
      const roiStr = roi >= 100 ? Math.round(roi) + 'x' : roi.toFixed(1) + 'x';
      const vcrCat = m.vcr_category || 'VIABLE_RETURN';
      const catCls = 'vcr-' + vcrCat;
      const subBadge = m.parent_id ? '<span class="sub-badge">SUB</span>' : '';
      const axes = vcrAxes.map(a => {
        const v = (m.vcr_scores || {})[a] || 0;
        const pct = (v / 10) * 100;
        return '<div class="axis-bar"><div class="axis-bar-label">' + a + '</div><div class="axis-bar-track"><div class="axis-bar-fill" style="width:' + pct + '%;background:' + vcrColor[a] + '"></div></div><div class="axis-bar-val">' + v.toFixed(1) + '</div></div>';
      }).join('');
      return '<tr onclick="toggleModelDetail(\'' + esc(m.id) + '\')">' +
        '<td class="rank-cell">' + (m.vcr_rank || '--') + '</td>' +
        '<td class="name-cell">' + esc(m.name) + subBadge + narrBadgeHtml(m) + '</td>' +
        '<td class="composite-cell" style="color:' + vcrCls + '">' + vcrComp.toFixed(1) + '</td>' +
        '<td class="opp-cell roi-value ' + roiClass(roi) + '">' + roiStr + '</td>' +
        '<td style="font-size:12px;color:var(--text-secondary)">' + m.composite.toFixed(1) + '</td>' +
        '<td style="font-size:12px;color:var(--text-secondary)">' + (m.opportunity_composite || 0).toFixed(1) + '</td>' +
        '<td><span class="cat-badge ' + catCls + '">' + esc(vcrCat.replace(/_/g, ' ')) + '</span></td>' +
        '<td style="font-size:11px;color:var(--dim)">' + esc(m.architecture || '') + '</td>' +
        '<td><div class="axis-bars">' + axes + '</div></td>' +
        '</tr>';
    }).join('') + '</tbody>' +
  '</table></div>';

  // Pagination
  const pEl = document.getElementById('vcr-pagination');
  if (pages <= 1) { pEl.innerHTML = ''; return; }
  let pHtml = '<button class="page-btn" onclick="goVcrPage(' + (vcrCurrentPage - 1) + ')" ' + (vcrCurrentPage === 1 ? 'disabled' : '') + '>&laquo;</button>';
  for (let i = 1; i <= pages; i++) {
    if (pages > 7 && i > 2 && i < pages - 1 && Math.abs(i - vcrCurrentPage) > 1) {
      if (i === 3 || i === pages - 2) pHtml += '<span class="page-info">...</span>';
      continue;
    }
    pHtml += '<button class="page-btn ' + (i === vcrCurrentPage ? 'active' : '') + '" onclick="goVcrPage(' + i + ')">' + i + '</button>';
  }
  pHtml += '<button class="page-btn" onclick="goVcrPage(' + (vcrCurrentPage + 1) + ')" ' + (vcrCurrentPage === pages ? 'disabled' : '') + '>&raquo;</button>';
  pHtml += '<span class="page-info">' + vcrFilteredModels.length + ' models</span>';
  pEl.innerHTML = pHtml;
}

function goVcrPage(p) {
  const pages = Math.ceil(vcrFilteredModels.length / PAGE_SIZE);
  if (p < 1 || p > pages) return;
  vcrCurrentPage = p;
  renderVcrTable();
  document.getElementById('vcr-table-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function renderVcrCatFilters(summary) {
  const el = document.getElementById('vcr-cat-filters');
  const dist = summary.vcr_category_distribution || {};
  const order = ['FUND_RETURNER','STRONG_MULTIPLE','VIABLE_RETURN','MARGINAL','VC_POOR'];
  el.innerHTML = order.filter(k => dist[k] > 0).map(k => {
    const cls = 'vcr-' + k;
    return '<span class="filter-chip cat-badge ' + cls + '" data-cat="' + k + '" onclick="setVcrFilter(\'' + k + '\')">' + dist[k] + ' ' + k.replace(/_/g, ' ') + '</span>';
  }).join('');
}

function renderVcrArchBreakdown(dashboard) {
  const el = document.getElementById('vcr-arch-breakdown');
  const data = dashboard.vcr_architecture_breakdown || [];
  if (!data.length) return;
  el.innerHTML = '<table class="model-table" style="font-size:11px"><thead><tr><th>Architecture</th><th>Count</th><th>Avg ECO</th><th>Avg MOA</th><th>Avg ROI</th></tr></thead><tbody>' +
    data.slice(0, 15).map(a => {
      const rc = roiClass(a.avg_roi_multiple);
      return '<tr><td style="font-weight:600">' + esc(a.architecture) + '</td><td>' + a.count + '</td><td>' + a.avg_eco.toFixed(1) + '</td><td>' + a.avg_moa.toFixed(1) + '</td><td class="roi-value ' + rc + '">' + a.avg_roi_multiple.toFixed(1) + 'x</td></tr>';
    }).join('') + '</tbody></table>';
}

function renderVcrTriList(dashboard) {
  const el = document.getElementById('vcr-tri-list');
  const data = dashboard.top_20_tri_actionable || [];
  if (!data.length) return;
  el.innerHTML = data.map((a, i) => {
    const rc = roiClass(a.seed_roi_multiple || 0);
    return '<div style="display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.03);font-size:11px">' +
      '<span style="color:var(--dim);width:20px">' + (i+1) + '</span>' +
      '<span style="flex:1;font-weight:600;color:var(--text)">' + esc(a.name).slice(0,30) + '</span>' +
      '<span style="color:var(--accent);font-weight:700;width:45px;text-align:right">' + a.tri_score.toFixed(1) + '</span>' +
      '<span class="roi-value ' + rc + '" style="width:50px;text-align:right;font-size:10px">' + (a.seed_roi_multiple || 0).toFixed(0) + 'x</span>' +
      '</div>';
  }).join('');
}

function applyFilters() {
  const q = document.getElementById('model-search').value.toLowerCase().trim();
  const sort = document.getElementById('model-sort').value;

  filteredModels = allModels.filter(m => {
    if (newOnlyActive && !m.new_in_v36) return false;
    if (activeCatFilter && m.category !== activeCatFilter) return false;
    if (activeOppFilter && m.opportunity_category !== activeOppFilter) return false;
    if (activeConfFilter && m.confidence_tier !== activeConfFilter) return false;
    if (activeConvictionFilter === 'confirmed' && !CONFIRMED_CATS.has(m.category)) return false;
    if (activeConvictionFilter === 'what-if' && !WHATIF_CATS.has(m.category) && !m.catalyst_scenario) return false;
    if (activeForceFilter) {
      const forces = m.forces || [];
      if (!forces.some(f => f.startsWith(activeForceFilter))) return false;
    }
    if (activeFrSubtypeFilter && m.force_rider_subtype !== activeFrSubtypeFilter) return false;
    if (activeNarrFilter && !(m.narrative_ids || []).includes(activeNarrFilter)) return false;
    if (q) {
      const narrNames = (m.narrative_ids || []).map(nid => getNarrName(nid)).join(' ');
      const hay = [m.name, m.id, m.sector_naics, m.architecture, m.category, m.opportunity_category || '', m.one_liner || '', m.layer_name || '', m.sector_name || '', m.narrative_role || '', narrNames].join(' ').toLowerCase();
      if (!hay.includes(q)) return false;
    }
    return true;
  });

  // Sort
  const sortFns = {
    'rank': (a, b) => a.rank - b.rank,
    'composite-desc': (a, b) => b.composite - a.composite,
    'composite-asc': (a, b) => a.composite - b.composite,
    'opp-rank': (a, b) => (a.opportunity_rank || 9999) - (b.opportunity_rank || 9999),
    'opp-desc': (a, b) => (b.opportunity_composite || 0) - (a.opportunity_composite || 0),
    'opp-asc': (a, b) => (a.opportunity_composite || 0) - (b.opportunity_composite || 0),
    'actionable': (a, b) => {
      const gA = Math.sqrt((a.composite || 0) * (a.opportunity_composite || 0));
      const gB = Math.sqrt((b.composite || 0) * (b.opportunity_composite || 0));
      return gB - gA;
    },
    'sn': (a, b) => (b.scores.SN || 0) - (a.scores.SN || 0),
    'fa': (a, b) => (b.scores.FA || 0) - (a.scores.FA || 0),
    'ec': (a, b) => (b.scores.EC || 0) - (a.scores.EC || 0),
    'tg': (a, b) => (b.scores.TG || 0) - (a.scores.TG || 0),
    'ce': (a, b) => (b.scores.CE || 0) - (a.scores.CE || 0),
    'name': (a, b) => a.name.localeCompare(b.name),
    'vcr-rank': (a, b) => (a.vcr_rank || 9999) - (b.vcr_rank || 9999),
    'vcr-desc': (a, b) => (b.vcr_composite || 0) - (a.vcr_composite || 0),
    'roi-desc': (a, b) => (b.vcr_roi_multiple || 0) - (a.vcr_roi_multiple || 0),
    'narrative': (a, b) => {
      const aN = (a.narrative_ids || [])[0] || 'ZZZ';
      const bN = (b.narrative_ids || [])[0] || 'ZZZ';
      if (aN !== bN) return aN.localeCompare(bN);
      return a.rank - b.rank;
    },
  };
  if (sortFns[sort]) filteredModels.sort(sortFns[sort]);

  renderModelList();
}

function renderModelList() {
  const total = filteredModels.length;
  const pages = Math.ceil(total / PAGE_SIZE);
  if (currentPage > pages) currentPage = pages || 1;
  const start = (currentPage - 1) * PAGE_SIZE;
  const pageModels = filteredModels.slice(start, start + PAGE_SIZE);

  const confirmedCount = filteredModels.filter(m => CONFIRMED_CATS.has(m.category)).length;
  const whatIfCount = total - confirmedCount;
  let infoText = total + ' model' + (total !== 1 ? 's' : '');
  if (activeConvictionFilter === 'all' && total > 0) infoText += ' \u2014 ' + confirmedCount + ' confirmed, ' + whatIfCount + ' what-if';
  if (newOnlyActive) infoText += ' (new only)';
  if (activeCatFilter) infoText += ' \u2014 ' + activeCatFilter.replace(/_/g, ' ');
  if (activeOppFilter) infoText += ' \u2014 opp: ' + activeOppFilter.replace(/_/g, ' ');
  if (activeConvictionFilter === 'confirmed') infoText += ' (high conviction only)';
  if (activeConvictionFilter === 'what-if') infoText += ' (conditional / speculative)';
  document.getElementById('results-info').textContent = infoText;

  const container = document.getElementById('model-list-container');

  const currentSort = document.getElementById('model-sort').value;
  if (viewMode === 'table') {
    let bodyHtml = '';
    if (currentSort === 'narrative') {
      let lastNarr = '';
      pageModels.forEach(m => {
        const nid = (m.narrative_ids || [])[0] || '';
        if (nid !== lastNarr) {
          const nName = nid ? getNarrName(nid) : 'Unlinked';
          const n = allNarratives.find(x => x.narrative_id === nid);
          const tnsBadge = n ? `<span class="tns-badge tns-${n.tns_category || ''}" style="margin-left:8px">${(n.tns_composite || 0).toFixed(1)}</span>` : '';
          bodyHtml += `<tr><td colspan="9" style="padding:12px 10px 6px;font-weight:700;font-size:13px;color:var(--accent);border-bottom:2px solid var(--accent-soft);background:rgba(167,139,250,0.03)">${esc(nName)}${tnsBadge}</td></tr>`;
          lastNarr = nid;
        }
        bodyHtml += modelTableRow(m);
      });
    } else {
      bodyHtml = pageModels.map(m => modelTableRow(m)).join('');
    }
    container.innerHTML = `<div class="glass-static" style="overflow-x:auto"><table class="model-table">
      <thead><tr>
        <th class="sorted" data-sort="rank" title="Transformation rank (by T-Score)">#</th>
        <th data-sort="name">Name</th>
        <th data-sort="composite-desc" title="Transformation Score — will this happen? (0-100)">T-Score</th>
        <th data-sort="opp-desc" title="Opportunity Score — can an entrant play? (0-100)">O-Score</th>
        <th data-sort="roi-desc" title="Estimated return multiple on $10M seed">ROI</th>
        <th data-sort="category" title="Pattern category from T-axis thresholds">T-Category</th>
        <th title="Opportunity category from CLA composite thresholds">O-Category</th>
        <th title="T-Score axes: SN=Structural Necessity, FA=Force Alignment, EC=Economic Capture, TG=Timing, CE=Competitive Edge">Axes</th>
        <th title="North American Industry Classification System sector code">NAICS</th>
      </tr></thead>
      <tbody>${bodyHtml}</tbody>
    </table></div>`;
  } else {
    container.innerHTML = `<div class="model-card-grid">${pageModels.map(m => modelCardHtml(m)).join('')}</div>`;
  }

  renderPagination(pages);
}

function modelTableRow(m) {
  const catCls = 'cat-' + (m.category || 'CONDITIONAL');
  const oppCatCls = 'opp-' + (m.opportunity_category || 'CONTESTED');
  const newBadge = m.new_in_v36 ? '<span class="new-badge">NEW</span>' : '';
  const subBadge = m.parent_id ? '<span class="sub-badge">SUB</span>' : '';
  const catBadge = m.catalyst_scenario ? `<span style="font-size:8px;padding:1px 5px;border-radius:3px;background:rgba(251,191,36,0.15);color:#f59e0b;font-weight:700;margin-left:4px" title="Catalyst: ${esc(m.catalyst_scenario.cluster_name || '')} — ${m.catalyst_scenario.asymmetry_ratio.toFixed(2)}x upside if triggers fire">CAT ${m.catalyst_scenario.asymmetry_ratio.toFixed(1)}x</span>` : '';
  const decompIndicator = m.decomposed ? '<span class="decomposed-indicator">(' + (m.sub_model_count || '?') + ' layers)</span>' : '';
  const isConditional = WHATIF_CATS.has(m.category);
  const axes = ['SN','FA','EC','TG','CE'].map(a => {
    const v = m.scores[a] || 0;
    const pct = (v / 10) * 100;
    return `<div class="axis-bar">
      <div class="axis-bar-label">${a}</div>
      <div class="axis-bar-track"><div class="axis-bar-fill" style="width:${pct}%;background:${axisColor[a]}"></div></div>
      <div class="axis-bar-val">${v.toFixed(1)}</div>
    </div>`;
  }).join('');

  const compColor = m.composite >= 80 ? 'var(--green)' : m.composite >= 70 ? 'var(--blue)' : m.composite >= 60 ? 'var(--text)' : 'var(--dim)';
  const oppComp = m.opportunity_composite || 0;
  const oppColor = oppComp >= 75 ? 'var(--green)' : oppComp >= 60 ? 'var(--blue)' : oppComp >= 45 ? 'var(--amber)' : 'var(--red)';

  return `<tr onclick="toggleModelDetail('${esc(m.id)}')"${isConditional ? ' class="row-conditional"' : ''}>
    <td class="rank-cell">${m.rank}</td>
    <td class="name-cell">${esc(m.name)}${newBadge}${subBadge}${catBadge}${decompIndicator}${narrBadgeHtml(m)}${m.confidence_tier ? ' <span class="confidence-badge conf-' + m.confidence_tier + '" style="font-size:8px;padding:1px 4px;vertical-align:middle">' + m.confidence_tier[0] + '</span>' : ''}</td>
    <td class="composite-cell" style="color:${compColor}">${m.composite.toFixed(1)}</td>
    <td class="opp-cell" style="color:${oppColor}">${oppComp.toFixed(1)}</td>
    <td class="opp-cell roi-value ${roiClass(m.vcr_roi_multiple || 0)}" style="font-size:12px">${m.vcr_roi_multiple ? (m.vcr_roi_multiple >= 100 ? Math.round(m.vcr_roi_multiple) + 'x' : m.vcr_roi_multiple.toFixed(1) + 'x') : '--'}</td>
    <td><span class="cat-badge ${catCls}">${esc((m.category || '').replace(/_/g, ' '))}</span></td>
    <td><span class="cat-badge ${oppCatCls}">${esc((m.opportunity_category || '').replace(/_/g, ' '))}</span></td>
    <td><div class="axis-bars">${axes}</div></td>
    <td style="font-size:11px;color:var(--dim)">${esc(m.sector_naics)}</td>
  </tr>`;
}

function modelCardHtml(m) {
  const catCls = 'cat-' + (m.category || 'CONDITIONAL');
  const oppCatCls = 'opp-' + (m.opportunity_category || 'CONTESTED');
  const newBadge = m.new_in_v36 ? '<span class="new-badge">NEW</span>' : '';
  const subBadge = m.parent_id ? '<span class="sub-badge">SUB</span>' : '';
  const catBadge = m.catalyst_scenario ? `<span style="font-size:8px;padding:1px 5px;border-radius:3px;background:rgba(251,191,36,0.15);color:#f59e0b;font-weight:700;margin-left:4px" title="Catalyst: ${esc(m.catalyst_scenario.cluster_name || '')}">CAT ${m.catalyst_scenario.asymmetry_ratio.toFixed(1)}x</span>` : '';
  const decompIndicator = m.decomposed ? '<span class="decomposed-indicator">(' + (m.sub_model_count || '?') + ' layers)</span>' : '';
  const axisHtml = ['SN','FA','EC','TG','CE'].map(a => {
    const v = m.scores[a] || 0;
    return `<span class="mci-axis"><span class="mci-axis-label">${a}</span> ${v.toFixed(1)}</span>`;
  }).join('');
  const oppComp = m.opportunity_composite || 0;

  return `<div class="glass model-card-item" onclick="toggleModelDetail('${esc(m.id)}')">
    <div class="mci-top">
      <span class="mci-rank">#${m.rank}</span>
      <span class="cat-badge ${catCls}">${esc((m.category || '').replace(/_/g, ' '))}</span>
    </div>
    <div class="mci-name">${esc(m.name)}${newBadge}${subBadge}${catBadge}${decompIndicator}${narrBadgeHtml(m)}</div>
    <div class="mci-score-row">
      <span class="mci-composite">${m.composite.toFixed(1)}</span>
      <span class="mci-opp-composite">OPP ${oppComp.toFixed(1)}</span>
      <div class="mci-scores">${axisHtml}</div>
    </div>
    <div class="mci-cats">
      <span class="cat-badge ${oppCatCls}" style="font-size:8px">${esc((m.opportunity_category || '').replace(/_/g, ' '))}</span>
    </div>
  </div>`;
}

function toggleModelDetail(id) {
  const panel = document.getElementById('model-detail-panel');
  if (expandedModelId === id) {
    panel.classList.remove('visible');
    expandedModelId = null;
    return;
  }
  expandedModelId = id;
  const m = allModels.find(x => x.id === id);
  if (!m) return;

  const axes = ['SN','FA','EC','TG','CE'];
  const axisNames = { SN: 'Structural Necessity', FA: 'Force Alignment', EC: 'Economic Capture', TG: 'Timing & Geography', CE: 'Competitive Edge' };
  const axisWeights = { SN: '25%', FA: '25%', EC: '20%', TG: '15%', CE: '15%' };
  const newBadge = m.new_in_v36 ? ' <span class="new-badge" style="font-size:10px;padding:2px 8px">NEW</span>' : '';
  const subBadge = m.parent_id ? ' <span class="sub-badge" style="font-size:10px;padding:2px 8px">SUB-MODEL</span>' : '';

  const axesHtml = axes.map(a => {
    const v = m.scores[a] || 0;
    const pct = (v / 10) * 100;
    return `<div class="detail-axis">
      <div class="da-label" style="color:${axisColor[a]}">${a} (${axisWeights[a]})</div>
      <div class="da-value" style="color:${axisColor[a]}">${v.toFixed(1)}</div>
      <div class="da-bar"><div class="da-bar-fill" style="width:${pct}%;background:${axisColor[a]}"></div></div>
      <div style="font-size:8px;color:var(--dim);margin-top:3px">${axisNames[a]}</div>
    </div>`;
  }).join('');

  // CLA axes
  const claAxes = ['MO','MA','VD','DV'];
  const claNames = { MO: 'Market Openness', MA: 'Moat Accessibility', VD: 'Value Chain Depth', DV: 'Demand Visibility' };
  const claScores = m.cla_scores || {};
  const claHtml = claAxes.map(a => {
    const v = claScores[a] || 0;
    const pct = (v / 10) * 100;
    return `<div class="detail-axis">
      <div class="da-label" style="color:${claColor[a]}">${a}</div>
      <div class="da-value" style="color:${claColor[a]}">${v}</div>
      <div class="da-bar"><div class="da-bar-fill" style="width:${pct}%;background:${claColor[a]}"></div></div>
      <div style="font-size:8px;color:var(--dim);margin-top:3px">${claNames[a]}</div>
    </div>`;
  }).join('');

  // VCR axes
  const vcrAxesList = ['MKT','CAP','ECO','VEL','MOA'];
  const vcrNames = { MKT: 'Market Magnitude', CAP: 'Capture Feasibility', ECO: 'Unit Economics', VEL: 'Revenue Velocity', MOA: 'Moat Trajectory' };
  const vcrScores = m.vcr_scores || {};
  const vcrHtml = vcrAxesList.map(a => {
    const v = vcrScores[a] || 0;
    const pct = (v / 10) * 100;
    return `<div class="detail-axis">
      <div class="da-label" style="color:${vcrColor[a]}">${a}</div>
      <div class="da-value" style="color:${vcrColor[a]}">${v}</div>
      <div class="da-bar"><div class="da-bar-fill" style="width:${pct}%;background:${vcrColor[a]}"></div></div>
      <div style="font-size:8px;color:var(--dim);margin-top:3px">${vcrNames[a]}</div>
    </div>`;
  }).join('');

  const cats = (m.categories || [m.category]).map(c => `<span class="cat-badge cat-${c}">${esc(c.replace(/_/g, ' '))}</span>`).join('');
  const oppCatCls = 'opp-' + (m.opportunity_category || 'CONTESTED');
  const oppCatBadge = m.opportunity_category ? `<span class="cat-badge ${oppCatCls}">OPP: ${esc(m.opportunity_category.replace(/_/g, ' '))}</span>` : '';
  const oppComp = m.opportunity_composite || 0;

  // Sub-model info
  let subInfoHtml = '';
  if (m.parent_id) {
    const parent = allModels.find(x => x.id === m.parent_id);
    const parentName = parent ? parent.name : m.parent_id;
    subInfoHtml = `<div class="detail-sub-info">Sub-model of <strong>${esc(parentName)}</strong> &mdash; Layer: <strong>${esc(m.layer_name || 'Layer ' + (m.layer || '?'))}</strong></div>`;
  }

  // Decomposed parent info
  let decompInfoHtml = '';
  if (m.decomposed && m.sub_model_count) {
    const range = m.sub_model_opp_range || [];
    const rangeStr = range.length === 2 ? range[0].toFixed(1) + ' - ' + range[1].toFixed(1) : '?';
    decompInfoHtml = `<div class="detail-decomp-info">Decomposed into <strong>${m.sub_model_count} layers</strong> (OPP range ${rangeStr})</div>`;
  }

  panel.innerHTML = `
    <div class="detail-header">
      <div>
        <div class="detail-name">${esc(m.name)}${newBadge}${subBadge}</div>
        <div class="detail-id">${esc(m.id)} &middot; T-Rank #${m.rank} &middot; O-Rank #${m.opportunity_rank || '--'}</div>
      </div>
      <div class="detail-composites">
        <div class="detail-composite-block">
          <div class="detail-composite-label">Transformation</div>
          <div class="detail-composite">${m.composite.toFixed(1)}</div>
        </div>
        <div class="detail-composite-block">
          <div class="detail-composite-label">Opportunity</div>
          <div class="detail-composite-opp">${oppComp.toFixed(1)}</div>
        </div>
        <div class="detail-composite-block">
          <div class="detail-composite-label">VC ROI</div>
          <div class="detail-composite-opp" style="color:var(--green)">${(m.vcr_composite || 0).toFixed(1)}</div>
        </div>
      </div>
    </div>
    ${subInfoHtml}
    ${decompInfoHtml}
    ${(() => {
      const nids = m.narrative_ids || [];
      if (!nids.length) return '';
      const role = m.narrative_role || 'unlinked';
      const roleColor = role === 'what_works' ? 'var(--green)' : role === 'whats_needed' ? 'var(--blue)' : role === 'what_dies' ? 'var(--red)' : 'var(--dim)';
      const narrItems = nids.map(nid => {
        const n = allNarratives.find(x => x.narrative_id === nid);
        if (!n) return `<span style="color:var(--text-secondary)">${esc(nid)}</span>`;
        const tnsCat = n.tns_category || '';
        const tnsCls = 'tns-' + tnsCat;
        const phase = (n.year_by_year && n.year_by_year['2026']) ? n.year_by_year['2026'].phase || '' : '';
        return `<div style="display:flex;align-items:center;gap:8px;padding:6px 10px;background:rgba(255,255,255,0.02);border-radius:var(--radius-xs);cursor:pointer" onclick="event.stopPropagation();document.querySelector('[data-view=narratives]').click();document.getElementById('narr-search').value='${esc(n.name)}';document.getElementById('narr-search').dispatchEvent(new Event('input'))">
          <span class="tns-badge ${tnsCls}" style="font-size:9px">${esc(tnsCat)}</span>
          <span style="font-weight:600;color:var(--text);font-size:12px">${esc(n.name)}</span>
          <span style="font-size:10px;color:var(--accent)">TNS ${(n.tns_composite || 0).toFixed(1)}</span>
          ${phase ? `<span class="narr-phase">${esc(phase.replace(/_/g, ' '))}</span>` : ''}
        </div>`;
      }).join('');
      return `<div style="margin-bottom:12px;padding:12px;background:rgba(255,255,255,0.015);border-radius:var(--radius-sm);border-left:3px solid ${roleColor}">
        <div style="font-size:10px;color:var(--dim);font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px">Transformation Context <span style="font-weight:400;text-transform:none;letter-spacing:0">&mdash; role: <span style="color:${roleColor};font-weight:600">${esc(role.replace(/_/g, ' '))}</span></span></div>
        <div style="display:flex;flex-direction:column;gap:4px">${narrItems}</div>
      </div>`;
    })()}
    <div style="font-size:10px;color:var(--dim);font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-bottom:2px">Transformation Axes &mdash; <span style="font-weight:400;text-transform:none;letter-spacing:0">Will this transformation happen?</span></div>
    <div style="font-size:9px;color:var(--dim);margin-bottom:6px;font-weight:400">SN=Structural Necessity, FA=Force Alignment, EC=Economic Capture, TG=Timing, CE=Competitive Edge</div>
    <div class="detail-axes">${axesHtml}</div>
    <div style="font-size:10px;color:var(--dim);font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-bottom:2px">Opportunity Axes (CLA) &mdash; <span style="font-weight:400;text-transform:none;letter-spacing:0">Can a new entrant play?</span></div>
    <div style="font-size:9px;color:var(--dim);margin-bottom:6px;font-weight:400">MO=Market Openness, MA=Moat Accessibility, VD=Value Chain Depth, DV=Demand Visibility</div>
    <div class="detail-cla-axes">${claHtml}</div>
    <div style="font-size:10px;color:var(--dim);font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-bottom:2px">VC ROI Axes (VCR) &mdash; <span style="font-weight:400;text-transform:none;letter-spacing:0">Is this a good seed investment?</span></div>
    <div style="font-size:9px;color:var(--dim);margin-bottom:6px;font-weight:400">MKT=Market Size, CAP=Capture Feasibility, ECO=Unit Economics, VEL=Revenue Velocity, MOA=Moat Trajectory</div>
    <div class="detail-cla-axes" style="grid-template-columns:repeat(5,1fr)">${vcrHtml}</div>
    ${m.vcr_roi_multiple ? `<div style="font-size:13px;color:var(--text-secondary);padding:8px 12px;background:rgba(52,211,153,0.04);border-radius:var(--radius-xs);border-left:3px solid var(--green);margin-bottom:12px">Seed ROI Estimate: <strong class="roi-value ${roiClass(m.vcr_roi_multiple)}" style="font-size:16px">${m.vcr_roi_multiple >= 100 ? Math.round(m.vcr_roi_multiple) : m.vcr_roi_multiple.toFixed(1)}x</strong> on $10M seed &middot; Est. Exit: <strong>$${(m.vcr_exit_val_M || 0).toLocaleString()}M</strong> <span style="font-size:10px;color:var(--dim)">(MKT&rarr;TAM &times; CAP&rarr;share &times; revenue multiple)</span></div>` : ''}
    <div class="detail-cats">${cats} ${oppCatBadge}</div>
    <div class="detail-meta">
      <span><span class="meta-label">NAICS:</span> ${esc(m.sector_naics)}${m.sector_name ? ' (' + esc(m.sector_name) + ')' : ''}</span>
      <span><span class="meta-label">Architecture:</span> ${esc(m.architecture)}</span>
      <span><span class="meta-label">Source:</span> ${esc(m.source_batch)}</span>
      ${m.confidence_tier ? `<span><span class="meta-label">Confidence:</span> <span class="confidence-badge conf-${m.confidence_tier}">${m.confidence_tier}</span></span>` : ''}
    </div>
    ${m.one_liner ? `<div class="detail-oneliner">${esc(m.one_liner)}</div>` : ''}
    ${(m.forces && m.forces.length) ? `<div style="margin:8px 0"><span class="meta-label" style="font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:1px">Driving Forces </span><span style="font-size:9px;color:var(--dim);text-transform:none;letter-spacing:0">(macro forces accelerating this transformation)</span><br>${m.forces.map(f => '<span style="font-size:10px;font-weight:600;color:var(--accent);margin-right:6px">' + esc(f.replace(/_/g, ' ')) + '</span>').join('')}</div>` : ''}
    ${m.cla_rationale ? `<div style="font-size:10px;color:var(--dim);font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;margin-top:8px">Opportunity Rationale <span style="font-weight:400;text-transform:none;letter-spacing:0">&mdash; why this O-score</span></div><div class="detail-rationale">${esc(m.cla_rationale)}</div>` : ''}
    ${m.vcr_rationale ? `<div style="font-size:10px;color:var(--dim);font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">VCR Rationale <span style="font-weight:400;text-transform:none;letter-spacing:0">&mdash; investment thesis basis</span></div><div class="detail-rationale">${esc(m.vcr_rationale)}</div>` : ''}
    ${m.deep_dive_evidence ? `<div style="font-size:10px;color:var(--dim);font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">Evidence <span style="font-weight:400;text-transform:none;letter-spacing:0">&mdash; supporting data from deep dive</span></div><div class="detail-rationale">${esc(m.deep_dive_evidence)}</div>` : ''}
    ${(m.falsification_criteria && m.falsification_criteria.length) ? `<div style="font-size:10px;color:var(--dim);font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">Falsification Criteria <span style="font-weight:400;text-transform:none;letter-spacing:0">&mdash; conditions that would invalidate this model</span></div><ul class="falsification-list">${m.falsification_criteria.map(c => '<li class="falsification-item">' + esc(c) + '</li>').join('')}</ul>` : ''}
    ${m.catalyst_scenario ? renderCatalystDetail(m.catalyst_scenario) : ''}
  `;
  panel.classList.add('visible');
  panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function renderPagination(totalPages) {
  const el = document.getElementById('pagination');
  if (totalPages <= 1) { el.innerHTML = ''; return; }

  let html = `<button class="page-btn" onclick="goPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>&laquo;</button>`;
  for (let i = 1; i <= totalPages; i++) {
    if (totalPages > 7 && i > 2 && i < totalPages - 1 && Math.abs(i - currentPage) > 1) {
      if (i === 3 || i === totalPages - 2) html += '<span class="page-info">...</span>';
      continue;
    }
    html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goPage(${i})">${i}</button>`;
  }
  html += `<button class="page-btn" onclick="goPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>&raquo;</button>`;
  html += `<span class="page-info">${filteredModels.length} models</span>`;
  el.innerHTML = html;
}

function goPage(p) {
  const pages = Math.ceil(filteredModels.length / PAGE_SIZE);
  if (p < 1 || p > pages) return;
  currentPage = p;
  renderModelList();
  document.getElementById('model-list-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// ─── WHAT'S NEW BANNER ───
function renderWhatsNew(d) {
  const el = document.getElementById('whats-new');
  const items = [];

  // Force velocity changes (v4 format)
  const fv = d.force_velocities || {};
  Object.values(fv).forEach(f => {
    if (f.velocity === 'accelerating') items.push({ text: f.name + ' \u2191 ' + f.velocity, cls: 'wn-force' });
    if (f.velocity === 'intensifying') items.push({ text: f.name + ' \u2191 ' + f.velocity, cls: 'wn-force' });
  });

  // v4 narrative context
  const totalNarr = d.total_narratives || 0;
  const tnsCat = d.tns_category_distribution || {};
  if (tnsCat.DEFINING) items.push({ text: tnsCat.DEFINING + ' DEFINING narratives', cls: 'wn-pattern' });

  // v4 collision count
  const totalColl = d.total_collisions || 0;
  if (totalColl) items.push({ text: totalColl + ' force collisions mapped', cls: 'wn-pattern' });

  // Models linked
  const linked = d.models_linked || 0;
  if (linked) items.push({ text: linked + '/' + (d.total_models || 0) + ' models linked to narratives', cls: 'wn-model' });

  if (!items.length) { el.style.display = 'none'; return; }

  el.innerHTML = `<div class="whats-new-title">What's New in ${d.current_cycle || 'v4-0'}</div>
    <div class="whats-new-items">${items.map(i => `<span class="wn-tag ${i.cls}">${esc(i.text)}</span>`).join('')}</div>`;
}

// ─── CATEGORY FILTERS ───
function renderCatFilters(summary) {
  const el = document.getElementById('cat-filters');
  const dist = summary.category_distribution || summary.primary_category_distribution || {};
  const order = ['STRUCTURAL_WINNER','FORCE_RIDER','TIMING_ARBITRAGE','CAPITAL_MOAT','FEAR_ECONOMY','EMERGING_CATEGORY','CONDITIONAL','PARKED'];
  el.innerHTML = order.filter(k => dist[k] > 0).map(k => {
    const cls = 'cat-' + k;
    return `<span class="filter-chip cat-badge ${cls}" data-cat="${k}" onclick="setCatFilter('${k}')">${dist[k]} ${k.replace(/_/g, ' ')}</span>`;
  }).join('');
}

function renderOppCatFilters(summary) {
  const el = document.getElementById('opp-cat-filters');
  const dist = summary.opp_category_distribution || summary.opportunity_category_distribution || {};
  const order = ['WIDE_OPEN','ACCESSIBLE','CONTESTED','FORTIFIED','LOCKED'];
  el.innerHTML = order.filter(k => dist[k] > 0).map(k => {
    const cls = 'opp-' + k;
    return `<span class="filter-chip cat-badge ${cls}" data-cat="${k}" onclick="setOppFilter('${k}')">${dist[k]} ${k.replace(/_/g, ' ')}</span>`;
  }).join('');
}

// ─── CONFIDENCE FILTER ───
function renderConfidenceFilters(models) {
  const el = document.getElementById('confidence-filters');
  const counts = { HIGH: 0, MODERATE: 0, LOW: 0 };
  models.forEach(m => { const t = m.confidence_tier; if (counts[t] !== undefined) counts[t]++; });
  const order = ['HIGH', 'MODERATE', 'LOW'];
  el.innerHTML = '<span style="font-size:10px;color:var(--dim);font-weight:600;padding:4px 0;text-transform:uppercase;letter-spacing:0.5px">Confidence:</span> ' +
    order.filter(k => counts[k] > 0).map(k => {
    return '<span class="filter-chip confidence-badge conf-' + k + '" data-cat="' + k + '" onclick="setConfFilter(\'' + k + '\')">' + counts[k] + ' ' + k + '</span>';
  }).join('');
}

// ─── FORCE FILTER ───
function renderForceFilters(models) {
  const el = document.getElementById('force-filters');
  const forceNames = { F1: 'Technology', F2: 'Demographics', F3: 'Geopolitics', F4: 'Capital', F5: 'Psychology', F6: 'Energy' };
  const counts = {};
  models.forEach(m => {
    const forces = m.forces || [];
    const seen = new Set();
    forces.forEach(f => {
      const key = f.substring(0, 2);
      if (!seen.has(key)) { counts[key] = (counts[key] || 0) + 1; seen.add(key); }
    });
  });
  const order = ['F1','F2','F3','F4','F5','F6'];
  el.innerHTML = '<span style="font-size:10px;color:var(--dim);font-weight:600;padding:4px 0;text-transform:uppercase;letter-spacing:0.5px">Forces:</span> ' +
    order.filter(k => counts[k] > 0).map(k => {
    return '<span class="filter-chip force-filter-chip" data-cat="' + k + '" onclick="setForceFilter(\'' + k + '\')">' + counts[k] + ' ' + k + ' ' + forceNames[k] + '</span>';
  }).join('');
}

// ─── FORCE_RIDER SUBTYPE FILTERS (v3-18) ───
function renderFrSubtypeFilters(models) {
  const el = document.getElementById('fr-subtype-filters');
  const counts = {};
  models.forEach(m => {
    const sub = m.force_rider_subtype;
    if (sub) counts[sub] = (counts[sub] || 0) + 1;
  });
  const order = ['FR_STRUCTURAL','FR_PLATFORM','FR_VERTICAL','FR_SERVICE','FR_CONSOLIDATION','FR_COMPLIANCE','FR_GENERAL'];
  const labels = {
    FR_STRUCTURAL: 'Structural', FR_PLATFORM: 'Platform', FR_VERTICAL: 'Vertical SaaS',
    FR_SERVICE: 'Service', FR_CONSOLIDATION: 'Consolidation', FR_COMPLIANCE: 'Compliance', FR_GENERAL: 'General'
  };
  el.innerHTML = order.filter(k => counts[k] > 0).map(k => {
    return '<span class="filter-chip cat-badge cat-FORCE_RIDER" data-cat="' + k + '" onclick="setFrSubtypeFilter(\'' + k + '\')" title="' + k + '">' + counts[k] + ' ' + (labels[k] || k) + '</span>';
  }).join('');
}

// ─── RUNNING PATTERNS ───
function renderPatterns(dashboard) {
  const rp = dashboard.running_patterns || {};
  const confirmed = rp.confirmed || [];
  const el = document.getElementById('patterns-grid');
  const countEl = document.getElementById('patterns-count');
  if (!confirmed.length) { el.innerHTML = '<div style="font-size:12px;color:var(--dim)">No patterns data available</div>'; return; }
  countEl.textContent = confirmed.length;
  el.innerHTML = confirmed.map(p => {
    const id = typeof p === 'string' ? '' : (p.id || '');
    const name = typeof p === 'string' ? p : (p.name || p.title || p);
    const evidence = typeof p === 'string' ? '' : (p.evidence || p.description || '');
    return '<div class="glass pattern-card">' +
      (id ? '<div class="pattern-id">' + esc(id) + '</div>' : '') +
      '<div>' + esc(name) + '</div>' +
      (evidence ? '<div class="pattern-evidence">' + esc(evidence) + '</div>' : '') +
      '</div>';
  }).join('');
}

// ─── FORCE-MODEL DISTRIBUTION ───
function renderForceDistribution(dashboard) {
  const dist = dashboard.force_model_distribution || {};
  const conv = dashboard.force_convergence || {};
  const el = document.getElementById('force-model-distribution');
  const countEl = document.getElementById('force-dist-count');
  const forceNames = { F1: 'Technology', F2: 'Demographics', F3: 'Geopolitics', F4: 'Capital', F5: 'Psychology', F6: 'Energy' };
  const total = Object.values(dist).reduce((s, v) => s + v, 0) || 1;
  const order = ['F1','F2','F3','F4','F5','F6'];
  if (countEl) countEl.textContent = 'across ' + (dashboard.total_models_rated || '?') + ' models';
  el.innerHTML = '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px">' +
    order.map(k => {
      const count = dist[k] || 0;
      const pct = Math.round((count / total) * 100);
      const barColor = k === 'F1' ? 'var(--accent)' : k === 'F2' ? 'var(--blue)' : k === 'F3' ? 'var(--red)' : k === 'F4' ? 'var(--amber)' : k === 'F5' ? 'var(--pink)' : 'var(--green)';
      return '<div style="padding:8px"><div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:4px">' + k + ' ' + (forceNames[k] || '') + '</div>' +
        '<div style="font-size:18px;font-weight:800;color:' + barColor + '">' + count + '</div>' +
        '<div style="height:4px;border-radius:2px;background:rgba(255,255,255,0.05);margin-top:4px"><div style="height:100%;border-radius:2px;background:' + barColor + ';width:' + Math.min(pct * 1.5, 100) + '%"></div></div>' +
        '<div style="font-size:10px;color:var(--dim);margin-top:3px">' + pct + '% of models</div></div>';
    }).join('') + '</div>' +
    (Object.keys(conv).length ? '<div style="margin-top:12px;font-size:11px;color:var(--text-secondary)">' +
      Object.entries(conv).map(([k, v]) => '<span style="margin-right:12px">' + k.replace(/_/g, ' ') + ': <strong>' + v + '</strong></span>').join('') +
    '</div>' : '');
}

// ─── SCATTER PLOT ───
function renderScatterPlot(models) {
  const el = document.getElementById('scatter-plot');
  if (!el || !models.length) return;
  const pad = { top: 20, right: 20, bottom: 35, left: 40 };
  const w = el.clientWidth || 800;
  const h = 400;

  // Ranges
  const tMin = 40, tMax = 95, oMin = 25, oMax = 85;
  const scaleX = (v) => pad.left + ((v - tMin) / (tMax - tMin)) * (w - pad.left - pad.right);
  const scaleY = (v) => h - pad.bottom - ((v - oMin) / (oMax - oMin)) * (h - pad.top - pad.bottom);

  let html = '';

  // Grid lines
  for (let t = 50; t <= 90; t += 10) {
    const x = scaleX(t);
    html += '<div class="scatter-grid-line" style="left:' + x + 'px;top:' + pad.top + 'px;width:1px;height:' + (h - pad.top - pad.bottom) + 'px"></div>';
    html += '<div style="position:absolute;left:' + x + 'px;bottom:10px;font-size:9px;color:var(--dim);transform:translateX(-50%)">' + t + '</div>';
  }
  for (let o = 30; o <= 80; o += 10) {
    const y = scaleY(o);
    html += '<div class="scatter-grid-line" style="left:' + pad.left + 'px;top:' + y + 'px;width:' + (w - pad.left - pad.right) + 'px;height:1px"></div>';
    html += '<div style="position:absolute;left:5px;top:' + y + 'px;font-size:9px;color:var(--dim);transform:translateY(-50%)">' + o + '</div>';
  }

  // Axis labels
  html += '<div class="scatter-axis-label" style="bottom:0;left:50%;transform:translateX(-50%)">T-Score (Transformation)</div>';
  html += '<div class="scatter-axis-label" style="top:50%;left:-2px;transform:rotate(-90deg) translateX(-50%);transform-origin:0 0">OPP Score</div>';

  // Dots
  const confColors = { HIGH: 'var(--green)', MODERATE: 'var(--amber)', LOW: 'var(--red)' };
  models.forEach(m => {
    const t = m.composite || 0;
    const o = m.opportunity_composite || 0;
    const vcr = m.vcr_composite || 50;
    const x = scaleX(t);
    const y = scaleY(o);
    const size = Math.max(4, Math.min(12, (vcr - 40) / 5));
    const color = confColors[m.confidence_tier] || 'var(--accent)';
    html += '<div class="scatter-dot" style="left:' + (x - size/2) + 'px;top:' + (y - size/2) + 'px;width:' + size + 'px;height:' + size + 'px;background:' + color + '" title="' + esc(m.name) + ' (T:' + t.toFixed(0) + ' O:' + o.toFixed(0) + ' V:' + vcr.toFixed(0) + ')" onclick="toggleModelDetail(\'' + esc(m.id) + '\')"></div>';
  });

  el.innerHTML = html;
}

// ─── FORCES ───
function renderForces(forces) {
  const el = document.getElementById('force-grid');
  if (!forces) return;
  const colors = {
    accelerating: { bar: 'var(--green)', cls: 'vel-accelerating', pct: 85 },
    steady: { bar: 'var(--blue)', cls: 'vel-steady', pct: 60 },
    shifting: { bar: 'var(--amber)', cls: 'vel-shifting', pct: 70 },
    intensifying: { bar: 'var(--red)', cls: 'vel-intensifying', pct: 80 },
    constraining: { bar: 'var(--pink)', cls: 'vel-constraining', pct: 75 },
    decelerating: { bar: 'var(--red)', cls: 'vel-decelerating', pct: 45 }
  };
  const ids = ['F1_technology','F2_demographics','F3_geopolitics','F4_capital','F5_psychology','F6_energy'];
  el.innerHTML = ids.map(id => {
    const f = forces[id];
    if (!f) return '';
    const c = colors[f.velocity] || colors.steady;
    const dataItems = (f.key_data || []).map(d => `<div class="force-datum">${esc(d)}</div>`).join('');
    const proj = f['2031_projection'] || '';
    return `<div class="glass force-card" onclick="this.classList.toggle('expanded')">
      <div class="force-header"><div class="force-name">${esc(f.name)}</div><div class="force-velocity ${c.cls}">${esc(f.velocity)}</div></div>
      <div class="force-metric">${esc(f.key_metric)}</div>
      <div class="force-bar"><div class="force-bar-fill" style="width:${c.pct}%;background:${c.bar}"></div></div>
      <div class="force-data">${dataItems}${proj ? `<div class="force-projection">2031: ${esc(proj)}</div>` : ''}</div>
    </div>`;
  }).join('');
}

// ─── MAP ───
function renderMap(profiles) {
  const el = document.getElementById('map-regions');
  if (!profiles) return;
  const layout = [
    { key: 'us', col: '2 / 5', row: '2 / 4' },
    { key: 'latam', col: '3 / 5', row: '4 / 6' },
    { key: 'eu', col: '5 / 8', row: '1 / 3' },
    { key: 'sea', col: '6 / 8', row: '3 / 5' },
    { key: 'mena', col: '8 / 10', row: '2 / 4' },
    { key: 'india', col: '9 / 11', row: '3 / 5' },
    { key: 'china', col: '9 / 11', row: '1 / 3' },
    { key: 'japan', col: '11 / 13', row: '1 / 3' },
  ];
  const velClass = v => { if (v.includes('fast')) return 'rv-fast'; if (v.includes('accelerating')) return 'rv-accelerating'; if (v.includes('moderate')) return 'rv-moderate'; return 'rv-nascent'; };
  el.innerHTML = layout.map(l => {
    const p = profiles[l.key];
    if (!p) return '';
    const shortVel = (p.transformation_velocity || '').split(' ')[0];
    return `<div class="region-node" style="grid-column:${l.col};grid-row:${l.row}" onclick="showRegionDetail('${l.key}', this)" data-key="${l.key}">
      <div class="region-emoji">${p.emoji || ''}</div><div class="region-name">${esc(p.name)}</div>
      <div class="region-vel ${velClass(p.transformation_velocity || '')}">${esc(shortVel)}</div>
    </div>`;
  }).join('');
  window._profiles = profiles;
}

function showRegionDetail(key, nodeEl) {
  const p = window._profiles[key];
  if (!p) return;
  document.querySelectorAll('.region-node').forEach(n => n.classList.remove('active'));
  if (nodeEl) nodeEl.classList.add('active');
  const el = document.getElementById('region-detail');
  const metrics = p.key_metrics || {};
  const metricsHtml = Object.entries(metrics).map(([k, v]) => `<div class="region-metric"><div class="rm-label">${esc(k.replace(/_/g, ' '))}</div><div class="rm-value">${esc(v)}</div></div>`).join('');
  const forces = (p.top_forces || []).map(f => `<div class="region-force-item">${esc(f)}</div>`).join('');
  const outlook = p['2031_outlook'] || '';
  el.innerHTML = `<div class="region-detail-header"><div class="region-detail-emoji">${p.emoji || ''}</div><div><div class="region-detail-name">${esc(p.name)}</div><div class="region-detail-vel">${esc(p.transformation_velocity || '')}</div></div></div>
    <div class="region-metrics">${metricsHtml}</div><div class="region-forces" style="margin-bottom:12px">${forces}</div>
    ${outlook ? `<div class="region-outlook"><strong>2031:</strong> ${esc(outlook)}</div>` : ''}`;
  el.classList.add('visible');
  el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// ─── FINDINGS ───
function renderFindings(findings) {
  const el = document.getElementById('findings-grid');
  if (!findings || !findings.length) return;
  document.getElementById('findings-count').textContent = findings.length;
  el.innerHTML = findings.map(f => {
    const confCls = f.confidence === 'high' ? 'conf-high' : 'conf-medium';
    return `<div class="glass finding" onclick="this.classList.toggle('expanded')"><div class="finding-header"><div class="finding-title">${esc(f.title)}</div><div class="finding-confidence ${confCls}">${esc(f.confidence)}</div></div><div class="finding-magnitude">${esc(f.magnitude)}</div><div class="finding-detail">${esc(f.detail)}</div></div>`;
  }).join('');
}

// ─── FRICTION ───
function renderFriction(friction) {
  const el = document.getElementById('friction-grid');
  if (!friction || !friction.length) return;
  el.innerHTML = friction.map(f => {
    const gapCls = f.fear_friction_gap >= 5 ? 'gap-high' : f.fear_friction_gap >= 3 ? 'gap-medium' : 'gap-low';
    return `<div class="friction-row"><div class="friction-sector">${esc(f.sector)}</div><div class="friction-bars"><div class="friction-bar-track"><div class="friction-bar-econ" style="width:${f.economic_readiness * 10}%"></div><div class="friction-bar-psych" style="width:${f.psychological_readiness * 10}%"></div></div></div><div class="friction-gap ${gapCls}">${f.fear_friction_gap}</div></div>`;
  }).join('');
}

// ─── MARKETS ───
function renderMarkets(markets) {
  const el = document.getElementById('markets-body');
  if (!markets || !markets.length) return;
  el.innerHTML = markets.map(m => {
    const cagr = parseFloat(m.cagr) || 0;
    const cagrCls = cagr >= 35 ? 'cagr-hot' : cagr >= 20 ? 'cagr-warm' : 'cagr-cool';
    return `<tr><td>${esc(m.category)}</td><td>${esc(m.size_2025)}</td><td>${esc(m.projected)}</td><td><span class="cagr-value ${cagrCls}">${esc(m.cagr)}</span></td></tr>`;
  }).join('');
}

// ─── TRAJECTORY ───
function renderTrajectory(items) {
  const el = document.getElementById('trajectory-grid');
  if (!items || !items.length) return;
  el.innerHTML = items.map(t => `<div class="trajectory-row"><div class="traj-metric">${esc(t.metric)}</div><div class="traj-baseline">${esc(t.baseline)}</div><div class="traj-arrow"><span>&rarr;</span> ${esc(t.direction)}</div><div class="traj-2031">${esc(t.est_2031)}</div></div>`).join('');
}

// ─── PEREZ ───
function renderPerez(perez) {
  const el = document.getElementById('perez-timeline');
  const sigEl = document.getElementById('perez-signals');
  if (!perez) return;
  const phases = [{name:'Irruption',years:'2020-22',cls:'past'},{name:'Frenzy',years:'2022-26',cls:'current'},{name:'Turning Point',years:'2026-28?',cls:''},{name:'Synergy',years:'2028-35?',cls:''},{name:'Maturity',years:'2035+',cls:''}];
  el.innerHTML = phases.map(p => {
    const marker = p.cls === 'current' ? '<div class="perez-marker"></div>' : '';
    return `<div class="perez-phase ${p.cls}"><div class="perez-phase-name">${p.name}</div><div class="perez-phase-years">${p.years}</div>${marker}</div>`;
  }).join('');
  const signals = perez.turning_point_signals || [];
  sigEl.innerHTML = signals.map(s => `<div class="force-datum">${esc(s)}</div>`).join('');
}

// ─── DISPLACEMENT ───
function renderDisplacement(wd) {
  const el = document.getElementById('displacement-grid');
  if (!wd) return;
  const wef = wd.wef_2030 || {};
  el.innerHTML = `
    <div class="glass-static disp-stat"><div class="disp-value" style="color:var(--green)">+${((wef.jobs_created||0)/1e6).toFixed(0)}M</div><div class="disp-label">Jobs Created by 2030</div><div class="disp-sub">WEF Future of Jobs 2025</div></div>
    <div class="glass-static disp-stat"><div class="disp-value" style="color:var(--red)">&minus;${((wef.jobs_displaced||0)/1e6).toFixed(0)}M</div><div class="disp-label">Jobs Displaced by 2030</div><div class="disp-sub">22% of all jobs disrupted</div></div>
    <div class="glass-static disp-stat"><div class="disp-value" style="color:var(--accent)">+${((wef.net_growth||0)/1e6).toFixed(0)}M</div><div class="disp-label">Net Job Growth</div><div class="disp-sub">but 59% won't get training</div></div>`;
}

// ─── DEFENSE ───
function renderDefense(def) {
  const el = document.getElementById('defense-grid');
  if (!def) return;
  const stats = [{value:def.global_defense_2026,label:'Global Defense 2026'},{value:def.us_dod_ai_autonomy,label:'US DoD AI Budget'},{value:def.us_dod_total,label:'US DoD Total'},{value:def.nato_target,label:'NATO Target'},{value:def.european_defense,label:'European Defense'},{value:def.china_defense,label:'China Defense'}];
  el.innerHTML = stats.map(s => `<div class="defense-stat"><div class="defense-value">${esc(s.value)}</div><div class="defense-label">${esc(s.label)}</div></div>`).join('');
}

// ─── SECTORS ───
function renderSectors(sectors) {
  const el = document.getElementById('sector-body');
  if (!sectors || !sectors.length) return;
  el.innerHTML = sectors.map(s => {
    const phaseCls = 'phase-' + (s.phase || '').replace(/\s+/g, '_');
    const emp26 = s.employment_2026 ? s.employment_2026 + 'M' : '--';
    const emp31 = s.employment_2031 ? s.employment_2031 + 'M' : '--';
    const changePct = s.change_pct || 0;
    const changeCls = changePct < 0 ? 'sector-change-neg' : 'sector-change-pos';
    const sign = changePct > 0 ? '+' : '';
    const changeStr = changePct ? `${sign}${changePct}%` : '--';
    return `<tr><td><strong>${esc(s.name)}</strong><br><span style="font-size:10px;color:var(--dim)">NAICS ${esc(s.naics)}</span></td><td><span class="sector-phase ${phaseCls}">${esc(s.phase)}</span></td><td>${emp26}</td><td>${emp31}</td><td><span class="sector-change ${changeCls}">${changeStr}</span></td><td style="font-size:11px;color:var(--text-secondary)">${esc(s.top_model)}</td></tr>`;
  }).join('');
}

// ─── INVENTORY ───
function renderInventory(inv) {
  const el = document.getElementById('evidence-list');
  if (!inv) return;
  let html = '<div style="font-size:11px;color:var(--text-secondary);margin-bottom:12px;">' + esc(inv.note || '') + '</div>';
  const sources = inv.sources || {};
  html += Object.entries(sources).map(([k, v]) => `<div class="evidence-card"><div style="display:flex;justify-content:space-between;align-items:center"><div class="evidence-name">${esc(k.replace(/_/g, ' '))}</div><div class="evidence-score">${v.count} models</div></div><div class="evidence-sector">${esc(v.file || '')}</div></div>`).join('');
  const cascades = inv.confirmed_cascades || [];
  if (cascades.length) {
    html += '<div style="margin-top:12px;font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:1px;font-weight:600;margin-bottom:8px">Confirmed Cascades</div>';
    html += cascades.map(c => `<div class="force-datum">${esc(c)}</div>`).join('');
  }
  el.innerHTML = html;
}

// ─── CYCLES ───
function renderCycles(cycles) {
  const el = document.getElementById('cycle-chart');
  if (!cycles || !cycles.length) return;
  document.getElementById('cycle-count').textContent = cycles.length + ' cycles';
  const max = Math.max(...cycles.map(c => c.models_constructed || 0), 1);
  el.innerHTML = cycles.map((c, i) => {
    const val = c.models_constructed || 0;
    const h = Math.max(8, (val / max) * 100);
    const opacity = 0.2 + (i / cycles.length) * 0.7;
    const isV3 = c.type === 'economy_map' || c.type === 'institutional_grade' || c.type === 'model_migration_expansion';
    const bg = isV3 ? 'linear-gradient(180deg, rgba(248,113,113,0.7), rgba(251,191,36,0.5))' : 'linear-gradient(180deg, rgba(167,139,250,0.7), rgba(96,165,250,0.5))';
    return `<div class="cycle-bar" style="height:${h}%;background:${bg};opacity:${opacity.toFixed(2)}" data-label="${c.cycle}"></div>`;
  }).join('');
}

// ─── TIMELINE ───
function renderTimeline(models) {
  if (!models || !models.length) return;
  const cohorts = {
    'TG 8-9': { label: '2026 Entry', color: 'var(--green)', models: [] },
    'TG 6-7': { label: '2027-28', color: 'var(--blue)', models: [] },
    'TG 3-5': { label: '2029-31', color: 'var(--amber)', models: [] },
    'TG 1-2': { label: 'Long Horizon', color: 'var(--dim)', models: [] },
  };
  models.forEach(m => {
    const tg = (m.scores || {}).TG || 5;
    if (tg >= 8) cohorts['TG 8-9'].models.push(m);
    else if (tg >= 6) cohorts['TG 6-7'].models.push(m);
    else if (tg >= 3) cohorts['TG 3-5'].models.push(m);
    else cohorts['TG 1-2'].models.push(m);
  });

  // KPIs
  const kpiEl = document.getElementById('timeline-kpis');
  const kpiData = [
    { label: 'Ready Now', sub: 'TG 8-9 • 2026 entry', value: cohorts['TG 8-9'].models.length, color: 'var(--green)' },
    { label: 'Building', sub: 'TG 6-7 • 2027-28', value: cohorts['TG 6-7'].models.length, color: 'var(--blue)' },
    { label: 'Emerging', sub: 'TG 3-5 • 2029-31', value: cohorts['TG 3-5'].models.length, color: 'var(--amber)' },
    { label: 'Long Horizon', sub: 'TG 1-2', value: cohorts['TG 1-2'].models.length, color: 'var(--dim)' },
  ];
  kpiEl.innerHTML = kpiData.map(k =>
    `<div class="glass kpi"><div class="kpi-label">${k.label}</div><div class="kpi-value" style="color:${k.color}">${k.value}</div><div class="kpi-sub">${k.sub}</div></div>`
  ).join('');

  // Wave bar chart
  const waveEl = document.getElementById('timeline-wave');
  const maxCount = Math.max(...Object.values(cohorts).map(c => c.models.length), 1);
  const confCount = (arr, tier) => arr.filter(m => m.confidence_tier === tier).length;
  waveEl.innerHTML = '<div style="display:flex;gap:8px;align-items:flex-end;height:140px">' +
    Object.entries(cohorts).map(([key, c]) => {
      const h = Math.max(12, (c.models.length / maxCount) * 130);
      const high = confCount(c.models, 'HIGH');
      const mod = confCount(c.models, 'MODERATE');
      const low = confCount(c.models, 'LOW');
      const total = c.models.length;
      const hPct = total ? (high / total * 100) : 0;
      const mPct = total ? (mod / total * 100) : 0;
      return `<div style="flex:1;text-align:center">
        <div style="font-size:18px;font-weight:700;color:${c.color};margin-bottom:4px">${total}</div>
        <div style="height:${h}px;border-radius:var(--radius-xs);overflow:hidden;display:flex;flex-direction:column" title="${key}: ${high} HIGH, ${mod} MODERATE, ${low} LOW">
          <div style="flex:${hPct || 0.01};background:rgba(52,211,153,0.35)"></div>
          <div style="flex:${mPct || 0.01};background:rgba(251,191,36,0.25)"></div>
          <div style="flex:${100 - hPct - mPct || 0.01};background:rgba(248,113,113,0.2)"></div>
        </div>
        <div style="font-size:9px;color:var(--dim);margin-top:6px;font-weight:600">${c.label}</div>
      </div>`;
    }).join('') +
    '</div>' +
    '<div style="display:flex;gap:12px;justify-content:center;margin-top:10px;font-size:9px;color:var(--text-secondary)">' +
    '<span><span style="display:inline-block;width:8px;height:8px;border-radius:2px;background:rgba(52,211,153,0.5);margin-right:3px"></span>HIGH</span>' +
    '<span><span style="display:inline-block;width:8px;height:8px;border-radius:2px;background:rgba(251,191,36,0.4);margin-right:3px"></span>MODERATE</span>' +
    '<span><span style="display:inline-block;width:8px;height:8px;border-radius:2px;background:rgba(248,113,113,0.35);margin-right:3px"></span>LOW</span>' +
    '</div>';

  // Cohort detail lists
  function renderCohortList(elId, arr) {
    const el = document.getElementById(elId);
    if (!el) return;
    const sorted = arr.slice().sort((a, b) => (b.composite || 0) - (a.composite || 0));
    const show = sorted.slice(0, 15);
    el.innerHTML = show.map(m => {
      const confCls = 'conf-' + (m.confidence_tier || 'LOW');
      return `<div style="display:flex;justify-content:space-between;align-items:center;padding:2px 0;border-bottom:1px solid rgba(255,255,255,0.03)">
        <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(m.name)}</span>
        <span style="display:flex;gap:6px;align-items:center;flex-shrink:0;margin-left:8px">
          <span style="color:var(--amber);font-weight:600;font-size:10px">T${(m.composite||0).toFixed(0)}</span>
          <span class="confidence-badge ${confCls}" style="font-size:7px;padding:1px 4px">${(m.confidence_tier||'LOW')[0]}</span>
        </span>
      </div>`;
    }).join('');
    if (sorted.length > 15) {
      el.innerHTML += `<div style="color:var(--dim);font-size:10px;margin-top:6px">+ ${sorted.length - 15} more</div>`;
    }
  }
  renderCohortList('cohort-now', cohorts['TG 8-9'].models);
  renderCohortList('cohort-build', cohorts['TG 6-7'].models);
}

// ─── RESEARCH PRIORITY QUEUE ───
function renderResearchPriorities(dashboard) {
  const el = document.getElementById('research-priority-queue');
  const rpq = (dashboard || {}).research_priorities;
  if (!rpq || !rpq.length) { el.innerHTML = '<div style="color:var(--dim)">No research priorities available</div>'; return; }
  const countEl = document.getElementById('rpq-count');
  if (countEl) countEl.textContent = rpq.length + ' models — high T-rank + low confidence — prioritized for deeper research';

  el.innerHTML = '<table style="width:100%;border-collapse:collapse">' +
    '<thead><tr style="font-size:9px;color:var(--dim);text-transform:uppercase;letter-spacing:0.5px;text-align:left">' +
    '<th style="padding:4px 6px;font-weight:600">#</th>' +
    '<th style="padding:4px 6px;font-weight:600">Name</th>' +
    '<th style="padding:4px 6px;font-weight:600">T</th>' +
    '<th style="padding:4px 6px;font-weight:600">O</th>' +
    '<th style="padding:4px 6px;font-weight:600">VCR</th>' +
    '<th style="padding:4px 6px;font-weight:600">Conf</th>' +
    '<th style="padding:4px 6px;font-weight:600">Evid</th>' +
    '</tr></thead><tbody>' +
    rpq.map(r => {
      const confCls = 'conf-' + (r.confidence_tier || 'LOW');
      const evStars = '●'.repeat(r.evidence_quality || 1) + '○'.repeat(Math.max(0, 5 - (r.evidence_quality || 1)));
      return `<tr style="border-bottom:1px solid rgba(255,255,255,0.03)">
        <td style="padding:5px 6px;color:var(--dim);font-size:10px">${r.rank}</td>
        <td style="padding:5px 6px;max-width:280px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(r.name)}</td>
        <td style="padding:5px 6px;color:var(--amber);font-weight:600">${(r.composite||0).toFixed(1)}</td>
        <td style="padding:5px 6px;color:var(--green)">${(r.opportunity_composite||0).toFixed(1)}</td>
        <td style="padding:5px 6px;color:var(--blue)">${(r.vcr_composite||0).toFixed(1)}</td>
        <td style="padding:5px 6px"><span class="confidence-badge ${confCls}" style="font-size:7px;padding:1px 4px">${(r.confidence_tier||'LOW')}</span></td>
        <td style="padding:5px 6px;font-size:9px;color:var(--text-secondary);letter-spacing:-0.5px">${evStars}</td>
      </tr>`;
    }).join('') +
    '</tbody></table>';
}

// ─── CATALYST WATCH ───
function renderCatalystDetail(cs) {
  if (!cs) return '';
  const triggers = (cs.triggers || []).map(t =>
    `<li style="font-size:11px;margin-bottom:6px;color:var(--text-secondary)">
      <strong style="color:var(--text)">${esc(t.event)}</strong><br>
      <span style="font-size:9px;color:var(--dim)">P(2yr): ${(t.probability_2yr*100).toFixed(0)}% &middot; P(5yr): ${(t.probability_5yr*100).toFixed(0)}%</span>
    </li>`
  ).join('');
  const chain = (cs.propagation_chain || []).map(s => esc(s)).join(' &rarr; ');
  return `
    <div style="margin-top:12px;padding:10px 12px;background:rgba(251,191,36,0.05);border-radius:var(--radius-xs);border-left:3px solid #f59e0b">
      <div style="font-size:10px;color:#f59e0b;font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px">Catalyst Scenario: ${esc(cs.cluster_name || cs.cluster)}</div>
      <div style="display:flex;gap:16px;margin-bottom:8px">
        <div style="font-size:11px;color:var(--text-secondary)">Current: <strong style="color:var(--dim)">${(cs.current_composite||0).toFixed(1)}</strong></div>
        <div style="font-size:11px;color:var(--text-secondary)">Conditional: <strong style="color:#f59e0b">${(cs.conditional_composite||0).toFixed(1)}</strong></div>
        <div style="font-size:11px;color:var(--text-secondary)">Asymmetry: <strong style="color:#f59e0b">${(cs.asymmetry_ratio||0).toFixed(2)}x</strong></div>
        <div style="font-size:11px;color:var(--text-secondary)">Timeline: <strong>${esc(cs.timeline || '?')}</strong></div>
      </div>
      <div style="font-size:10px;color:var(--dim);font-weight:600;margin-bottom:4px">TRIGGERS</div>
      <ul style="margin:0;padding-left:16px">${triggers}</ul>
      <div style="font-size:10px;color:var(--dim);font-weight:600;margin-top:8px;margin-bottom:4px">PROPAGATION CHAIN</div>
      <div style="font-size:10px;color:var(--text-secondary)">${chain}</div>
    </div>`;
}

function renderCatalystWatch(models) {
  if (!models || !models.length) return;
  const catModels = models.filter(m => m.catalyst_scenario);
  if (!catModels.length) return;

  // Group by cluster
  const clusters = {};
  catModels.forEach(m => {
    const cid = m.catalyst_scenario.cluster;
    if (!clusters[cid]) clusters[cid] = { name: m.catalyst_scenario.cluster_name, models: [] };
    clusters[cid].models.push(m);
  });

  // Sort clusters by model count desc
  const sortedClusters = Object.entries(clusters).sort((a,b) => b[1].models.length - a[1].models.length);

  // KPIs
  const kpiEl = document.getElementById('catalyst-kpis');
  const ratios = catModels.map(m => m.catalyst_scenario.asymmetry_ratio);
  const maxRatio = Math.max(...ratios);
  const avgRatio = ratios.reduce((a,b) => a+b, 0) / ratios.length;
  kpiEl.innerHTML = [
    { label: 'Catalyst Models', value: catModels.length },
    { label: 'Clusters', value: sortedClusters.length },
    { label: 'Max Asymmetry', value: maxRatio.toFixed(1) + 'x' },
    { label: 'Avg Asymmetry', value: avgRatio.toFixed(2) + 'x' },
  ].map(k => `<div class="kpi glass"><div class="kpi-value">${k.value}</div><div class="kpi-label">${k.label}</div></div>`).join('');

  // Cluster cards
  const el = document.getElementById('catalyst-clusters');
  el.innerHTML = sortedClusters.map(([cid, cluster]) => {
    const ms = cluster.models.sort((a,b) => b.catalyst_scenario.asymmetry_ratio - a.catalyst_scenario.asymmetry_ratio);
    const sample = ms[0].catalyst_scenario;
    const triggers = (sample.triggers || []).map(t =>
      `<div style="font-size:10px;margin-bottom:4px;color:var(--text-secondary)">
        <span style="color:#f59e0b">&bull;</span> ${esc(t.event)}
        <span style="font-size:8px;color:var(--dim)">(P(2yr)=${(t.probability_2yr*100).toFixed(0)}%, P(5yr)=${(t.probability_5yr*100).toFixed(0)}%)</span>
      </div>`
    ).join('');
    const chain = (sample.propagation_chain || []).map(s => esc(s)).join(' &rarr; ');
    const modelRows = ms.map(m => {
      const cs = m.catalyst_scenario;
      const catCls = 'cat-' + (m.category || 'PARKED');
      return `<tr style="border-bottom:1px solid rgba(255,255,255,0.03)">
        <td style="padding:4px 6px;font-size:10px;color:var(--dim);font-family:var(--mono)">${esc(m.id)}</td>
        <td style="padding:4px 6px;font-size:11px;max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(m.name)}</td>
        <td style="padding:4px 6px;font-size:11px;color:var(--dim);text-align:right">${cs.current_composite.toFixed(1)}</td>
        <td style="padding:4px 6px;font-size:11px;color:#f59e0b;font-weight:600;text-align:right">${cs.conditional_composite.toFixed(1)}</td>
        <td style="padding:4px 6px;font-size:11px;color:#f59e0b;font-weight:700;text-align:right">${cs.asymmetry_ratio.toFixed(2)}x</td>
        <td style="padding:4px 6px"><span class="cat-badge ${catCls}" style="font-size:7px;padding:1px 4px">${esc((m.category||'').replace(/_/g,' '))}</span></td>
      </tr>`;
    }).join('');
    return `<div class="glass-static card" style="margin-bottom:16px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-size:13px;font-weight:700;color:#f59e0b">${esc(cluster.name)}</div>
        <div style="font-size:10px;color:var(--dim)">${ms.length} models &middot; Timeline: ${esc(sample.timeline || '?')}</div>
      </div>
      <div style="margin-bottom:10px">${triggers}</div>
      <div style="font-size:9px;color:var(--dim);margin-bottom:10px"><span style="font-weight:600">Propagation:</span> ${chain}</div>
      <table style="width:100%;border-collapse:collapse">
        <thead><tr style="border-bottom:1px solid rgba(255,255,255,0.08)">
          <th style="padding:4px 6px;font-size:8px;color:var(--dim);text-align:left;text-transform:uppercase;letter-spacing:1px">ID</th>
          <th style="padding:4px 6px;font-size:8px;color:var(--dim);text-align:left;text-transform:uppercase;letter-spacing:1px">Name</th>
          <th style="padding:4px 6px;font-size:8px;color:var(--dim);text-align:right;text-transform:uppercase;letter-spacing:1px">Current</th>
          <th style="padding:4px 6px;font-size:8px;color:#f59e0b;text-align:right;text-transform:uppercase;letter-spacing:1px">Cond.</th>
          <th style="padding:4px 6px;font-size:8px;color:#f59e0b;text-align:right;text-transform:uppercase;letter-spacing:1px">Ratio</th>
          <th style="padding:4px 6px;font-size:8px;color:var(--dim);text-align:left;text-transform:uppercase;letter-spacing:1px">Cat</th>
        </tr></thead>
        <tbody>${modelRows}</tbody>
      </table>
    </div>`;
  }).join('');
}

// ─── NARRATIVE CONTROLS ───
document.getElementById('narr-search').addEventListener('input', () => applyNarrFilters());
document.getElementById('narr-sort').addEventListener('change', () => applyNarrFilters());

const tnsAxisColor = {
  EM: 'var(--green)', FC: 'var(--blue)', ES: 'var(--amber)', TC: 'var(--cyan)', IR: 'var(--accent)'
};

function setNarrCatFilter(cat) {
  activeNarrCatFilter = activeNarrCatFilter === cat ? null : cat;
  document.querySelectorAll('#narr-cat-filters .filter-chip').forEach(c => {
    c.classList.toggle('active', c.dataset.cat === activeNarrCatFilter);
  });
  applyNarrFilters();
}

function applyNarrFilters() {
  const q = document.getElementById('narr-search').value.toLowerCase().trim();
  const sort = document.getElementById('narr-sort').value;

  filteredNarratives = allNarratives.filter(n => {
    if (activeNarrCatFilter && n.tns_category !== activeNarrCatFilter) return false;
    if (!q) return true;
    const haystack = [n.name, n.narrative_id, ...(n.sectors||[]).map(s=>s.naics||s), ...(n.forces||[])].join(' ').toLowerCase();
    return haystack.includes(q);
  });

  filteredNarratives.sort((a, b) => {
    switch(sort) {
      case 'tns-desc': return b.tns_composite - a.tns_composite;
      case 'models-desc': return (b.model_counts?.total||0) - (a.model_counts?.total||0);
      case 'name': return (a.name||'').localeCompare(b.name||'');
      default: return (a.tns_rank||999) - (b.tns_rank||999);
    }
  });

  document.getElementById('narr-results-info').textContent = filteredNarratives.length + ' narrative' + (filteredNarratives.length !== 1 ? 's' : '') + ' — click a row to expand timeline, models, and geographic detail';
  renderNarrativeList();
}

function renderNarrCatFilters() {
  const cats = {};
  allNarratives.forEach(n => { cats[n.tns_category] = (cats[n.tns_category]||0) + 1; });
  const order = ['DEFINING','MAJOR','MODERATE','EMERGING','SPECULATIVE'];
  document.getElementById('narr-cat-filters').innerHTML = order
    .filter(c => cats[c])
    .map(c => `<span class="filter-chip tns-${c}" data-cat="${c}" onclick="setNarrCatFilter('${c}')" style="cursor:pointer;padding:3px 10px;border-radius:5px;font-size:10px;font-weight:600">${c} <span style="opacity:0.6">${cats[c]}</span></span>`)
    .join('');
}

function renderNarrativeList() {
  const container = document.getElementById('narr-list-container');
  const tnsAxes = ['EM','FC','ES','TC','IR'];

  const rows = filteredNarratives.map(n => {
    const scores = n.tns_scores || {};
    const axisHtml = tnsAxes.map(a => {
      const v = scores[a] || 0;
      const pct = (v / 10) * 100;
      return `<div class="narr-axis-bar">
        <div class="axis-bar-label">${a}</div>
        <div class="axis-bar-track"><div class="axis-bar-fill" style="width:${pct}%;background:${tnsAxisColor[a]}"></div></div>
        <div class="axis-bar-val">${v.toFixed(1)}</div>
      </div>`;
    }).join('');

    const mc = n.model_counts || {};
    const sectorText = (n.sectors||[]).map(s => typeof s === 'string' ? s : (s.naics||'')).join(', ');

    return `<tr class="narr-row${expandedNarrId===n.narrative_id?' expanded':''}" onclick="toggleNarrDetail('${esc(n.narrative_id)}')">
      <td class="rank-cell"><span class="narr-expand-icon">&#9654;</span> ${n.tns_rank || '--'}</td>
      <td class="name-cell" style="max-width:280px">${esc(n.name)}</td>
      <td style="font-weight:700;color:${n.tns_composite >= 80 ? 'var(--green)' : n.tns_composite >= 65 ? 'var(--blue)' : 'var(--text)'}">${(n.tns_composite||0).toFixed(1)}</td>
      <td><span class="tns-badge tns-${n.tns_category||'SPECULATIVE'}">${n.tns_category||'--'}</span></td>
      <td><div class="narr-axes">${axisHtml}</div></td>
      <td><span class="narr-phase">${esc((n.transformation_phase||'').replace(/_/g, ' '))}</span></td>
      <td><div class="narr-model-count">
        ${mc.what_works ? '<span class="nmc-works">' + mc.what_works + ' works</span>' : ''}
        ${mc.whats_needed ? '<span class="nmc-needed">' + mc.whats_needed + ' needed</span>' : ''}
        ${mc.what_dies ? '<span class="nmc-dies">' + mc.what_dies + ' dies</span>' : ''}
      </div></td>
      <td style="font-size:10px;color:var(--dim)">${esc(sectorText)}</td>
    </tr>
    <tr id="narr-detail-${esc(n.narrative_id)}" style="display:none"><td colspan="8">
      <div class="narr-detail expanded">${renderNarrDetailContent(n)}</div>
    </td></tr>`;
  }).join('');

  container.innerHTML = `<div class="glass-static" style="overflow-x:auto"><table class="narr-table">
    <thead><tr>
      <th>#</th><th>Narrative</th><th>TNS</th><th>Category</th><th>Axes</th><th>Phase</th><th>Models</th><th>Sectors</th>
    </tr></thead>
    <tbody>${rows}</tbody>
  </table></div>`;
}

function toggleNarrDetail(nid) {
  const row = document.getElementById('narr-detail-' + nid);
  if (!row) return;
  // Remove expanded class from all rows
  document.querySelectorAll('.narr-row.expanded').forEach(r => r.classList.remove('expanded'));
  if (expandedNarrId === nid) {
    row.style.display = 'none';
    expandedNarrId = null;
  } else {
    if (expandedNarrId) {
      const prev = document.getElementById('narr-detail-' + expandedNarrId);
      if (prev) prev.style.display = 'none';
    }
    row.style.display = '';
    expandedNarrId = nid;
    // Add expanded class to the clicked row
    row.previousElementSibling.classList.add('expanded');
  }
}

function renderNarrDetailContent(n) {
  const yby = n.year_by_year || {};
  const years = Object.keys(yby).sort();
  const timelineHtml = years.map(y => {
    const d = yby[y];
    return `<div class="narr-timeline-year">
      <span class="year">${esc(y)}</span>
      <span class="phase-tag">${esc((d.phase||'').replace(/_/g,' '))}</span>
      <span class="desc">${esc((d.description||'').substring(0, 200))}</span>
    </div>`;
  }).join('');

  const geo = n.geographic_variation || {};
  const geoHtml = Object.entries(geo).map(([r, d]) =>
    `<div style="font-size:11px;display:flex;gap:8px"><span style="color:var(--accent);min-width:40px;font-weight:600">${esc(r)}</span><span style="color:var(--text-secondary)">${esc(d.velocity||'--')} (shift: ${d.timeline_shift||0}yr)</span></div>`
  ).join('');

  const outputs = n.outputs || {};
  const modelListHtml = (bucket, label, cls) => {
    const ids = outputs[bucket] || [];
    if (!ids.length) return '';
    return `<div style="margin-bottom:8px"><div style="font-size:9px;text-transform:uppercase;color:var(--dim);margin-bottom:4px;letter-spacing:0.5px">${label} (${ids.length})</div>
      <div class="narr-model-list">${ids.slice(0, 10).map(id => {
        const m = allModels.find(x => x.id === id);
        const name = m ? m.name : id;
        const comp = m ? m.composite.toFixed(1) : '--';
        return `<div class="narr-model-item ${cls}" onclick="event.stopPropagation();document.querySelector('[data-view=models]').click();document.getElementById('model-search').value='${esc(id)}';document.getElementById('model-search').dispatchEvent(new Event('input'))">${esc(name)} <span style="color:var(--dim);font-size:10px">T:${comp}</span></div>`;
      }).join('')}${ids.length > 10 ? '<div style="font-size:10px;color:var(--dim);padding:2px 8px">+' + (ids.length - 10) + ' more</div>' : ''}</div></div>`;
  };

  const summaryHtml = n.summary ? `<div style="font-size:11px;color:var(--text-secondary);line-height:1.6;margin-bottom:12px;max-width:700px">${esc(n.summary.substring(0, 500))}</div>` : '';

  const fearHtml = n.fear_friction ? `<div style="font-size:11px;margin-top:4px"><span style="color:var(--dim)">Fear friction gap:</span> <span style="color:${(n.fear_friction.gap||0) >= 3 ? 'var(--red)' : (n.fear_friction.gap||0) >= 1 ? 'var(--amber)' : 'var(--green)'};font-weight:600">${n.fear_friction.gap||0}</span> <span style="color:var(--dim)">(econ: ${n.fear_friction.economic_readiness||'--'}, psych: ${n.fear_friction.psychological_readiness||'--'})</span></div>` : '';

  return `${summaryHtml}${fearHtml}
    <div class="narr-detail-grid">
      <div class="narr-detail-section"><h4>Year-by-Year Timeline</h4><div class="narr-timeline">${timelineHtml || '<span style="color:var(--dim);font-size:11px">No timeline data</span>'}</div></div>
      <div class="narr-detail-section"><h4>Geographic Variation</h4>${geoHtml || '<span style="color:var(--dim);font-size:11px">No geographic data</span>'}</div>
      <div class="narr-detail-section"><h4>Models</h4>
        ${modelListHtml('what_works', 'What Works', 'nmc-works')}
        ${modelListHtml('whats_needed', "What's Needed", 'nmc-needed')}
        ${modelListHtml('what_dies', 'What Dies', 'nmc-dies')}
      </div>
      <div class="narr-detail-section"><h4>Confidence</h4>
        ${n.confidence ? Object.entries(n.confidence).map(([k,v]) => `<div style="font-size:11px;display:flex;gap:6px"><span style="color:var(--dim);min-width:70px">${esc(k)}</span><span style="color:${v==='high'?'var(--green)':v==='medium'?'var(--amber)':'var(--red)'};font-weight:600">${esc(v)}</span></div>`).join('') : '<span style="color:var(--dim);font-size:11px">--</span>'}
      </div>
    </div>`;
}

// ─── CASCADE RENDERING ───
function renderCascades(dashboard) {
  const graph = dashboard.cascade_graph || {};
  const nodes = graph.nodes || [];
  const edges = graph.edges || [];

  // Render cascade dependency graph
  const graphContainer = document.getElementById('cascade-graph-container');
  if (edges.length > 0) {
    const edgeHtml = edges.map(e => {
      const fromNode = nodes.find(n => n.id === e.from);
      const toNode = nodes.find(n => n.id === e.to);
      return `<div class="cascade-edge">
        <span class="tns-badge tns-${fromNode?.category||'MODERATE'}" style="font-size:9px">${esc(fromNode?.name||e.from)}</span>
        <span class="cascade-edge-arrow">&rarr;</span>
        <span class="tns-badge tns-${toNode?.category||'MODERATE'}" style="font-size:9px">${esc(toNode?.name||e.to)}</span>
        <span style="font-size:9px;color:var(--dim);margin-left:4px">${esc(e.type||'')}</span>
      </div>`;
    }).join('');
    graphContainer.innerHTML = `<div class="glass-static card"><h3 style="font-size:13px;margin-bottom:12px;color:var(--text)">Narrative Dependencies</h3>${edgeHtml}</div>`;
  } else {
    graphContainer.innerHTML = '';
  }

  // Render cascade chain cards
  const listContainer = document.getElementById('cascade-list-container');
  const totalCascades = dashboard.total_cascades || 0;
  if (totalCascades === 0 && edges.length === 0) {
    listContainer.innerHTML = '<div style="color:var(--dim);font-size:12px;padding:20px">No cascade data available.</div>';
    return;
  }

  // We show cascade edges as the primary view since cascade detail is in cascades.json (not loaded separately for now)
  const nodeCards = nodes.map(n => {
    const outEdges = edges.filter(e => e.from === n.id);
    const inEdges = edges.filter(e => e.to === n.id);
    if (outEdges.length === 0 && inEdges.length === 0) return '';
    return `<div class="glass cascade-card">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
        <span class="tns-badge tns-${n.category}" style="font-size:10px">${esc(n.category)}</span>
        <span style="font-weight:600;font-size:13px">${esc(n.name)}</span>
        <span style="color:var(--dim);font-size:11px">TNS ${(n.tns||0).toFixed(1)}</span>
      </div>
      ${outEdges.length ? '<div style="font-size:10px;color:var(--dim);margin-bottom:4px">Drives:</div>' + outEdges.map(e => {
        const to = nodes.find(x => x.id === e.to);
        return `<div style="font-size:11px;padding:2px 0;color:var(--text-secondary)">&rarr; ${esc(to?.name||e.to)}</div>`;
      }).join('') : ''}
      ${inEdges.length ? '<div style="font-size:10px;color:var(--dim);margin-bottom:4px;margin-top:6px">Driven by:</div>' + inEdges.map(e => {
        const from = nodes.find(x => x.id === e.from);
        return `<div style="font-size:11px;padding:2px 0;color:var(--text-secondary)">&larr; ${esc(from?.name||e.from)}</div>`;
      }).join('') : ''}
    </div>`;
  }).filter(Boolean).join('');

  listContainer.innerHTML = nodeCards || '<div style="color:var(--dim);font-size:12px;padding:20px">Cascade dependencies visible in Narrative detail panels.</div>';
}

// ─── MAIN ───
async function refresh() {
  const [d, m, narr] = await Promise.all([
    load(BASE + '/dashboard.json'),
    load(BASE + '/models.json'),
    load(BASE + '/narratives.json')
  ]);

  if (d) {
    // Header
    document.getElementById('cycle-badge').textContent = d.current_cycle || 'v4-0';
    const ts = d.last_updated;
    document.getElementById('last-updated').textContent = ts ? new Date(ts).toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'}) : '--';

    // Model-centric KPIs
    const totalModels = d.total_models || 0;
    const totalNarr = d.total_narratives || 0;
    if (totalModels) document.getElementById('kpi-rated').textContent = totalModels;
    if (totalNarr) document.getElementById('kpi-narratives').textContent = totalNarr;

    // Defining count for narrative sub-label
    const tnsCatDist = d.tns_category_distribution || {};
    if (tnsCatDist.DEFINING !== undefined) document.getElementById('kpi-narr-cat-sub').textContent = tnsCatDist.DEFINING + ' defining';

    // Forces accelerating
    const fSum = d.force_summary || {};
    const accCount = Object.values(fSum).filter(f => f.velocity === 'accelerating').length;
    document.getElementById('kpi-forces-sub').textContent = accCount + ' accelerating';

    // Subtitles
    if (totalNarr) document.getElementById('narr-total-sub').textContent = totalNarr + ' narratives';
    if (totalModels) document.getElementById('model-total-sub').textContent = totalModels + ' models';

    // Render cascades view
    renderCascades(d);

    // Render sections with v4 data
    renderWhatsNew(d);
    renderForces(d.force_velocities);
    renderSectors(d.sector_transformations);
    renderMap(d.geographic_profiles);
    renderFindings(d.key_findings);
    renderFriction(d.fear_friction_index);
    renderMarkets(d.fear_driven_markets);
    renderTrajectory(d.sentiment_trajectory);
    renderPerez(d.perez_cycle);
    renderDisplacement(d.worker_displacement);
    renderDefense(d.defense_ai);
    renderInventory(d.model_inventory);
    renderCycles(d.cycle_history);
    renderVcrArchBreakdown(d);
    renderVcrTriList(d);
    renderPatterns(d);
    renderForceDistribution(d);
    renderResearchPriorities(d);

    // VCR KPIs
    const vcrStats = d.vcr_stats || {};
    const vcrRoi = d.vcr_roi_stats || {};
    const vcrCatDist = d.vcr_category_distribution || {};
    if (vcrCatDist.FUND_RETURNER !== undefined) document.getElementById('vcr-kpi-fund').textContent = vcrCatDist.FUND_RETURNER;
    if (vcrRoi.mean) document.getElementById('vcr-kpi-avg-roi').textContent = vcrRoi.mean + 'x';
    if (vcrRoi.median) document.getElementById('vcr-kpi-med-roi').textContent = vcrRoi.median + 'x';
    if (vcrRoi.above_10x !== undefined) document.getElementById('vcr-kpi-10x').textContent = vcrRoi.above_10x;
    if (vcrRoi.above_50x !== undefined) document.getElementById('vcr-kpi-50x').textContent = vcrRoi.above_50x;
    if (vcrStats.max) document.getElementById('vcr-kpi-top').textContent = vcrStats.max;
  }

  // Models
  if (m && m.models) {
    allModels = m.models;

    // Model-centric KPIs
    const swCount = allModels.filter(x => x.category === 'STRUCTURAL_WINNER').length;
    const frCount = allModels.filter(x => (x.vcr_composite || 0) >= 75).length;
    const comps = allModels.map(x => x.composite || 0);
    const topT = comps.length ? Math.max(...comps) : 0;
    const meanT = comps.length ? (comps.reduce((a,b) => a+b, 0) / comps.length) : 0;
    document.getElementById('kpi-sw').textContent = swCount;
    document.getElementById('kpi-fr').textContent = frCount;
    if (topT) document.getElementById('kpi-top-t').textContent = topT.toFixed(1);
    document.getElementById('kpi-t-mean-sub').textContent = 'mean ' + meanT.toFixed(1);
    document.getElementById('kpi-model-sub').textContent = 'triple ranked';

    renderCatFilters(m.summary || {});
    renderOppCatFilters(m.summary || {});
    renderVcrCatFilters(m.summary || {});
    renderConfidenceFilters(allModels);
    renderForceFilters(allModels);
    renderFrSubtypeFilters(allModels);
    renderScatterPlot(allModels);
    renderTimeline(allModels);
    renderCatalystWatch(allModels);
    applyFilters();
    applyVcrFilters();
  }

  // Narratives
  if (narr && narr.narratives) {
    narrativeData = narr;
    allNarratives = narr.narratives;
    filteredNarratives = [...allNarratives];
    renderNarrCatFilters();
    applyNarrFilters();

    // Populate narrative filter dropdown in Models tab
    const nfEl = document.getElementById('narr-filter');
    if (nfEl && nfEl.options.length <= 1) {
      allNarratives.forEach(n => {
        const opt = document.createElement('option');
        opt.value = n.narrative_id;
        opt.textContent = n.name + ' (' + (n.tns_category || '') + ')';
        nfEl.appendChild(opt);
      });
    }
  }
}

refresh();
setInterval(refresh, 30000);
</script>
</body>
</html>
