<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Business Model Engine v3.3</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,300;14..32,400;14..32,500;14..32,600;14..32,700;14..32,800;14..32,900&display=swap');

  :root {
    --bg: #06060b;
    --surface: rgba(255,255,255,0.025);
    --surface-hover: rgba(255,255,255,0.045);
    --glass: rgba(255,255,255,0.03);
    --glass-border: rgba(255,255,255,0.055);
    --glass-border-hover: rgba(255,255,255,0.1);
    --text: #ededf4;
    --text-secondary: #8e8ea0;
    --dim: #4e4e6a;
    --accent: #a78bfa;
    --accent-soft: rgba(167,139,250,0.12);
    --green: #34d399;
    --green-dim: rgba(52,211,153,0.08);
    --red: #f87171;
    --red-dim: rgba(248,113,113,0.06);
    --amber: #fbbf24;
    --amber-dim: rgba(251,191,36,0.06);
    --blue: #60a5fa;
    --blue-dim: rgba(96,165,250,0.06);
    --cyan: #22d3ee;
    --cyan-dim: rgba(34,211,238,0.06);
    --pink: #f472b6;
    --gradient-hero: linear-gradient(135deg, rgba(167,139,250,0.08) 0%, rgba(96,165,250,0.05) 50%, rgba(52,211,153,0.03) 100%);
    --gradient-accent: linear-gradient(135deg, #a78bfa, #818cf8, #60a5fa);
    --gradient-warm: linear-gradient(135deg, #f87171, #fbbf24);
    --gradient-cool: linear-gradient(135deg, #60a5fa, #22d3ee);
    --radius: 14px;
    --radius-sm: 8px;
    --radius-xs: 6px;
    --blur: 24px;
    --transition: 0.18s cubic-bezier(0.4, 0, 0.2, 1);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    font-size: 13.5px;
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    min-height: 100dvh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    top: -50%; left: -30%;
    width: 90%; height: 90%;
    background: radial-gradient(ellipse at 30% 30%, rgba(167,139,250,0.035) 0%, transparent 55%);
    pointer-events: none; z-index: 0;
  }
  body::after {
    content: '';
    position: fixed;
    bottom: -40%; right: -25%;
    width: 80%; height: 80%;
    background: radial-gradient(ellipse at 70% 70%, rgba(52,211,153,0.02) 0%, transparent 55%);
    pointer-events: none; z-index: 0;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 32px 24px;
    padding-top: max(32px, env(safe-area-inset-top));
    padding-bottom: max(48px, env(safe-area-inset-bottom));
    position: relative;
    z-index: 1;
  }

  /* Nav */
  nav {
    display: flex;
    gap: 2px;
    margin-bottom: 32px;
    background: var(--glass);
    backdrop-filter: blur(var(--blur));
    border: 1px solid var(--glass-border);
    border-radius: 10px;
    padding: 3px;
    width: fit-content;
  }
  nav a {
    color: var(--dim);
    text-decoration: none;
    font-size: 12.5px;
    font-weight: 500;
    padding: 7px 18px;
    border-radius: 7px;
    transition: all var(--transition);
    white-space: nowrap;
    cursor: pointer;
  }
  nav a:hover { color: var(--text-secondary); }
  nav a.active { background: rgba(255,255,255,0.06); color: var(--text); }

  /* Header */
  header { margin-bottom: 32px; }
  h1 {
    font-size: 28px;
    font-weight: 800;
    letter-spacing: -0.8px;
    margin-bottom: 4px;
    background: var(--gradient-accent);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .subtitle {
    color: var(--dim);
    font-size: 13px;
    font-weight: 400;
  }
  .cycle-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 2px 10px;
    border-radius: 20px;
    background: var(--accent-soft);
    color: var(--accent);
    font-weight: 600;
    font-size: 11.5px;
  }

  /* Glass */
  .glass {
    background: var(--glass);
    backdrop-filter: blur(var(--blur));
    border: 1px solid var(--glass-border);
    border-radius: var(--radius);
    transition: border-color var(--transition), background var(--transition);
  }
  .glass:hover {
    border-color: var(--glass-border-hover);
    background: var(--surface-hover);
  }
  .glass-static {
    background: var(--glass);
    backdrop-filter: blur(var(--blur));
    border: 1px solid var(--glass-border);
    border-radius: var(--radius);
  }

  /* Sections */
  .section-label {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--dim);
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .section-label .count {
    background: var(--accent-soft);
    color: var(--accent);
    padding: 1px 8px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 600;
  }
  .card { padding: 24px; margin-bottom: 16px; }

  /* KPI Row */
  .kpi-row {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 10px;
    margin-bottom: 16px;
  }
  @media (max-width: 768px) { .kpi-row { grid-template-columns: repeat(3, 1fr); } }
  .kpi { padding: 16px 12px; text-align: center; }
  .kpi-label {
    font-size: 9px;
    color: var(--dim);
    text-transform: uppercase;
    letter-spacing: 1.2px;
    font-weight: 600;
    margin-bottom: 6px;
  }
  .kpi-value {
    font-size: 24px;
    font-weight: 800;
    font-variant-numeric: tabular-nums;
    letter-spacing: -1px;
    line-height: 1;
  }
  .kpi-sub {
    font-size: 10px;
    font-weight: 500;
    margin-top: 4px;
    color: var(--text-secondary);
  }

  /* Hero */
  .hero {
    padding: 28px;
    background: var(--gradient-hero);
    border-color: rgba(167,139,250,0.07);
    margin-bottom: 16px;
    position: relative;
    overflow: hidden;
  }
  .hero::before {
    content: '';
    position: absolute;
    top: -20px; right: -20px;
    width: 240px; height: 240px;
    background: radial-gradient(circle, rgba(167,139,250,0.06), transparent 60%);
    pointer-events: none;
  }
  .hero-label {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--accent);
    margin-bottom: 10px;
  }
  .hero-text {
    font-size: 13.5px;
    color: var(--text-secondary);
    line-height: 1.8;
    max-width: 900px;
  }
  .hero-text strong { color: var(--text); }

  /* Force Velocity */
  .force-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 16px;
  }
  @media (max-width: 768px) { .force-grid { grid-template-columns: 1fr; } }
  .force-card { padding: 20px; cursor: pointer; }
  .force-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  .force-name { font-size: 13px; font-weight: 700; color: var(--text); }
  .force-velocity {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 2px 8px;
    border-radius: 10px;
  }
  .vel-accelerating { background: rgba(52,211,153,0.12); color: var(--green); }
  .vel-steady { background: rgba(96,165,250,0.12); color: var(--blue); }
  .vel-shifting { background: rgba(251,191,36,0.12); color: var(--amber); }
  .vel-intensifying { background: rgba(248,113,113,0.12); color: var(--red); }
  .vel-constraining { background: rgba(244,114,182,0.12); color: var(--pink); }
  .vel-decelerating { background: rgba(248,113,113,0.12); color: var(--red); }

  /* Sector Transformation Table */
  .sector-table { width: 100%; border-collapse: collapse; }
  .sector-table th {
    text-align: left; font-size: 10px; font-weight: 600; text-transform: uppercase;
    letter-spacing: 1px; color: var(--dim); padding: 8px 12px; border-bottom: 1px solid var(--glass-border);
  }
  .sector-table td { padding: 12px; font-size: 12.5px; border-bottom: 1px solid rgba(255,255,255,0.03); }
  .sector-table tr:last-child td { border-bottom: none; }
  .sector-phase {
    display: inline-block; font-size: 10px; font-weight: 600; padding: 2px 8px;
    border-radius: 10px; text-transform: uppercase; letter-spacing: 0.3px;
  }
  .phase-acceleration { background: rgba(248,113,113,0.12); color: var(--red); }
  .phase-early_disruption { background: rgba(251,191,36,0.12); color: var(--amber); }
  .phase-pre_disruption { background: rgba(96,165,250,0.12); color: var(--blue); }
  .sector-change { font-weight: 700; font-variant-numeric: tabular-nums; }
  .sector-change-neg { color: var(--red); }
  .sector-change-pos { color: var(--green); }

  /* Rated Models */
  .model-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
  @media (max-width: 768px) { .model-grid { grid-template-columns: 1fr; } }
  .model-card-ui { padding: 16px; cursor: default; }
  .model-rank { font-size: 11px; color: var(--dim); font-weight: 600; margin-bottom: 4px; }
  .model-name-ui { font-size: 13px; font-weight: 700; color: var(--text); margin-bottom: 6px; }
  .model-score-row { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; }
  .model-composite { font-size: 22px; font-weight: 800; color: var(--accent); font-variant-numeric: tabular-nums; }
  .model-category {
    font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px;
    padding: 2px 8px; border-radius: 10px;
  }
  .cat-STRUCTURAL_WINNER { background: rgba(52,211,153,0.12); color: var(--green); }
  .cat-FORCE_RIDER { background: rgba(96,165,250,0.12); color: var(--blue); }
  .cat-GEOGRAPHIC_PLAY { background: rgba(34,211,238,0.12); color: var(--cyan); }
  .cat-TIMING_ARBITRAGE { background: rgba(251,191,36,0.12); color: var(--amber); }
  .cat-CAPITAL_MOAT { background: rgba(167,139,250,0.12); color: var(--accent); }
  .cat-FEAR_ECONOMY { background: rgba(248,113,113,0.12); color: var(--red); }
  .cat-CONDITIONAL { background: rgba(255,255,255,0.06); color: var(--text-secondary); }
  .model-sector { font-size: 11px; color: var(--text-secondary); }

  /* Category Distribution */
  .cat-dist { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
  .cat-chip {
    font-size: 10px; font-weight: 600; padding: 3px 10px; border-radius: 10px;
    display: flex; align-items: center; gap: 5px;
  }
  .cat-chip-count { font-weight: 800; }
  .force-metric {
    font-size: 11.5px;
    color: var(--text-secondary);
    margin-bottom: 8px;
    font-weight: 500;
  }
  .force-bar {
    height: 3px;
    border-radius: 2px;
    background: rgba(255,255,255,0.05);
    overflow: hidden;
    margin-bottom: 8px;
  }
  .force-bar-fill {
    height: 100%;
    border-radius: 2px;
    transition: width 1s ease;
  }
  .force-data {
    display: none;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--glass-border);
  }
  .force-card.expanded .force-data { display: block; }
  .force-datum {
    font-size: 11px;
    color: var(--text-secondary);
    padding: 3px 0;
    line-height: 1.5;
  }
  .force-datum::before {
    content: '\2022';
    color: var(--dim);
    margin-right: 6px;
  }
  .force-projection {
    font-size: 11px;
    color: var(--accent);
    margin-top: 8px;
    font-style: italic;
  }

  /* World Map */
  .world-map-container {
    position: relative;
    padding: 32px 24px;
    margin-bottom: 16px;
    min-height: 420px;
    overflow: hidden;
  }
  .map-grid {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background-image:
      radial-gradient(circle at 1px 1px, rgba(255,255,255,0.02) 1px, transparent 0);
    background-size: 40px 40px;
    pointer-events: none;
  }
  .map-regions {
    position: relative;
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    grid-template-rows: repeat(6, 60px);
    gap: 4px;
    z-index: 1;
  }
  .region-node {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 8px 6px;
    border-radius: var(--radius-sm);
    background: rgba(255,255,255,0.02);
    border: 1px solid rgba(255,255,255,0.04);
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    z-index: 2;
  }
  .region-node:hover {
    background: rgba(255,255,255,0.06);
    border-color: rgba(167,139,250,0.2);
    transform: translateY(-2px);
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    z-index: 10;
  }
  .region-node.active {
    background: rgba(167,139,250,0.08);
    border-color: rgba(167,139,250,0.2);
  }
  .region-emoji { font-size: 20px; margin-bottom: 2px; }
  .region-name { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); }
  .region-vel { font-size: 8px; font-weight: 600; margin-top: 2px; }
  .rv-fast { color: var(--green); }
  .rv-moderate { color: var(--amber); }
  .rv-nascent { color: var(--dim); }
  .rv-accelerating { color: var(--cyan); }

  /* Region Detail */
  .region-detail {
    display: none;
    padding: 20px;
    margin-bottom: 16px;
    animation: fadeIn 0.3s ease;
  }
  .region-detail.visible { display: block; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  .region-detail-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
  }
  .region-detail-emoji { font-size: 32px; }
  .region-detail-name { font-size: 18px; font-weight: 800; letter-spacing: -0.5px; }
  .region-detail-vel { font-size: 11px; font-weight: 500; color: var(--text-secondary); }
  .region-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 10px;
    margin-bottom: 16px;
  }
  .region-metric {
    padding: 12px;
    background: rgba(255,255,255,0.02);
    border-radius: var(--radius-xs);
    border: 1px solid rgba(255,255,255,0.04);
  }
  .rm-label {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: var(--dim);
    font-weight: 600;
    margin-bottom: 4px;
  }
  .rm-value { font-size: 14px; font-weight: 700; color: var(--text); }
  .region-forces { margin-bottom: 12px; }
  .region-force-item {
    font-size: 11.5px;
    color: var(--text-secondary);
    padding: 3px 0;
  }
  .region-force-item::before {
    content: '\25B8';
    color: var(--accent);
    margin-right: 6px;
  }
  .region-outlook {
    font-size: 12px;
    color: var(--text-secondary);
    line-height: 1.7;
    padding: 12px;
    background: rgba(167,139,250,0.04);
    border-radius: var(--radius-xs);
    border-left: 3px solid var(--accent);
  }

  /* Fear Friction */
  .friction-grid {
    display: grid;
    gap: 8px;
  }
  .friction-row {
    display: grid;
    grid-template-columns: 140px 1fr 60px;
    align-items: center;
    gap: 12px;
    padding: 8px 0;
  }
  .friction-sector {
    font-size: 12px;
    font-weight: 600;
    color: var(--text);
  }
  .friction-bars {
    display: flex;
    gap: 4px;
    align-items: center;
  }
  .friction-bar-track {
    flex: 1;
    height: 20px;
    border-radius: 4px;
    background: rgba(255,255,255,0.03);
    position: relative;
    overflow: hidden;
  }
  .friction-bar-econ {
    position: absolute;
    top: 0; left: 0;
    height: 100%;
    border-radius: 4px;
    background: linear-gradient(90deg, rgba(52,211,153,0.4), rgba(52,211,153,0.15));
    transition: width 1s ease;
  }
  .friction-bar-psych {
    position: absolute;
    top: 0; left: 0;
    height: 100%;
    border-radius: 4px;
    background: linear-gradient(90deg, rgba(248,113,113,0.5), rgba(248,113,113,0.15));
    transition: width 1s ease;
    z-index: 1;
  }
  .friction-gap {
    font-size: 16px;
    font-weight: 800;
    text-align: right;
    font-variant-numeric: tabular-nums;
  }
  .gap-high { color: var(--red); }
  .gap-medium { color: var(--amber); }
  .gap-low { color: var(--green); }
  .friction-legend {
    display: flex;
    gap: 20px;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--glass-border);
  }
  .friction-legend-item {
    font-size: 10px;
    color: var(--dim);
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .friction-legend-dot {
    width: 8px;
    height: 8px;
    border-radius: 2px;
  }

  /* Key Findings */
  .findings-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
  }
  @media (max-width: 768px) { .findings-grid { grid-template-columns: 1fr; } }
  .finding {
    padding: 18px;
    cursor: pointer;
  }
  .finding-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 10px;
    margin-bottom: 6px;
  }
  .finding-title {
    font-size: 13px;
    font-weight: 700;
    color: var(--text);
    line-height: 1.4;
  }
  .finding-confidence {
    font-size: 9px;
    font-weight: 600;
    text-transform: uppercase;
    padding: 2px 6px;
    border-radius: 8px;
    flex-shrink: 0;
  }
  .conf-high { background: rgba(52,211,153,0.1); color: var(--green); }
  .conf-medium { background: rgba(251,191,36,0.1); color: var(--amber); }
  .finding-magnitude {
    font-size: 11px;
    font-weight: 600;
    color: var(--accent);
    margin-bottom: 4px;
  }
  .finding-detail {
    font-size: 11.5px;
    color: var(--text-secondary);
    line-height: 1.6;
    display: none;
  }
  .finding.expanded .finding-detail { display: block; margin-top: 8px; }

  /* Sentiment Trajectory */
  .trajectory-grid {
    display: grid;
    gap: 6px;
  }
  .trajectory-row {
    display: grid;
    grid-template-columns: 180px 100px 1fr 100px;
    align-items: center;
    gap: 12px;
    padding: 6px 0;
    font-size: 12px;
  }
  @media (max-width: 768px) {
    .trajectory-row { grid-template-columns: 1fr 1fr; gap: 4px; font-size: 11px; }
  }
  .traj-metric { font-weight: 600; color: var(--text); }
  .traj-baseline { color: var(--text-secondary); font-variant-numeric: tabular-nums; }
  .traj-arrow {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 11px;
    color: var(--dim);
  }
  .traj-arrow-icon { font-size: 14px; }
  .traj-2031 { font-weight: 700; color: var(--accent); text-align: right; }

  /* Fear Markets Table */
  .markets-table {
    width: 100%;
    border-collapse: collapse;
  }
  .markets-table th {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--dim);
    font-weight: 600;
    text-align: left;
    padding: 8px 10px;
    border-bottom: 1px solid var(--glass-border);
  }
  .markets-table td {
    font-size: 12px;
    padding: 8px 10px;
    border-bottom: 1px solid rgba(255,255,255,0.02);
    color: var(--text-secondary);
  }
  .markets-table tr:hover td { color: var(--text); background: rgba(255,255,255,0.01); }
  .cagr-value {
    font-weight: 700;
    font-variant-numeric: tabular-nums;
  }
  .cagr-hot { color: var(--red); }
  .cagr-warm { color: var(--amber); }
  .cagr-cool { color: var(--green); }

  /* Perez Cycle */
  .perez-timeline {
    display: flex;
    align-items: center;
    gap: 0;
    padding: 20px 0;
    position: relative;
  }
  .perez-phase {
    flex: 1;
    text-align: center;
    padding: 16px 8px;
    position: relative;
    border-bottom: 3px solid rgba(255,255,255,0.05);
  }
  .perez-phase.current {
    border-bottom-color: var(--accent);
    background: rgba(167,139,250,0.04);
    border-radius: var(--radius-xs) var(--radius-xs) 0 0;
  }
  .perez-phase.past {
    border-bottom-color: rgba(52,211,153,0.3);
  }
  .perez-phase-name {
    font-size: 11px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 2px;
  }
  .perez-phase.current .perez-phase-name { color: var(--accent); }
  .perez-phase-years {
    font-size: 9px;
    color: var(--dim);
    font-weight: 500;
  }
  .perez-marker {
    position: absolute;
    bottom: -8px;
    left: 50%;
    transform: translateX(-50%);
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--accent);
    border: 2px solid var(--bg);
    box-shadow: 0 0 12px rgba(167,139,250,0.4);
    animation: pulse 2s infinite;
  }
  @keyframes pulse {
    0%, 100% { box-shadow: 0 0 12px rgba(167,139,250,0.4); }
    50% { box-shadow: 0 0 24px rgba(167,139,250,0.6); }
  }

  /* Displacement */
  .displacement-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 16px;
  }
  @media (max-width: 768px) { .displacement-grid { grid-template-columns: 1fr; } }
  .disp-stat { padding: 18px; text-align: center; }
  .disp-value {
    font-size: 28px;
    font-weight: 900;
    line-height: 1;
    margin-bottom: 4px;
    font-variant-numeric: tabular-nums;
  }
  .disp-label {
    font-size: 10px;
    color: var(--text-secondary);
    font-weight: 500;
  }
  .disp-sub {
    font-size: 9px;
    color: var(--dim);
    margin-top: 4px;
  }

  /* Cycle History */
  .cycle-chart {
    display: flex;
    align-items: flex-end;
    gap: 6px;
    height: 100px;
    padding-top: 10px;
  }
  .cycle-bar {
    flex: 1;
    min-width: 12px;
    border-radius: 4px 4px 0 0;
    transition: height 1s ease, opacity 0.3s;
    position: relative;
    cursor: default;
  }
  .cycle-bar:hover { opacity: 1 !important; }
  .cycle-bar::after {
    content: attr(data-label);
    position: absolute;
    bottom: -18px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 8px;
    color: var(--dim);
    white-space: nowrap;
    letter-spacing: 0.3px;
  }

  /* Grid layouts */
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  @media (max-width: 768px) { .grid-2 { grid-template-columns: 1fr; } }

  /* Expandable */
  .expandable-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    padding-bottom: 4px;
  }
  .expand-icon {
    font-size: 10px;
    color: var(--dim);
    transition: transform var(--transition);
  }
  .expandable-content { display: none; }
  .expanded .expandable-content { display: block; }
  .expanded .expand-icon { transform: rotate(180deg); }

  /* Two-col layout for findings and friction */
  .two-col {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 16px;
  }
  @media (max-width: 900px) { .two-col { grid-template-columns: 1fr; } }

  /* Defense stats */
  .defense-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
  }
  .defense-stat {
    padding: 14px;
    text-align: center;
    background: rgba(255,255,255,0.02);
    border-radius: var(--radius-xs);
  }
  .defense-value {
    font-size: 18px;
    font-weight: 800;
    color: var(--text);
    margin-bottom: 2px;
  }
  .defense-label {
    font-size: 9px;
    color: var(--dim);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* v2 evidence */
  .evidence-card {
    padding: 12px 14px;
    background: rgba(255,255,255,0.02);
    border-radius: var(--radius-xs);
    border: 1px solid rgba(255,255,255,0.04);
    margin-bottom: 8px;
  }
  .evidence-name {
    font-size: 12px;
    font-weight: 600;
    color: var(--text);
  }
  .evidence-score {
    font-size: 11px;
    font-weight: 700;
    color: var(--green);
  }
  .evidence-sector {
    font-size: 10px;
    color: var(--dim);
  }

  /* Footer */
  .footer {
    text-align: center;
    padding: 32px 0 16px;
    color: var(--dim);
    font-size: 11px;
  }
</style>
</head>
<body>
<div class="container">
  <nav>
    <a class="active" onclick="showView('models')">Models</a>
    <a onclick="showView('forces')">Forces</a>
    <a onclick="showView('sectors')">Sectors</a>
    <a onclick="showView('regions')">Regions</a>
    <a onclick="showView('fear')">Fear Index</a>
    <a onclick="showView('data')">Data</a>
  </nav>

  <header>
    <h1>Business Model Engine</h1>
    <div class="subtitle">
      <span class="cycle-badge" id="cycle-badge">v3-3</span>
      &nbsp; <span id="model-total-sub">295 rated models</span> &middot; 5-axis scoring &middot; 6 forces &middot; 8 regions &middot; Updated <span id="last-updated">--</span>
    </div>
  </header>

  <!-- KPI Row -->
  <div class="kpi-row" id="kpi-row">
    <div class="glass kpi">
      <div class="kpi-label">Rated Models</div>
      <div class="kpi-value" style="color:var(--accent)" id="kpi-rated">295</div>
      <div class="kpi-sub">individually scored</div>
    </div>
    <div class="glass kpi">
      <div class="kpi-label">Total Inventory</div>
      <div class="kpi-value" style="color:var(--blue)" id="kpi-total">582</div>
      <div class="kpi-sub">incl. algorithmic</div>
    </div>
    <div class="glass kpi">
      <div class="kpi-label">Structural Winners</div>
      <div class="kpi-value" style="color:var(--green)" id="kpi-winners">27</div>
      <div class="kpi-sub">SN&ge;8, FA&ge;8</div>
    </div>
    <div class="glass kpi">
      <div class="kpi-label">Top Composite</div>
      <div class="kpi-value" style="color:var(--amber)" id="kpi-top">83.5</div>
      <div class="kpi-sub">mean 61.9</div>
    </div>
    <div class="glass kpi">
      <div class="kpi-label">New This Cycle</div>
      <div class="kpi-value" style="color:var(--red)" id="kpi-new">45</div>
      <div class="kpi-sub">from macro gaps</div>
    </div>
    <div class="glass kpi">
      <div class="kpi-label">Forces &times; Regions</div>
      <div class="kpi-value" style="color:var(--cyan)">6&times;8</div>
      <div class="kpi-sub">grading context</div>
    </div>
  </div>

  <!-- Hero Synthesis -->
  <div class="glass hero" id="hero">
    <div class="hero-label">v3-3 Synthesis &mdash; Models as Central Output</div>
    <div class="hero-text" id="hero-text">
      <strong>295 business models individually rated through 5-axis scoring</strong> (Structural Necessity, Force Alignment, Geographic Grade, Timing Grade, Capital Efficiency). 522 v2 models migrated + <strong>45 new models</strong> discovered from macro gaps in <strong>defense AI</strong> ($2.72T global), <strong>fear economy</strong> ($86B by 2030), <strong>energy infrastructure</strong>, <strong>education</strong>, and <strong>emerging categories</strong>. Top model: AI-Native Accounting Practice Platform at <strong>83.5 composite</strong>. 27 STRUCTURAL_WINNERs where SN&ge;8 and FA&ge;8 &mdash; must-exist businesses driven by multiple converging forces. Physical + acquisition architectures dominate, validating the v2 finding that <strong>crash-resilient businesses</strong> score highest when graded against the Perez cycle.
    </div>
  </div>

  <!-- SECTION: Rated Models (CENTRAL OUTPUT) -->
  <div id="view-models">
    <div class="section-label">Rated Business Models <span class="count" id="model-count">0</span></div>
    <div class="cat-dist" id="cat-dist"></div>
    <div style="height:12px"></div>
    <div id="new-sectors"></div>
    <div style="height:16px"></div>
    <div class="model-grid" id="model-grid"></div>
  </div>

  <!-- SECTION: Force Velocities -->
  <div id="view-forces">
    <div class="section-label">Force Velocities <span class="count">F1-F6</span></div>
    <div class="force-grid" id="force-grid"></div>
  </div>

  <!-- SECTION: Sector Transformations -->
  <div id="view-sectors">
    <div class="section-label">Sector Transformations <span class="count">employment projections 2026&rarr;2031</span></div>
    <div class="glass-static card">
      <table class="sector-table" id="sector-table">
        <thead>
          <tr><th>Sector</th><th>Phase</th><th>2026</th><th>2031</th><th>Change</th><th>Top Model</th></tr>
        </thead>
        <tbody id="sector-body"></tbody>
      </table>
    </div>
  </div>

  <!-- SECTION: World Map -->
  <div id="view-regions">
    <div class="section-label">Global Transformation Map <span class="count">8 regions</span></div>
    <div class="glass-static world-map-container">
      <div class="map-grid"></div>
      <div class="map-regions" id="map-regions"></div>
    </div>
    <div class="glass-static region-detail" id="region-detail"></div>
  </div>

  <!-- SECTION: Key Findings -->
  <div id="view-findings">
    <div class="section-label">Key Findings <span class="count" id="findings-count">0</span></div>
    <div class="findings-grid" id="findings-grid"></div>
  </div>

  <!-- SECTION: Fear Friction + Displacement -->
  <div id="view-fear">
    <div class="two-col">
      <div class="glass-static card">
        <div class="section-label">Fear Friction Index <span class="count">economic vs psychological readiness</span></div>
        <div class="friction-grid" id="friction-grid"></div>
        <div class="friction-legend">
          <div class="friction-legend-item">
            <div class="friction-legend-dot" style="background:rgba(52,211,153,0.4)"></div>
            Economic readiness (1-10)
          </div>
          <div class="friction-legend-item">
            <div class="friction-legend-dot" style="background:rgba(248,113,113,0.5)"></div>
            Psychological readiness (1-10)
          </div>
          <div class="friction-legend-item">
            Gap = friction
          </div>
        </div>
      </div>

      <div class="glass-static card">
        <div class="section-label">Fear-Driven Markets <span class="count">new categories</span></div>
        <table class="markets-table" id="markets-table">
          <thead>
            <tr><th>Category</th><th>2025</th><th>Projected</th><th>CAGR</th></tr>
          </thead>
          <tbody id="markets-body"></tbody>
        </table>
      </div>
    </div>

    <!-- Worker Displacement -->
    <div class="section-label">Worker Displacement Signals</div>
    <div class="displacement-grid" id="displacement-grid"></div>
  </div>

  <!-- SECTION: Sentiment + Perez -->
  <div id="view-data">
    <div class="two-col">
      <div class="glass-static card">
        <div class="section-label">Sentiment Trajectory <span class="count">2026 &rarr; 2031</span></div>
        <div class="trajectory-grid" id="trajectory-grid"></div>
      </div>

      <div class="glass-static card">
        <div class="section-label">Perez Cycle Position</div>
        <div class="perez-timeline" id="perez-timeline"></div>
        <div style="margin-top:16px">
          <div class="section-label" style="font-size:10px; margin-bottom:8px;">Turning Point Signals</div>
          <div id="perez-signals"></div>
        </div>
      </div>
    </div>

    <!-- Defense AI -->
    <div class="glass-static card">
      <div class="section-label">Defense & Sovereign AI Spending</div>
      <div class="defense-grid" id="defense-grid"></div>
    </div>

    <!-- Model Inventory -->
    <div class="glass-static card" id="evidence-section">
      <div class="expandable-header" onclick="toggleSection('evidence-section')">
        <div class="section-label" style="margin-bottom:0;">Model Inventory Sources <span class="count" id="inventory-count">582 total &middot; 5 batches &middot; 28 patterns</span></div>
        <span class="expand-icon">&#x25BC;</span>
      </div>
      <div class="expandable-content">
        <div style="height:12px"></div>
        <div id="evidence-list"></div>
      </div>
    </div>

    <!-- Cycle History -->
    <div class="glass-static card">
      <div class="section-label">Engine Evolution <span class="count" id="cycle-count">0</span></div>
      <div class="cycle-chart" id="cycle-chart"></div>
      <div style="height:24px"></div>
    </div>
  </div>

  <div class="footer">
    Business Model Engine v3.3 &middot; 295 rated models &middot; 5-axis scoring &middot; 2026&ndash;2031
  </div>
</div>

<script>
const BASE = '../data/ui';

async function load(path) {
  try {
    const r = await fetch(path + '?t=' + Date.now());
    return r.ok ? await r.json() : null;
  } catch { return null; }
}

function esc(s) {
  if (!s) return '';
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function toggleSection(id) {
  document.getElementById(id).classList.toggle('expanded');
}

function showView(view) {
  document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
  event.target.classList.add('active');
  // All views always visible — nav just scrolls to section
  const el = document.getElementById('view-' + view);
  if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// ─── Force Velocities ───
function renderForces(forces) {
  const el = document.getElementById('force-grid');
  if (!forces) return;

  const colors = {
    accelerating: { bar: 'var(--green)', cls: 'vel-accelerating', pct: 85 },
    steady: { bar: 'var(--blue)', cls: 'vel-steady', pct: 60 },
    shifting: { bar: 'var(--amber)', cls: 'vel-shifting', pct: 70 },
    intensifying: { bar: 'var(--red)', cls: 'vel-intensifying', pct: 80 },
    constraining: { bar: 'var(--pink)', cls: 'vel-constraining', pct: 75 },
    decelerating: { bar: 'var(--red)', cls: 'vel-decelerating', pct: 45 }
  };

  const ids = ['F1_technology','F2_demographics','F3_geopolitics','F4_capital','F5_psychology','F6_energy'];

  el.innerHTML = ids.map(id => {
    const f = forces[id];
    if (!f) return '';
    const c = colors[f.velocity] || colors.steady;
    const dataItems = (f.key_data || []).map(d => `<div class="force-datum">${esc(d)}</div>`).join('');
    const proj = f['2031_projection'] || '';

    return `<div class="glass force-card" onclick="this.classList.toggle('expanded')">
      <div class="force-header">
        <div class="force-name">${esc(f.name)}</div>
        <div class="force-velocity ${c.cls}">${esc(f.velocity)}</div>
      </div>
      <div class="force-metric">${esc(f.key_metric)}</div>
      <div class="force-bar">
        <div class="force-bar-fill" style="width:${c.pct}%;background:${c.bar}"></div>
      </div>
      <div class="force-data">
        ${dataItems}
        ${proj ? `<div class="force-projection">2031: ${esc(proj)}</div>` : ''}
      </div>
    </div>`;
  }).join('');
}

// ─── World Map ───
function renderMap(profiles) {
  const el = document.getElementById('map-regions');
  if (!profiles) return;

  // Position regions on a grid that roughly represents their geographic position
  const layout = [
    { key: 'us', col: '2 / 5', row: '2 / 4' },
    { key: 'latam', col: '3 / 5', row: '4 / 6' },
    { key: 'eu', col: '5 / 8', row: '1 / 3' },
    { key: 'africa', col: '6 / 8', row: '3 / 5' },
    { key: 'mena', col: '8 / 10', row: '2 / 4' },
    { key: 'india', col: '9 / 11', row: '3 / 5' },
    { key: 'china', col: '9 / 11', row: '1 / 3' },
    { key: 'japan', col: '11 / 13', row: '1 / 3' },
  ];

  const velClass = v => {
    if (v.includes('fast')) return 'rv-fast';
    if (v.includes('accelerating')) return 'rv-accelerating';
    if (v.includes('moderate')) return 'rv-moderate';
    return 'rv-nascent';
  };

  el.innerHTML = layout.map(l => {
    const p = profiles[l.key];
    if (!p) return '';
    const shortVel = (p.transformation_velocity || '').split(' ')[0];
    return `<div class="region-node" style="grid-column:${l.col};grid-row:${l.row}" onclick="showRegionDetail('${l.key}', this)" data-key="${l.key}">
      <div class="region-emoji">${p.emoji || ''}</div>
      <div class="region-name">${esc(p.name)}</div>
      <div class="region-vel ${velClass(p.transformation_velocity || '')}">${esc(shortVel)}</div>
    </div>`;
  }).join('');

  window._profiles = profiles;
}

function showRegionDetail(key, nodeEl) {
  const p = window._profiles[key];
  if (!p) return;

  document.querySelectorAll('.region-node').forEach(n => n.classList.remove('active'));
  if (nodeEl) nodeEl.classList.add('active');

  const el = document.getElementById('region-detail');
  const metrics = p.key_metrics || {};
  const metricsHtml = Object.entries(metrics).map(([k, v]) => {
    const label = k.replace(/_/g, ' ');
    return `<div class="region-metric">
      <div class="rm-label">${esc(label)}</div>
      <div class="rm-value">${esc(v)}</div>
    </div>`;
  }).join('');

  const forces = (p.top_forces || []).map(f => `<div class="region-force-item">${esc(f)}</div>`).join('');
  const outlook = p['2031_outlook'] || '';

  el.innerHTML = `
    <div class="region-detail-header">
      <div class="region-detail-emoji">${p.emoji || ''}</div>
      <div>
        <div class="region-detail-name">${esc(p.name)}</div>
        <div class="region-detail-vel">${esc(p.transformation_velocity || '')}</div>
      </div>
    </div>
    <div class="region-metrics">${metricsHtml}</div>
    <div class="region-forces" style="margin-bottom:12px">${forces}</div>
    ${outlook ? `<div class="region-outlook"><strong>2031:</strong> ${esc(outlook)}</div>` : ''}
  `;
  el.classList.add('visible');
  el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// ─── Key Findings ───
function renderFindings(findings) {
  const el = document.getElementById('findings-grid');
  if (!findings || !findings.length) return;
  document.getElementById('findings-count').textContent = findings.length;

  el.innerHTML = findings.map(f => {
    const confCls = f.confidence === 'high' ? 'conf-high' : 'conf-medium';
    return `<div class="glass finding" onclick="this.classList.toggle('expanded')">
      <div class="finding-header">
        <div class="finding-title">${esc(f.title)}</div>
        <div class="finding-confidence ${confCls}">${esc(f.confidence)}</div>
      </div>
      <div class="finding-magnitude">${esc(f.magnitude)}</div>
      <div class="finding-detail">${esc(f.detail)}</div>
    </div>`;
  }).join('');
}

// ─── Fear Friction ───
function renderFriction(friction) {
  const el = document.getElementById('friction-grid');
  if (!friction || !friction.length) return;

  el.innerHTML = friction.map(f => {
    const gapCls = f.fear_friction_gap >= 5 ? 'gap-high' : f.fear_friction_gap >= 3 ? 'gap-medium' : 'gap-low';
    return `<div class="friction-row">
      <div class="friction-sector">${esc(f.sector)}</div>
      <div class="friction-bars">
        <div class="friction-bar-track">
          <div class="friction-bar-econ" style="width:${f.economic_readiness * 10}%"></div>
          <div class="friction-bar-psych" style="width:${f.psychological_readiness * 10}%"></div>
        </div>
      </div>
      <div class="friction-gap ${gapCls}">${f.fear_friction_gap}</div>
    </div>`;
  }).join('');
}

// ─── Fear Markets ───
function renderMarkets(markets) {
  const el = document.getElementById('markets-body');
  if (!markets || !markets.length) return;

  el.innerHTML = markets.map(m => {
    const cagr = parseFloat(m.cagr) || 0;
    const cagrCls = cagr >= 35 ? 'cagr-hot' : cagr >= 20 ? 'cagr-warm' : 'cagr-cool';
    return `<tr>
      <td>${esc(m.category)}</td>
      <td>${esc(m.size_2025)}</td>
      <td>${esc(m.projected)}</td>
      <td><span class="cagr-value ${cagrCls}">${esc(m.cagr)}</span></td>
    </tr>`;
  }).join('');
}

// ─── Sentiment Trajectory ───
function renderTrajectory(items) {
  const el = document.getElementById('trajectory-grid');
  if (!items || !items.length) return;

  el.innerHTML = items.map(t => {
    return `<div class="trajectory-row">
      <div class="traj-metric">${esc(t.metric)}</div>
      <div class="traj-baseline">${esc(t.baseline)}</div>
      <div class="traj-arrow"><span class="traj-arrow-icon">&rarr;</span> ${esc(t.direction)}</div>
      <div class="traj-2031">${esc(t.est_2031)}</div>
    </div>`;
  }).join('');
}

// ─── Perez Cycle ───
function renderPerez(perez) {
  const el = document.getElementById('perez-timeline');
  const sigEl = document.getElementById('perez-signals');
  if (!perez) return;

  const phases = [
    { name: 'Irruption', years: '2020-22', cls: 'past' },
    { name: 'Frenzy', years: '2022-26', cls: 'current' },
    { name: 'Turning Point', years: '2026-28?', cls: '' },
    { name: 'Synergy', years: '2028-35?', cls: '' },
    { name: 'Maturity', years: '2035+', cls: '' }
  ];

  el.innerHTML = phases.map(p => {
    const marker = p.cls === 'current' ? '<div class="perez-marker"></div>' : '';
    return `<div class="perez-phase ${p.cls}">
      <div class="perez-phase-name">${p.name}</div>
      <div class="perez-phase-years">${p.years}</div>
      ${marker}
    </div>`;
  }).join('');

  const signals = perez.turning_point_signals || [];
  sigEl.innerHTML = signals.map(s => `<div class="force-datum">${esc(s)}</div>`).join('');
}

// ─── Worker Displacement ───
function renderDisplacement(wd) {
  const el = document.getElementById('displacement-grid');
  if (!wd) return;

  const wef = wd.wef_2030 || {};
  el.innerHTML = `
    <div class="glass-static disp-stat">
      <div class="disp-value" style="color:var(--green)">+${((wef.jobs_created||0)/1e6).toFixed(0)}M</div>
      <div class="disp-label">Jobs Created by 2030</div>
      <div class="disp-sub">WEF Future of Jobs 2025</div>
    </div>
    <div class="glass-static disp-stat">
      <div class="disp-value" style="color:var(--red)">&minus;${((wef.jobs_displaced||0)/1e6).toFixed(0)}M</div>
      <div class="disp-label">Jobs Displaced by 2030</div>
      <div class="disp-sub">22% of all jobs disrupted</div>
    </div>
    <div class="glass-static disp-stat">
      <div class="disp-value" style="color:var(--accent)">+${((wef.net_growth||0)/1e6).toFixed(0)}M</div>
      <div class="disp-label">Net Job Growth</div>
      <div class="disp-sub">but 59% won't get training</div>
    </div>
  `;
}

// ─── Defense ───
function renderDefense(def) {
  const el = document.getElementById('defense-grid');
  if (!def) return;

  const stats = [
    { value: def.global_defense_2026, label: 'Global Defense 2026' },
    { value: def.us_dod_ai_autonomy, label: 'US DoD AI Budget' },
    { value: def.us_dod_total, label: 'US DoD Total' },
    { value: def.nato_target, label: 'NATO Target' },
    { value: def.european_defense, label: 'European Defense' },
    { value: def.china_defense, label: 'China Defense' }
  ];

  el.innerHTML = stats.map(s => `
    <div class="defense-stat">
      <div class="defense-value">${esc(s.value)}</div>
      <div class="defense-label">${esc(s.label)}</div>
    </div>
  `).join('');
}

// ─── Evidence (legacy — redirects to renderInventory) ───
function renderEvidence(ev) { if (ev) renderInventory(ev); }

// ─── Cycle History ───
function renderCycles(cycles) {
  const el = document.getElementById('cycle-chart');
  if (!cycles || !cycles.length) return;
  document.getElementById('cycle-count').textContent = cycles.length + ' cycles';

  const max = Math.max(...cycles.map(c => c.models_constructed || 0), 1);
  el.innerHTML = cycles.map((c, i) => {
    const val = c.models_constructed || 0;
    const h = Math.max(8, (val / max) * 100);
    const opacity = 0.2 + (i / cycles.length) * 0.7;
    const isV3 = c.type === 'economy_map' || c.type === 'institutional_grade' || c.type === 'model_migration_expansion';
    const bg = isV3 ? 'linear-gradient(180deg, rgba(248,113,113,0.7), rgba(251,191,36,0.5))' : 'linear-gradient(180deg, rgba(167,139,250,0.7), rgba(96,165,250,0.5))';
    return `<div class="cycle-bar" style="height:${h}%;background:${bg};opacity:${opacity.toFixed(2)}" data-label="${c.cycle}"></div>`;
  }).join('');
}

// ─── Sector Transformations ───
function renderSectors(sectors) {
  const el = document.getElementById('sector-body');
  if (!sectors || !sectors.length) return;

  el.innerHTML = sectors.map(s => {
    const phaseCls = 'phase-' + (s.phase || '').replace(/\s+/g, '_');
    const changeCls = s.change_pct < 0 ? 'sector-change-neg' : 'sector-change-pos';
    const sign = s.change_pct > 0 ? '+' : '';
    return `<tr>
      <td><strong>${esc(s.name)}</strong><br><span style="font-size:10px;color:var(--dim)">NAICS ${esc(s.naics)}</span></td>
      <td><span class="sector-phase ${phaseCls}">${esc(s.phase)}</span></td>
      <td>${s.employment_2026}M</td>
      <td>${s.employment_2031}M</td>
      <td><span class="sector-change ${changeCls}">${sign}${s.change_pct}%</span></td>
      <td style="font-size:11px;color:var(--text-secondary)">${esc(s.top_model)}</td>
    </tr>`;
  }).join('');
}

// ─── Rated Models ───
function renderModels(rating) {
  const grid = document.getElementById('model-grid');
  const distEl = document.getElementById('cat-dist');
  const newSectorsEl = document.getElementById('new-sectors');
  if (!rating) return;

  const totalRated = rating.total_models_individually_rated || rating.total_models_rated || 0;
  const totalAlgo = rating.total_with_algorithmic_estimation || 0;
  document.getElementById('model-count').textContent = totalRated + ' rated' + (totalAlgo ? ' + ' + (totalAlgo - totalRated) + ' estimated' : '');

  // Category distribution chips
  const dist = rating.category_distribution || {};
  const catColors = {
    STRUCTURAL_WINNER: 'cat-STRUCTURAL_WINNER', FORCE_RIDER: 'cat-FORCE_RIDER',
    GEOGRAPHIC_PLAY: 'cat-GEOGRAPHIC_PLAY', TIMING_ARBITRAGE: 'cat-TIMING_ARBITRAGE',
    CAPITAL_MOAT: 'cat-CAPITAL_MOAT', FEAR_ECONOMY: 'cat-FEAR_ECONOMY',
    EMERGING_CATEGORY: 'cat-GEOGRAPHIC_PLAY', CONDITIONAL: 'cat-CONDITIONAL', PARKED: 'cat-CONDITIONAL'
  };

  distEl.innerHTML = Object.entries(dist).filter(([,v]) => v > 0).map(([k, v]) => {
    const cls = catColors[k] || 'cat-CONDITIONAL';
    return `<div class="cat-chip ${cls}"><span class="cat-chip-count">${v}</span> ${k.replace(/_/g, ' ')}</div>`;
  }).join('');

  // New sectors this cycle
  const newSectors = rating.new_sectors_this_cycle || [];
  if (newSectors.length && newSectorsEl) {
    newSectorsEl.innerHTML = '<div style="display:flex;flex-wrap:wrap;gap:8px">' + newSectors.map(s => {
      return `<div style="font-size:10px;padding:4px 10px;border-radius:8px;background:rgba(248,113,113,0.08);color:var(--red);font-weight:600;">NEW: ${esc(s.sector)} (${s.models})</div>`;
    }).join('') + '</div>';
  }

  // Top 20 model cards with 5-axis bars
  const models = rating.top_20_by_composite || rating.top_10_by_composite || [];
  grid.innerHTML = models.map((m) => {
    const catCls = 'cat-' + (m.category || 'CONDITIONAL');
    const srcLabel = m.source ? `<span style="font-size:9px;color:var(--dim);margin-left:6px">${esc(m.source)}</span>` : '';
    return `<div class="glass model-card-ui">
      <div class="model-rank">#${m.rank || ''}${srcLabel}</div>
      <div class="model-name-ui">${esc(m.name)}</div>
      <div class="model-score-row">
        <div class="model-composite">${m.composite}</div>
        <div class="model-category ${catCls}">${esc((m.category || '').replace(/_/g, ' '))}</div>
      </div>
      <div class="model-sector">${esc(m.id || '')}</div>
    </div>`;
  }).join('');
}

// ─── Model Inventory ───
function renderInventory(inv) {
  const el = document.getElementById('evidence-list');
  if (!inv) return;

  let html = '<div style="font-size:11px;color:var(--text-secondary);margin-bottom:12px;">' + esc(inv.note || '') + '</div>';

  // Source batches
  const sources = inv.sources || {};
  html += Object.entries(sources).map(([k, v]) => `
    <div class="evidence-card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="evidence-name">${esc(k.replace(/_/g, ' '))}</div>
        <div class="evidence-score">${v.count} models</div>
      </div>
      <div class="evidence-sector">${esc(v.file || '')}</div>
    </div>
  `).join('');

  // Confirmed cascades
  const cascades = inv.confirmed_cascades || [];
  if (cascades.length) {
    html += '<div style="margin-top:12px;font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:1px;font-weight:600;margin-bottom:8px">Confirmed Cascades</div>';
    html += cascades.map(c => `<div class="force-datum">${esc(c)}</div>`).join('');
  }

  el.innerHTML = html;
}

// ─── Main ───
async function refresh() {
  const d = await load(BASE + '/dashboard.json');
  if (!d) return;

  // Header
  document.getElementById('cycle-badge').textContent = d.current_cycle || 'v3-3';
  const ts = d.last_updated;
  document.getElementById('last-updated').textContent =
    ts ? new Date(ts).toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'}) : '--';

  // KPIs
  const rs = d.rating_system || {};
  if (rs.total_models_individually_rated) document.getElementById('kpi-rated').textContent = rs.total_models_individually_rated;
  if (rs.total_with_algorithmic_estimation) document.getElementById('kpi-total').textContent = rs.total_with_algorithmic_estimation;
  const sw = (rs.category_distribution || {}).STRUCTURAL_WINNER;
  if (sw !== undefined) document.getElementById('kpi-winners').textContent = sw;
  const cs = rs.composite_stats || {};
  if (cs.max) document.getElementById('kpi-top').textContent = cs.max;
  if (d.new_models_this_cycle) document.getElementById('kpi-new').textContent = d.new_models_this_cycle;
  if (rs.total_models_individually_rated) {
    document.getElementById('model-total-sub').textContent = rs.total_models_individually_rated + ' rated models';
  }

  // Render all sections (models first — central output)
  renderModels(d.rating_system);
  renderForces(d.force_velocities);
  renderSectors(d.sector_transformations);
  renderMap(d.geographic_profiles);
  renderFindings(d.key_findings);
  renderFriction(d.fear_friction_index);
  renderMarkets(d.fear_driven_markets);
  renderTrajectory(d.sentiment_trajectory);
  renderPerez(d.perez_cycle);
  renderDisplacement(d.worker_displacement);
  renderDefense(d.defense_ai);
  renderInventory(d.model_inventory);
  renderCycles(d.cycle_history);
}

refresh();
setInterval(refresh, 15000);
</script>
</body>
</html>
